<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 72px;
}
.code-line {
  margin: 0;
  height: 1em;
  counter-increment: line;

  position: absolute;
  padding: 0 0.3em 0.3em 0.3em;
  display: inherit;
  width: 100%;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

.code-text-container {
  position: relative;
  height: 1em;
  padding: 0.3em 0;
}

.cover-indicator {
  display: flex;
  width: 100%;
  position: absolute;
  justify-content: end;
  height: 1em;
  align-items: center;
  padding: 0 0.3em 0.3em 0.3em;
}

.cover-indicator.check-cover::after {
  content: "\2713";
  font-weight: bold;
  background-color: var(--green);
  height: 1em;
}

.cover-indicator.no-cover::after {
  content: "\2716";
  font-weight: bold;
  background-color: var(--red);
  height: 1em;
}

.stat-line-hit {
  max-width: 48px;
  overflow: hidden;
  font-weight: bold;
  margin-right: 4px;
  background-color: var(--green);
  position: relative;
  top: 0.1em;
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","database.rs"],"content":"use sea_orm::{ConnectOptions, Database, DatabaseConnection, DbErr};\nuse std::env;\nuse std::time::Duration;\n\npub async fn get_database() -\u003e Result\u003cDatabaseConnection, DbErr\u003e {\n    let database_url = env::var(\"DATABASE_URL\").expect(\"DATABASE_URL must be set\");\n\n    let max_connections: u32 = env::var(\"DB_MAX_CONNECTIONS\")\n        .ok()\n        .and_then(|s| s.parse().ok())\n        .unwrap_or(10);\n\n    let min_connections: u32 = env::var(\"DB_MIN_CONNECTIONS\")\n        .ok()\n        .and_then(|s| s.parse().ok())\n        .unwrap_or(2);\n\n    let mut opt = ConnectOptions::new(database_url);\n    opt.max_connections(max_connections)\n        .min_connections(min_connections)\n        .connect_timeout(Duration::from_secs(5))\n        .idle_timeout(Duration::from_secs(300))\n        .sqlx_logging(true);\n\n    Database::connect(opt).await\n}\n","traces":[{"line":5,"address":[],"length":0,"stats":{"Line":0}},{"line":6,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":12},{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","email.rs"],"content":"use std::env;\n\n#[derive(Clone)]\npub struct EmailConfig {\n    pub smtp_host: String,\n    pub smtp_port: u16,\n    pub smtp_username: String,\n    pub smtp_password: String,\n    pub from_address: String,\n    pub frontend_url: String,\n}\n\nimpl EmailConfig {\n    /// Read email config from environment variables.\n    /// Returns None if SMTP is not configured (graceful degradation).\n    pub fn from_env() -\u003e Option\u003cSelf\u003e {\n        let smtp_host = env::var(\"SMTP_HOST\").ok()?;\n        let smtp_port = env::var(\"SMTP_PORT\")\n            .ok()\n            .and_then(|s| s.parse().ok())\n            .unwrap_or(587);\n        let smtp_username = env::var(\"SMTP_USERNAME\").ok()?;\n        let smtp_password = env::var(\"SMTP_PASSWORD\").ok()?;\n        let from_address = env::var(\"SMTP_FROM\")\n            .unwrap_or_else(|_| format!(\"Forum \u003c{}\u003e\", smtp_username.clone()));\n        let frontend_url =\n            env::var(\"FRONTEND_URL\").unwrap_or_else(|_| \"http://localhost:3000\".to_string());\n\n        Some(Self {\n            smtp_host,\n            smtp_port,\n            smtp_username,\n            smtp_password,\n            from_address,\n            frontend_url,\n        })\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":17},{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","jwt.rs"],"content":"use anyhow::Result;\nuse std::env;\n\n#[derive(Debug, Clone)]\npub struct JwtConfig {\n    pub secret: String,\n    pub access_token_expiry: u64,   // 15 minutes\n    pub refresh_token_expiry: u64,   // 7 days\n}\n\nimpl JwtConfig {\n    pub fn from_env() -\u003e Result\u003cSelf\u003e {\n        let secret = env::var(\"JWT_SECRET\")\n            .map_err(|_| anyhow::anyhow!(\"JWT_SECRET environment variable must be set\"))?;\n\n        if secret.len() \u003c 32 {\n            return Err(anyhow::anyhow!(\n                \"JWT_SECRET must be at least 32 characters\"\n            ));\n        }\n\n        let access_token_expiry = env::var(\"JWT_ACCESS_EXPIRATION\")\n            .ok()\n            .and_then(|s| s.parse().ok())\n            .unwrap_or(900); // 15 minutes\n\n        let refresh_token_expiry = env::var(\"JWT_REFRESH_EXPIRATION\")\n            .ok()\n            .and_then(|s| s.parse().ok())\n            .unwrap_or(604800); // 7 days\n\n        Ok(Self {\n            secret,\n            access_token_expiry,\n            refresh_token_expiry,\n        })\n    }\n}","traces":[{"line":12,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":13,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":14,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":16,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":24,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":27,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":29,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":32,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":33,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":34,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":35,"address":[],"length":0,"stats":{"Line":72057594037927936}}],"covered":12,"coverable":14},{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","mod.rs"],"content":"pub mod database;\npub mod email;\npub mod jwt;\npub mod redis;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","redis.rs"],"content":"use redis::aio::ConnectionManager;\n\npub async fn get_redis() -\u003e anyhow::Result\u003cConnectionManager\u003e {\n    let redis_url =\n        std::env::var(\"REDIS_URL\").unwrap_or_else(|_| \"redis://localhost:6379\".to_string());\n    let client = redis::Client::open(redis_url)?;\n    let manager = ConnectionManager::new(client).await?;\n    Ok(manager)\n}\n","traces":[{"line":3,"address":[],"length":0,"stats":{"Line":0}},{"line":4,"address":[],"length":0,"stats":{"Line":0}},{"line":5,"address":[],"length":0,"stats":{"Line":0}},{"line":6,"address":[],"length":0,"stats":{"Line":0}},{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":6},{"path":["C:","\\","Users","yimo","Codes","xjy","src","error.rs"],"content":"use axum::{\n    http::StatusCode,\n    response::{IntoResponse, Json, Response},\n};\nuse serde_json::json;\nuse thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum AppError {\n    #[error(\"Database error: {0}\")]\n    Database(#[from] sea_orm::DbErr),\n\n    #[error(\"Authentication failed\")]\n    Unauthorized,\n\n    #[error(\"JWT error: {0}\")]\n    Jwt(#[from] jsonwebtoken::errors::Error),\n\n    #[error(\"Not found\")]\n    NotFound,\n\n    #[error(\"Forbidden\")]\n    Forbidden,\n\n    #[error(\"Validation error: {0}\")]\n    Validation(String),\n\n    #[error(\"Conflict: {0}\")]\n    Conflict(String),\n\n    #[error(\"Internal server error: {0}\")]\n    Internal(#[from] anyhow::Error),\n\n    #[error(\"Payload too large\")]\n    PayloadTooLarge,\n}\n\n#[derive(serde::Serialize, utoipa::ToSchema)]\npub struct ErrorResponse {\n    pub error: String,\n}\n\nimpl utoipa::ToSchema for AppError {\n    fn name() -\u003e std::borrow::Cow\u003c'static, str\u003e {\n        \"ErrorResponse\".into()\n    }\n}\n\nimpl utoipa::PartialSchema for AppError {\n    fn schema() -\u003e utoipa::openapi::RefOr\u003cutoipa::openapi::schema::Schema\u003e {\n        ErrorResponse::schema()\n    }\n}\n\nimpl IntoResponse for AppError {\n    fn into_response(self) -\u003e Response {\n        let (status, error_message) = match self {\n            AppError::Database(e) =\u003e {\n                tracing::error!(\"Database error: {:?}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Database error\".to_string(),\n                )\n            }\n            AppError::Unauthorized =\u003e (StatusCode::UNAUTHORIZED, \"Unauthorized\".to_string()),\n            AppError::Jwt(e) =\u003e {\n                tracing::error!(\"JWT error: {:?}\", e);\n                (StatusCode::UNAUTHORIZED, \"Invalid token\".to_string())\n            }\n            AppError::NotFound =\u003e (StatusCode::NOT_FOUND, \"Resource not found\".to_string()),\n            AppError::Forbidden =\u003e (StatusCode::FORBIDDEN, \"Forbidden\".to_string()),\n            AppError::Validation(msg) =\u003e (StatusCode::BAD_REQUEST, msg),\n            AppError::Conflict(msg) =\u003e (StatusCode::CONFLICT, msg),\n            AppError::Internal(e) =\u003e {\n                tracing::error!(\"Internal error: {:?}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Internal server error\".to_string(),\n                )\n            }\n            AppError::PayloadTooLarge =\u003e (\n                StatusCode::PAYLOAD_TOO_LARGE,\n                \"File too large\".to_string(),\n            ),\n        };\n\n        let body = json!({\n            \"error\": error_message,\n        });\n\n        (status, Json(body)).into_response()\n    }\n}\n\npub type AppResult\u003cT\u003e = Result\u003cT, AppError\u003e;\n","traces":[{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":28},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","admin.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::{require_admin, AuthUser};\nuse crate::models::UserModel;\nuse crate::response::{ApiResponse, PaginatedResponse, PaginationQuery};\nuse crate::services::admin::AdminService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateRoleRequest {\n    #[validate(length(min = 1, max = 20))]\n    pub role: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct StatsResponse {\n    pub total_users: u64,\n    pub total_posts: u64,\n    pub total_comments: u64,\n    pub total_forums: u64,\n    pub users_today: u64,\n    pub posts_today: u64,\n}\n\n#[derive(Debug, Serialize)]\npub struct AdminUserResponse {\n    pub id: i32,\n    pub username: String,\n    pub email: String,\n    pub avatar_url: Option\u003cString\u003e,\n    pub bio: Option\u003cString\u003e,\n    pub karma: i32,\n    pub role: String,\n    pub created_at: String,\n}\n\nimpl From\u003cUserModel\u003e for AdminUserResponse {\n    fn from(u: UserModel) -\u003e Self {\n        Self {\n            id: u.id,\n            username: u.username,\n            email: u.email,\n            avatar_url: u.avatar_url,\n            bio: u.bio,\n            karma: u.karma,\n            role: u.role,\n            created_at: u.created_at.to_string(),\n        }\n    }\n}\n\npub async fn get_stats(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = AdminService::new(db);\n    let stats = service.get_stats().await?;\n\n    Ok(ApiResponse::ok(StatsResponse {\n        total_users: stats.total_users,\n        total_posts: stats.total_posts,\n        total_comments: stats.total_comments,\n        total_forums: stats.total_forums,\n        users_today: stats.users_today,\n        posts_today: stats.posts_today,\n    }))\n}\n\npub async fn list_users(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = AdminService::new(db);\n    let (users, total) = service.list_users(page, per_page).await?;\n    let items = users.into_iter().map(AdminUserResponse::from).collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn update_user_role(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cUpdateRoleRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = AdminService::new(db);\n    let user = service.update_user_role(id, \u0026payload.role).await?;\n\n    Ok(ApiResponse::ok(AdminUserResponse::from(user)))\n}\n\npub async fn admin_delete_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = AdminService::new(db);\n    service.admin_delete_post(id).await?;\n\n    Ok(ApiResponse::ok(\"Post deleted by admin\"))\n}\n\npub async fn admin_delete_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = AdminService::new(db);\n    service.admin_delete_comment(id).await?;\n\n    Ok(ApiResponse::ok(\"Comment deleted by admin\"))\n}\n","traces":[{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":46},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","auth.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::models::UserModel;\nuse crate::response::ApiResponse;\nuse crate::services::auth::AuthService;\nuse crate::services::email::EmailService;\nuse axum::{response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\nuse utoipa::ToSchema;\n\n#[derive(Debug, Deserialize, Validate, ToSchema)]\npub struct RegisterRequest {\n    #[validate(length(min = 3, max = 50))]\n    pub username: String,\n    #[validate(email)]\n    pub email: String,\n    #[validate(length(min = 8))]\n    pub password: String,\n}\n\n#[derive(Debug, Deserialize, ToSchema)]\npub struct LoginRequest {\n    pub username: String,\n    pub password: String,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct AuthResponse {\n    pub token: String,\n    pub refresh_token: String,\n    pub user_id: i32,\n    pub username: String,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct RegisterResponse {\n    pub token: String,\n    pub refresh_token: String,\n    pub user_id: i32,\n    pub username: String,\n    pub message: String,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct UserResponse {\n    pub id: i32,\n    pub username: String,\n    pub email: String,\n    pub avatar_url: Option\u003cString\u003e,\n    pub bio: Option\u003cString\u003e,\n    pub karma: i32,\n    pub role: String,\n}\n\nimpl From\u003cUserModel\u003e for UserResponse {\n    fn from(user: UserModel) -\u003e Self {\n        Self {\n            id: user.id,\n            username: user.username,\n            email: user.email,\n            avatar_url: user.avatar_url,\n            bio: user.bio,\n            karma: user.karma,\n            role: user.role,\n        }\n    }\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/register\",\n    request_body = RegisterRequest,\n    responses(\n        (status = 200, description = \"User registered successfully\", body = RegisterResponse),\n        (status = 400, description = \"Validation error\", body = AppError),\n        (status = 409, description = \"Username or email already exists\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn register(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(email_service): Extension\u003cEmailService\u003e,\n    Json(payload): Json\u003cRegisterRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    // Validate input\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(format!(\"Validation error: {e}\")))?;\n\n    let service = AuthService::new(db);\n    let (user, access_token, refresh_token) = service\n        .register(\u0026payload.username, \u0026payload.email, \u0026payload.password, \u0026email_service)\n        .await?;\n\n    let response = RegisterResponse {\n        token: access_token,\n        refresh_token,\n        user_id: user.id,\n        username: user.username,\n        message: \"Registration successful. Please check your email to verify your account.\".to_string(),\n    };\n\n    Ok(ApiResponse::ok(response))\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/login\",\n    request_body = LoginRequest,\n    responses(\n        (status = 200, description = \"Login successful\", body = AuthResponse),\n        (status = 400, description = \"Invalid credentials\", body = AppError),\n        (status = 401, description = \"Account not verified\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn login(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Json(payload): Json\u003cLoginRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = AuthService::new(db);\n    let (user, access_token, refresh_token) = service.login(\u0026payload.username, \u0026payload.password).await?;\n\n    let response = AuthResponse {\n        token: access_token,\n        refresh_token,\n        user_id: user.id,\n        username: user.username,\n    };\n\n    Ok(ApiResponse::ok(response))\n}\n\n#[utoipa::path(\n    get,\n    path = \"/api/v1/auth/me\",\n    security((\"jwt_token\" = [])),\n    responses(\n        (status = 200, description = \"Current user retrieved successfully\", body = UserResponse),\n        (status = 401, description = \"Unauthorized\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn get_current_user(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = AuthService::new(db);\n    let user = service.get_user_by_id(user_id).await?;\n\n    Ok(ApiResponse::ok(UserResponse::from(user)))\n}\n\n#[derive(Debug, Deserialize, Validate, ToSchema)]\npub struct ChangePasswordRequest {\n    pub current_password: String,\n    #[validate(length(min = 8))]\n    pub new_password: String,\n}\n\n#[utoipa::path(\n    put,\n    path = \"/api/v1/auth/password\",\n    security((\"jwt_token\" = [])),\n    request_body = ChangePasswordRequest,\n    responses(\n        (status = 200, description = \"Password changed successfully\", body = String),\n        (status = 400, description = \"Validation error\", body = AppError),\n        (status = 401, description = \"Unauthorized\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn change_password(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cChangePasswordRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = AuthService::new(db);\n    service\n        .change_password(user_id, \u0026payload.current_password, \u0026payload.new_password)\n        .await?;\n\n    Ok(ApiResponse::ok(\"Password changed successfully\"))\n}\n\n#[derive(Debug, Deserialize, ToSchema)]\npub struct VerifyEmailRequest {\n    pub token: String,\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/verify-email\",\n    request_body = VerifyEmailRequest,\n    responses(\n        (status = 200, description = \"Email verified successfully\", body = String),\n        (status = 400, description = \"Invalid token\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn verify_email(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Json(payload): Json\u003cVerifyEmailRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = AuthService::new(db);\n    service.verify_email(\u0026payload.token).await?;\n    Ok(ApiResponse::ok(\"Email verified successfully\"))\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/resend-verification\",\n    security((\"jwt_token\" = [])),\n    responses(\n        (status = 200, description = \"Verification email sent\", body = serde_json::Value),\n        (status = 401, description = \"Unauthorized\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn resend_verification(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(email_service): Extension\u003cEmailService\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = AuthService::new(db);\n    service.resend_verification(user_id, \u0026email_service).await?;\n    Ok(ApiResponse::ok(\n        serde_json::json!({ \"message\": \"Verification email sent\" }),\n    ))\n}\n\n#[derive(Debug, Deserialize, Validate, ToSchema)]\npub struct ForgotPasswordRequest {\n    #[validate(email)]\n    pub email: String,\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/forgot-password\",\n    request_body = ForgotPasswordRequest,\n    responses(\n        (status = 200, description = \"Password reset email sent if account exists\", body = serde_json::Value),\n        (status = 400, description = \"Validation error\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn forgot_password(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(email_service): Extension\u003cEmailService\u003e,\n    Json(payload): Json\u003cForgotPasswordRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let service = AuthService::new(db);\n    service\n        .forgot_password(\u0026payload.email, \u0026email_service)\n        .await?;\n\n    // Always return success to prevent email enumeration\n    Ok(ApiResponse::ok(\n        serde_json::json!({ \"message\": \"If an account with that email exists, a password reset link has been sent.\" }),\n    ))\n}\n\n#[derive(Debug, Deserialize, Validate, ToSchema)]\npub struct ResetPasswordRequest {\n    pub token: String,\n    #[validate(length(min = 8))]\n    pub new_password: String,\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/reset-password\",\n    request_body = ResetPasswordRequest,\n    responses(\n        (status = 200, description = \"Password reset successfully\", body = serde_json::Value),\n        (status = 400, description = \"Validation error\", body = AppError),\n        (status = 400, description = \"Invalid token\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn reset_password(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Json(payload): Json\u003cResetPasswordRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let service = AuthService::new(db);\n    service\n        .reset_password(\u0026payload.token, \u0026payload.new_password)\n        .await?;\n\n    Ok(ApiResponse::ok(\n        serde_json::json!({ \"message\": \"Password has been reset successfully\" }),\n    ))\n}\n\n#[derive(Debug, Deserialize, ToSchema)]\npub struct RefreshTokenRequest {\n    pub refresh_token: String,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct TokenResponse {\n    pub token: String,\n    pub refresh_token: String,\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/refresh\",\n    request_body = RefreshTokenRequest,\n    responses(\n        (status = 200, description = \"New access token generated\", body = TokenResponse),\n        (status = 401, description = \"Invalid or expired refresh token\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn refresh_token(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Json(payload): Json\u003cRefreshTokenRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    // Decode the refresh token\n    let claims = crate::utils::jwt::decode_jwt(\u0026payload.refresh_token)?;\n\n    // Verify it's a refresh token\n    if !crate::utils::jwt::is_refresh_token(\u0026claims) {\n        return Err(AppError::Unauthorized);\n    }\n\n    // Get user ID from claims\n    let user_id_str = claims.sub;\n    let user_id: i32 = user_id_str.parse().map_err(|_| AppError::Unauthorized)?;\n\n    // Verify user exists\n    let service = AuthService::new(db);\n    let _user = service.get_user_by_id(user_id).await?;\n\n    // Generate new tokens\n    let new_access_token = crate::utils::jwt::encode_access_token(\u0026user_id_str)?;\n    let new_refresh_token = crate::utils::jwt::encode_refresh_token(\u0026user_id_str)?;\n\n    let response = TokenResponse {\n        token: new_access_token,\n        refresh_token: new_refresh_token,\n    };\n\n    Ok(ApiResponse::ok(response))\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/logout\",\n    security((\"jwt_token\" = [])),\n    responses(\n        (status = 200, description = \"Logout successful\", body = String),\n    ),\n    tag = \"auth\"\n)]\npub async fn logout() -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    Ok(ApiResponse::ok(\"Logout successful\"))\n}\n","traces":[{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":80},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","bookmark.rs"],"content":"use crate::error::AppResult;\nuse crate::handlers::post::PostResponse;\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::response::{ApiResponse, PaginatedResponse, PaginationQuery};\nuse crate::services::bookmark::BookmarkService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension};\nuse sea_orm::DatabaseConnection;\nuse serde::Serialize;\n\n#[derive(Debug, Serialize)]\npub struct BookmarkToggleResponse {\n    pub bookmarked: bool,\n}\n\npub async fn toggle_bookmark(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(post_id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n    let service = BookmarkService::new(db);\n    let bookmarked = service.toggle(user_id, post_id).await?;\n    Ok(ApiResponse::ok(BookmarkToggleResponse { bookmarked }))\n}\n\npub async fn list_bookmarks(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = BookmarkService::new(db);\n    let (posts, total) = service.list_user_bookmarks(user_id, page, per_page).await?;\n    let items = posts.into_iter().map(PostResponse::from).collect();\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":14},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","comment.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::models::CommentModel;\nuse crate::response::ApiResponse;\nuse crate::services::comment::CommentService;\nuse crate::services::notification::NotificationService;\nuse crate::services::post::PostService;\nuse crate::websocket::hub::NotificationHub;\nuse axum::{extract::Path, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreateCommentRequest {\n    pub post_id: i32,\n    pub parent_id: Option\u003ci32\u003e,\n    #[validate(length(min = 1))]\n    pub content: String,\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateCommentRequest {\n    #[validate(length(min = 1))]\n    pub content: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct CommentResponse {\n    pub id: i32,\n    pub post_id: i32,\n    pub user_id: i32,\n    pub parent_id: Option\u003ci32\u003e,\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub created_at: String,\n    pub updated_at: String,\n}\n\nimpl From\u003cCommentModel\u003e for CommentResponse {\n    fn from(c: CommentModel) -\u003e Self {\n        Self {\n            id: c.id,\n            post_id: c.post_id,\n            user_id: c.user_id,\n            parent_id: c.parent_id,\n            content: c.content,\n            upvotes: c.upvotes,\n            downvotes: c.downvotes,\n            created_at: c.created_at.to_string(),\n            updated_at: c.updated_at.to_string(),\n        }\n    }\n}\n\n#[derive(Debug, Serialize, Clone)]\npub struct CommentTreeNode {\n    pub id: i32,\n    pub post_id: i32,\n    pub user_id: i32,\n    pub parent_id: Option\u003ci32\u003e,\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub created_at: String,\n    pub updated_at: String,\n    pub children: Vec\u003cCommentTreeNode\u003e,\n}\n\nimpl From\u003cCommentModel\u003e for CommentTreeNode {\n    fn from(c: CommentModel) -\u003e Self {\n        Self {\n            id: c.id,\n            post_id: c.post_id,\n            user_id: c.user_id,\n            parent_id: c.parent_id,\n            content: c.content,\n            upvotes: c.upvotes,\n            downvotes: c.downvotes,\n            created_at: c.created_at.to_string(),\n            updated_at: c.updated_at.to_string(),\n            children: Vec::new(),\n        }\n    }\n}\n\nfn build_comment_tree(comments: Vec\u003cCommentModel\u003e) -\u003e Vec\u003cCommentTreeNode\u003e {\n    let mut nodes: HashMap\u003ci32, CommentTreeNode\u003e = HashMap::new();\n    let mut children_map: HashMap\u003cOption\u003ci32\u003e, Vec\u003ci32\u003e\u003e = HashMap::new();\n\n    for comment in \u0026comments {\n        children_map\n            .entry(comment.parent_id)\n            .or_default()\n            .push(comment.id);\n    }\n    for comment in comments {\n        let id = comment.id;\n        nodes.insert(id, CommentTreeNode::from(comment));\n    }\n\n    fn attach_children(\n        node_id: i32,\n        nodes: \u0026mut HashMap\u003ci32, CommentTreeNode\u003e,\n        children_map: \u0026HashMap\u003cOption\u003ci32\u003e, Vec\u003ci32\u003e\u003e,\n    ) -\u003e Option\u003cCommentTreeNode\u003e {\n        let mut node = nodes.remove(\u0026node_id)?;\n        if let Some(child_ids) = children_map.get(\u0026Some(node_id)) {\n            for \u0026child_id in child_ids {\n                if nodes.contains_key(\u0026child_id) {\n                    if let Some(child) = attach_children(child_id, nodes, children_map) {\n                        node.children.push(child);\n                    }\n                }\n            }\n        }\n        Some(node)\n    }\n\n    let root_ids = children_map.get(\u0026None).cloned().unwrap_or_default();\n    root_ids\n        .into_iter()\n        .filter_map(|id| attach_children(id, \u0026mut nodes, \u0026children_map))\n        .collect()\n}\n\npub async fn list_comments(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(post_id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = CommentService::new(db);\n    let comments = service.list_by_post(post_id).await?;\n    let tree = build_comment_tree(comments);\n    Ok(ApiResponse::ok(tree))\n}\n\npub async fn create_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreateCommentRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let comment_service = CommentService::new(db.clone());\n    let comment = comment_service\n        .create(\n            payload.post_id,\n            user_id,\n            payload.parent_id,\n            \u0026payload.content,\n        )\n        .await?;\n\n    // Fire notifications (best-effort, don't fail the request)\n    let notif_service = NotificationService::new(db.clone(), hub);\n    let post_service = PostService::new(db);\n\n    // Notify post author\n    if let Ok(post) = post_service.get_by_id(payload.post_id).await {\n        let _ = notif_service\n            .notify(\n                post.user_id,\n                user_id,\n                \"comment_on_post\",\n                \"post\",\n                post.id,\n                \"Someone commented on your post\",\n            )\n            .await;\n    }\n\n    // Notify parent comment author (if replying)\n    if let Some(parent_id) = payload.parent_id {\n        if let Ok(parent) = comment_service.get_by_id(parent_id).await {\n            let _ = notif_service\n                .notify(\n                    parent.user_id,\n                    user_id,\n                    \"reply_to_comment\",\n                    \"comment\",\n                    parent.id,\n                    \"Someone replied to your comment\",\n                )\n                .await;\n        }\n    }\n\n    Ok(ApiResponse::ok(CommentResponse::from(comment)))\n}\n\npub async fn update_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cUpdateCommentRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = CommentService::new(db);\n    let comment = service.update(id, user_id, \u0026payload.content).await?;\n\n    Ok(ApiResponse::ok(CommentResponse::from(comment)))\n}\n\npub async fn delete_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = CommentService::new(db);\n    service.delete(id, user_id).await?;\n\n    Ok(ApiResponse::ok(\"Comment deleted\"))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::NaiveDateTime;\n\n    fn make_comment(id: i32, post_id: i32, parent_id: Option\u003ci32\u003e) -\u003e CommentModel {\n        let now = NaiveDateTime::default();\n        CommentModel {\n            id,\n            post_id,\n            user_id: 1,\n            parent_id,\n            content: format!(\"Comment {}\", id),\n            upvotes: 0,\n            downvotes: 0,\n            is_hidden: false,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n\n    #[test]\n    fn flat_comments_become_roots() {\n        let comments = vec![\n            make_comment(1, 1, None),\n            make_comment(2, 1, None),\n            make_comment(3, 1, None),\n        ];\n        let tree = build_comment_tree(comments);\n        assert_eq!(tree.len(), 3);\n        assert!(tree.iter().all(|n| n.children.is_empty()));\n    }\n\n    #[test]\n    fn nested_comments_build_tree() {\n        let comments = vec![\n            make_comment(1, 1, None),\n            make_comment(2, 1, Some(1)),\n            make_comment(3, 1, Some(2)),\n        ];\n        let tree = build_comment_tree(comments);\n        assert_eq!(tree.len(), 1);\n        assert_eq!(tree[0].id, 1);\n        assert_eq!(tree[0].children.len(), 1);\n        assert_eq!(tree[0].children[0].id, 2);\n        assert_eq!(tree[0].children[0].children.len(), 1);\n        assert_eq!(tree[0].children[0].children[0].id, 3);\n    }\n\n    #[test]\n    fn orphan_comments_are_skipped() {\n        let comments = vec![\n            make_comment(1, 1, None),\n            make_comment(2, 1, Some(999)), // parent doesn't exist\n        ];\n        let tree = build_comment_tree(comments);\n        // Root should be id=1, orphan id=2 is never attached since parent_id 999 isn't a root\n        assert_eq!(tree.len(), 1);\n        assert_eq!(tree[0].id, 1);\n    }\n\n    #[test]\n    fn empty_input_gives_empty_tree() {\n        let tree = build_comment_tree(vec![]);\n        assert!(tree.is_empty());\n    }\n\n    #[test]\n    fn multiple_roots_with_children() {\n        let comments = vec![\n            make_comment(1, 1, None),\n            make_comment(2, 1, None),\n            make_comment(3, 1, Some(1)),\n            make_comment(4, 1, Some(2)),\n        ];\n        let tree = build_comment_tree(comments);\n        assert_eq!(tree.len(), 2);\n        assert_eq!(tree[0].children.len(), 1);\n        assert_eq!(tree[1].children.len(), 1);\n    }\n}\n","traces":[{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":76,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":77,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":78,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":79,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":80,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":81,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":82,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":83,"address":[],"length":0,"stats":{"Line":2594073385365405696}},{"line":84,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":85,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":90,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":91,"address":[],"length":0,"stats":{"Line":1080863910568919040}},{"line":92,"address":[],"length":0,"stats":{"Line":1080863910568919040}},{"line":94,"address":[],"length":0,"stats":{"Line":2089670227099910144}},{"line":95,"address":[],"length":0,"stats":{"Line":2594073385365405696}},{"line":96,"address":[],"length":0,"stats":{"Line":2594073385365405696}},{"line":98,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":100,"address":[],"length":0,"stats":{"Line":2089670227099910144}},{"line":101,"address":[],"length":0,"stats":{"Line":2594073385365405696}},{"line":102,"address":[],"length":0,"stats":{"Line":3458764513820540928}},{"line":105,"address":[],"length":0,"stats":{"Line":792633534417207296}},{"line":110,"address":[],"length":0,"stats":{"Line":3170534137668829184}},{"line":111,"address":[],"length":0,"stats":{"Line":1873497444986126336}},{"line":112,"address":[],"length":0,"stats":{"Line":576460752303423488}},{"line":113,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":114,"address":[],"length":0,"stats":{"Line":1441151880758558720}},{"line":115,"address":[],"length":0,"stats":{"Line":576460752303423488}},{"line":120,"address":[],"length":0,"stats":{"Line":792633534417207296}},{"line":123,"address":[],"length":0,"stats":{"Line":2161727821137838080}},{"line":124,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":126,"address":[],"length":0,"stats":{"Line":2377900603251621888}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}}],"covered":32,"coverable":86},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","follow.rs"],"content":"use crate::error::AppResult;\nuse crate::handlers::user::UserProfileResponse;\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::response::{ApiResponse, PaginatedResponse, PaginationQuery};\nuse crate::services::follow::FollowService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension};\nuse sea_orm::DatabaseConnection;\nuse serde::Serialize;\n\n#[derive(Debug, Serialize)]\npub struct FollowToggleResponse {\n    pub following: bool,\n}\n\npub async fn toggle_follow(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(user_id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let follower_id = parse_user_id(\u0026auth_user)?;\n    let service = FollowService::new(db);\n    let following = service.toggle(follower_id, user_id).await?;\n    Ok(ApiResponse::ok(FollowToggleResponse { following }))\n}\n\npub async fn list_followers(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(user_id): Path\u003ci32\u003e,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = FollowService::new(db);\n    let (users, total) = service.list_followers(user_id, page, per_page).await?;\n    let items = users.into_iter().map(UserProfileResponse::from).collect();\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn list_following(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(user_id): Path\u003ci32\u003e,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = FollowService::new(db);\n    let (users, total) = service.list_following(user_id, page, per_page).await?;\n    let items = users.into_iter().map(UserProfileResponse::from).collect();\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":21},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","forum.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::{require_admin, AuthUser};\nuse crate::models::ForumModel;\nuse crate::response::ApiResponse;\nuse crate::services::cache::CacheService;\nuse crate::services::forum::ForumService;\nuse axum::{extract::Path, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreateForumRequest {\n    #[validate(length(min = 1, max = 100))]\n    pub name: String,\n    #[validate(length(max = 500))]\n    pub description: String,\n    #[validate(length(min = 1, max = 100))]\n    pub slug: String,\n    pub sort_order: Option\u003ci32\u003e,\n    pub icon_url: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateForumRequest {\n    #[validate(length(min = 1, max = 100))]\n    pub name: String,\n    #[validate(length(max = 500))]\n    pub description: String,\n    pub sort_order: Option\u003ci32\u003e,\n    pub icon_url: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct ForumResponse {\n    pub id: i32,\n    pub name: String,\n    pub description: String,\n    pub slug: String,\n    pub sort_order: i32,\n    pub icon_url: Option\u003cString\u003e,\n    pub created_at: String,\n    pub updated_at: String,\n}\n\nimpl From\u003cForumModel\u003e for ForumResponse {\n    fn from(f: ForumModel) -\u003e Self {\n        Self {\n            id: f.id,\n            name: f.name,\n            description: f.description,\n            slug: f.slug,\n            sort_order: f.sort_order,\n            icon_url: f.icon_url,\n            created_at: f.created_at.to_string(),\n            updated_at: f.updated_at.to_string(),\n        }\n    }\n}\n\nfn make_forum_service(db: DatabaseConnection, cache: Option\u003cCacheService\u003e) -\u003e ForumService {\n    let service = ForumService::new(db);\n    match cache {\n        Some(c) =\u003e service.with_cache(c),\n        None =\u003e service,\n    }\n}\n\npub async fn list_forums(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    cache: Option\u003cExtension\u003cCacheService\u003e\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = make_forum_service(db, cache.map(|c| c.0));\n    let forums = service.list().await?;\n    let response: Vec\u003cForumResponse\u003e = forums.into_iter().map(ForumResponse::from).collect();\n    Ok(ApiResponse::ok(response))\n}\n\npub async fn get_forum(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(slug): Path\u003cString\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = ForumService::new(db);\n    let forum = service.get_by_slug(\u0026slug).await?;\n    Ok(ApiResponse::ok(ForumResponse::from(forum)))\n}\n\npub async fn create_forum(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    cache: Option\u003cExtension\u003cCacheService\u003e\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreateForumRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = make_forum_service(db, cache.map(|c| c.0));\n    let forum = service\n        .create(\n            \u0026payload.name,\n            \u0026payload.description,\n            \u0026payload.slug,\n            payload.sort_order.unwrap_or(0),\n            payload.icon_url,\n        )\n        .await?;\n\n    Ok(ApiResponse::ok(ForumResponse::from(forum)))\n}\n\npub async fn update_forum(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    cache: Option\u003cExtension\u003cCacheService\u003e\u003e,\n    auth_user: AuthUser,\n    Path(slug): Path\u003cString\u003e,\n    Json(payload): Json\u003cUpdateForumRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = make_forum_service(db, cache.map(|c| c.0));\n    let forum = service\n        .update(\n            \u0026slug,\n            \u0026payload.name,\n            \u0026payload.description,\n            payload.sort_order.unwrap_or(0),\n            payload.icon_url,\n        )\n        .await?;\n\n    Ok(ApiResponse::ok(ForumResponse::from(forum)))\n}\n\npub async fn delete_forum(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    cache: Option\u003cExtension\u003cCacheService\u003e\u003e,\n    auth_user: AuthUser,\n    Path(slug): Path\u003cString\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = make_forum_service(db, cache.map(|c| c.0));\n    service.delete(\u0026slug).await?;\n\n    Ok(ApiResponse::ok(\"Forum deleted\"))\n}\n","traces":[{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":54},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","mod.rs"],"content":"pub mod admin;\npub mod auth;\npub mod bookmark;\npub mod comment;\npub mod follow;\npub mod forum;\npub mod notification;\npub mod post;\npub mod report;\npub mod tag;\npub mod upload;\npub mod user;\npub mod vote;\n\npub use auth::*;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","notification.rs"],"content":"use crate::error::AppResult;\nuse crate::middleware::AuthUser;\nuse crate::models::NotificationModel;\nuse crate::response::{ApiResponse, PaginatedResponse, PaginationQuery};\nuse crate::services::notification::NotificationService;\nuse crate::websocket::hub::NotificationHub;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension};\nuse sea_orm::DatabaseConnection;\nuse serde::Serialize;\n\n#[derive(Debug, Serialize)]\npub struct NotificationResponse {\n    pub id: i32,\n    pub kind: String,\n    pub actor_id: i32,\n    pub target_type: String,\n    pub target_id: i32,\n    pub message: String,\n    pub is_read: bool,\n    pub created_at: String,\n}\n\nimpl From\u003cNotificationModel\u003e for NotificationResponse {\n    fn from(n: NotificationModel) -\u003e Self {\n        Self {\n            id: n.id,\n            kind: n.kind,\n            actor_id: n.actor_id,\n            target_type: n.target_type,\n            target_id: n.target_id,\n            message: n.message,\n            is_read: n.is_read,\n            created_at: n.created_at.to_string(),\n        }\n    }\n}\n\n#[derive(Debug, Serialize)]\npub struct UnreadCountResponse {\n    pub count: u64,\n}\n\nfn get_user_id(auth_user: \u0026AuthUser) -\u003e AppResult\u003ci32\u003e {\n    crate::middleware::auth::parse_user_id(auth_user)\n}\n\npub async fn list_notifications(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = get_user_id(\u0026auth_user)?;\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = NotificationService::new(db, hub);\n    let (notifications, total) = service.list_for_user(user_id, page, per_page).await?;\n    let items = notifications\n        .into_iter()\n        .map(NotificationResponse::from)\n        .collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn unread_count(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = get_user_id(\u0026auth_user)?;\n    let service = NotificationService::new(db, hub);\n    let count = service.unread_count(user_id).await?;\n    Ok(ApiResponse::ok(UnreadCountResponse { count }))\n}\n\npub async fn mark_read(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = get_user_id(\u0026auth_user)?;\n    let service = NotificationService::new(db, hub);\n    service.mark_read(id, user_id).await?;\n    Ok(ApiResponse::ok(\"Notification marked as read\"))\n}\n\npub async fn mark_all_read(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = get_user_id(\u0026auth_user)?;\n    let service = NotificationService::new(db, hub);\n    let count = service.mark_all_read(user_id).await?;\n    Ok(ApiResponse::ok(serde_json::json!({ \"marked_read\": count })))\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","post.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::{parse_user_id, require_admin, AuthUser};\nuse crate::models::PostModel;\nuse crate::response::{ApiResponse, PaginatedResponse};\nuse crate::services::post::PostService;\nuse crate::services::tag::TagService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreatePostRequest {\n    pub forum_id: i32,\n    #[validate(length(min = 1, max = 200))]\n    pub title: String,\n    #[validate(length(min = 1))]\n    pub content: String,\n    /// Up to 5 tags, each max 30 characters.\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdatePostRequest {\n    #[validate(length(min = 1, max = 200))]\n    pub title: String,\n    #[validate(length(min = 1))]\n    pub content: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct PostResponse {\n    pub id: i32,\n    pub user_id: i32,\n    pub forum_id: i32,\n    pub title: String,\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub view_count: i32,\n    pub is_pinned: bool,\n    pub is_locked: bool,\n    pub created_at: String,\n    pub updated_at: String,\n    pub tags: Vec\u003cString\u003e,\n}\n\nimpl From\u003cPostModel\u003e for PostResponse {\n    fn from(p: PostModel) -\u003e Self {\n        Self {\n            id: p.id,\n            user_id: p.user_id,\n            forum_id: p.forum_id,\n            title: p.title,\n            content: p.content,\n            upvotes: p.upvotes,\n            downvotes: p.downvotes,\n            view_count: p.view_count,\n            is_pinned: p.is_pinned,\n            is_locked: p.is_locked,\n            created_at: p.created_at.to_string(),\n            updated_at: p.updated_at.to_string(),\n            tags: Vec::new(),\n        }\n    }\n}\n\nimpl PostResponse {\n    pub fn with_tags(p: PostModel, tags: Vec\u003cString\u003e) -\u003e Self {\n        Self {\n            id: p.id,\n            user_id: p.user_id,\n            forum_id: p.forum_id,\n            title: p.title,\n            content: p.content,\n            upvotes: p.upvotes,\n            downvotes: p.downvotes,\n            view_count: p.view_count,\n            is_pinned: p.is_pinned,\n            is_locked: p.is_locked,\n            created_at: p.created_at.to_string(),\n            updated_at: p.updated_at.to_string(),\n            tags,\n        }\n    }\n}\n\n#[derive(Debug, Deserialize)]\npub struct PostListQuery {\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n    /// Sort order: \"new\" (default), \"top\", \"hot\"\n    pub sort: Option\u003cString\u003e,\n}\n\npub async fn list_posts(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(forum_id): Path\u003ci32\u003e,\n    Query(params): Query\u003cPostListQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n    let sort = params.sort.as_deref().unwrap_or(\"new\");\n\n    let service = PostService::new(db.clone());\n    let (posts, total) = service.list_by_forum(forum_id, page, per_page, sort).await?;\n\n    // Batch-fetch tags for all posts in the page\n    let post_ids: Vec\u003ci32\u003e = posts.iter().map(|p| p.id).collect();\n    let tag_service = TagService::new(db);\n    let tags_map = tag_service.get_tags_for_posts(\u0026post_ids).await?;\n\n    let items: Vec\u003cPostResponse\u003e = posts\n        .into_iter()\n        .map(|p| {\n            let tags = tags_map.get(\u0026p.id).cloned().unwrap_or_default();\n            PostResponse::with_tags(p, tags)\n        })\n        .collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn get_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = PostService::new(db.clone());\n    service.increment_view_count(id).await?;\n    let post = service.get_by_id(id).await?;\n\n    let tag_service = TagService::new(db);\n    let tags = tag_service.get_post_tags(id).await?;\n    let tag_names: Vec\u003cString\u003e = tags.into_iter().map(|t| t.name).collect();\n\n    Ok(ApiResponse::ok(PostResponse::with_tags(post, tag_names)))\n}\n\npub async fn create_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreatePostRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    // Validate tags\n    let tag_names = payload.tags.unwrap_or_default();\n    if tag_names.len() \u003e 5 {\n        return Err(AppError::Validation(\"Maximum 5 tags allowed\".to_string()));\n    }\n    for tag in \u0026tag_names {\n        if tag.trim().is_empty() || tag.len() \u003e 30 {\n            return Err(AppError::Validation(\n                \"Each tag must be 1-30 characters\".to_string(),\n            ));\n        }\n    }\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = PostService::new(db.clone());\n    let post = service\n        .create(user_id, payload.forum_id, \u0026payload.title, \u0026payload.content)\n        .await?;\n\n    // Assign tags\n    let mut response_tags = Vec::new();\n    if !tag_names.is_empty() {\n        let tag_service = TagService::new(db);\n        let tags = tag_service.get_or_create_tags(tag_names).await?;\n        response_tags = tags.iter().map(|t| t.name.clone()).collect();\n        let tag_ids: Vec\u003ci32\u003e = tags.into_iter().map(|t| t.id).collect();\n        tag_service.set_post_tags(post.id, tag_ids).await?;\n    }\n\n    Ok(ApiResponse::ok(PostResponse::with_tags(post, response_tags)))\n}\n\npub async fn update_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cUpdatePostRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = PostService::new(db);\n    let post = service\n        .update(id, user_id, \u0026payload.title, \u0026payload.content)\n        .await?;\n\n    Ok(ApiResponse::ok(PostResponse::from(post)))\n}\n\npub async fn delete_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = PostService::new(db);\n    service.delete(id, user_id).await?;\n\n    Ok(ApiResponse::ok(\"Post deleted\"))\n}\n\npub async fn pin_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = PostService::new(db);\n    let post = service.toggle_pin(id).await?;\n    Ok(ApiResponse::ok(PostResponse::from(post)))\n}\n\npub async fn lock_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = PostService::new(db);\n    let post = service.toggle_lock(id).await?;\n    Ok(ApiResponse::ok(PostResponse::from(post)))\n}\n\n#[derive(Debug, Deserialize)]\npub struct SearchPostsQuery {\n    pub q: String,\n    pub forum_id: Option\u003ci32\u003e,\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n    /// Sort order: \"relevance\" (default), \"new\", \"top\"\n    pub sort: Option\u003cString\u003e,\n}\n\npub async fn search_posts(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Query(params): Query\u003cSearchPostsQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let q = params.q.trim();\n    if q.is_empty() || q.len() \u003e 200 {\n        return Err(AppError::Validation(\n            \"Search query must be 1-200 characters\".to_string(),\n        ));\n    }\n\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n    let sort = params.sort.as_deref().unwrap_or(\"relevance\");\n\n    let service = PostService::new(db);\n    let (posts, total) = service.search(q, params.forum_id, page, per_page, sort).await?;\n    let items = posts.into_iter().map(PostResponse::from).collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n","traces":[{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":110},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","report.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::{parse_user_id, require_admin, AuthUser};\nuse crate::models::ReportModel;\nuse crate::response::{ApiResponse, PaginatedResponse};\nuse crate::services::report::ReportService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreateReportRequest {\n    #[validate(length(min = 1, max = 20))]\n    pub target_type: String,\n    pub target_id: i32,\n    #[validate(length(min = 1, max = 50))]\n    pub reason: String,\n    pub description: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ListReportsQuery {\n    pub status: Option\u003cString\u003e,\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct ResolveReportRequest {\n    #[validate(length(min = 1, max = 20))]\n    pub action: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct ReportResponse {\n    pub id: i32,\n    pub reporter_id: i32,\n    pub target_type: String,\n    pub target_id: i32,\n    pub reason: String,\n    pub description: Option\u003cString\u003e,\n    pub status: String,\n    pub resolved_by: Option\u003ci32\u003e,\n    pub resolved_at: Option\u003cString\u003e,\n    pub created_at: String,\n}\n\nimpl From\u003cReportModel\u003e for ReportResponse {\n    fn from(r: ReportModel) -\u003e Self {\n        Self {\n            id: r.id,\n            reporter_id: r.reporter_id,\n            target_type: r.target_type,\n            target_id: r.target_id,\n            reason: r.reason,\n            description: r.description,\n            status: r.status,\n            resolved_by: r.resolved_by,\n            resolved_at: r.resolved_at.map(|t| t.to_string()),\n            created_at: r.created_at.to_string(),\n        }\n    }\n}\n\npub async fn create_report(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreateReportRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = ReportService::new(db);\n    let report = service\n        .create_report(\n            user_id,\n            \u0026payload.target_type,\n            payload.target_id,\n            \u0026payload.reason,\n            payload.description.as_deref(),\n        )\n        .await?;\n\n    Ok(ApiResponse::ok(ReportResponse::from(report)))\n}\n\npub async fn list_reports(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Query(params): Query\u003cListReportsQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = ReportService::new(db);\n    let (reports, total) = service\n        .list_reports(params.status.as_deref(), page, per_page)\n        .await?;\n    let items = reports.into_iter().map(ReportResponse::from).collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn resolve_report(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cResolveReportRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let admin_id = require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = ReportService::new(db);\n    let report = service.resolve(id, admin_id, \u0026payload.action).await?;\n\n    Ok(ApiResponse::ok(ReportResponse::from(report)))\n}\n","traces":[{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":42},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","tag.rs"],"content":"use crate::error::AppResult;\nuse crate::handlers::post::PostResponse;\nuse crate::middleware::auth::require_admin;\nuse crate::middleware::AuthUser;\nuse crate::models::TagModel;\nuse crate::response::{ApiResponse, PaginatedResponse};\nuse crate::services::tag::TagService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Serialize)]\npub struct TagResponse {\n    pub id: i32,\n    pub name: String,\n    pub slug: String,\n}\n\nimpl From\u003cTagModel\u003e for TagResponse {\n    fn from(t: TagModel) -\u003e Self {\n        Self {\n            id: t.id,\n            name: t.name,\n            slug: t.slug,\n        }\n    }\n}\n\n#[derive(Debug, Deserialize)]\npub struct TagPostsQuery {\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n}\n\npub async fn list_tags(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = TagService::new(db);\n    let tags = service.list_tags().await?;\n    let items: Vec\u003cTagResponse\u003e = tags.into_iter().map(TagResponse::from).collect();\n    Ok(ApiResponse::ok(items))\n}\n\npub async fn get_posts_by_tag(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(slug): Path\u003cString\u003e,\n    Query(params): Query\u003cTagPostsQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = TagService::new(db);\n    let (posts, total) = service.get_posts_by_tag(\u0026slug, page, per_page).await?;\n    let items: Vec\u003cPostResponse\u003e = posts.into_iter().map(PostResponse::from).collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreateTagRequest {\n    #[validate(length(min = 1, max = 30))]\n    pub name: String,\n}\n\npub async fn create_tag(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreateTagRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload.validate().map_err(|e| crate::error::AppError::Validation(e.to_string()))?;\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = TagService::new(db);\n    let tag = service.create_tag(\u0026payload.name).await?;\n    Ok(ApiResponse::ok(TagResponse::from(tag)))\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateTagRequest {\n    #[validate(length(min = 1, max = 30))]\n    pub name: String,\n}\n\npub async fn update_tag(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cUpdateTagRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload.validate().map_err(|e| crate::error::AppError::Validation(e.to_string()))?;\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = TagService::new(db);\n    let tag = service.update_tag(id, \u0026payload.name).await?;\n    Ok(ApiResponse::ok(TagResponse::from(tag)))\n}\n\npub async fn delete_tag(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = TagService::new(db);\n    service.delete_tag(id).await?;\n    Ok(ApiResponse::ok(\"Tag deleted successfully\"))\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":34},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","upload.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::response::ApiResponse;\nuse crate::services::upload::{UploadConfig, UploadService};\nuse crate::services::user::UserService;\nuse axum::{extract::Multipart, response::IntoResponse, Extension};\nuse sea_orm::DatabaseConnection;\nuse serde::Serialize;\n\n#[derive(Debug, Serialize)]\npub struct UploadResponse {\n    pub url: String,\n}\n\n/// Upload and set user avatar.\n/// POST /upload/avatar (multipart form: field \"file\")\npub async fn upload_avatar(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(config): Extension\u003cUploadConfig\u003e,\n    auth_user: AuthUser,\n    mut multipart: Multipart,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let field = multipart\n        .next_field()\n        .await\n        .map_err(|e| AppError::Validation(format!(\"Failed to read upload: {}\", e)))?\n        .ok_or_else(|| AppError::Validation(\"No file provided\".to_string()))?;\n\n    let content_type = field\n        .content_type()\n        .unwrap_or(\"application/octet-stream\")\n        .to_string();\n\n    let data = field\n        .bytes()\n        .await\n        .map_err(|e| AppError::Validation(format!(\"Failed to read file data: {}\", e)))?;\n\n    let url = UploadService::save_file(\u0026config, \u0026data, \u0026content_type, \"avatars\").await?;\n\n    // Update user avatar_url\n    let service = UserService::new(db);\n    service.update_avatar_url(user_id, \u0026url).await?;\n\n    Ok(ApiResponse::ok(UploadResponse { url }))\n}\n\n/// Upload a general image (for posts, comments, etc.).\n/// POST /upload/image (multipart form: field \"file\")\npub async fn upload_image(\n    Extension(config): Extension\u003cUploadConfig\u003e,\n    _auth_user: AuthUser,\n    mut multipart: Multipart,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let field = multipart\n        .next_field()\n        .await\n        .map_err(|e| AppError::Validation(format!(\"Failed to read upload: {}\", e)))?\n        .ok_or_else(|| AppError::Validation(\"No file provided\".to_string()))?;\n\n    let content_type = field\n        .content_type()\n        .unwrap_or(\"application/octet-stream\")\n        .to_string();\n\n    let data = field\n        .bytes()\n        .await\n        .map_err(|e| AppError::Validation(format!(\"Failed to read file data: {}\", e)))?;\n\n    let url = UploadService::save_file(\u0026config, \u0026data, \u0026content_type, \"images\").await?;\n\n    Ok(ApiResponse::ok(UploadResponse { url }))\n}\n","traces":[{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":25},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","user.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::models::UserModel;\nuse crate::response::ApiResponse;\nuse crate::services::user::UserService;\nuse axum::{extract::Path, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Serialize)]\npub struct UserProfileResponse {\n    pub id: i32,\n    pub username: String,\n    pub avatar_url: Option\u003cString\u003e,\n    pub bio: Option\u003cString\u003e,\n    pub karma: i32,\n    pub created_at: String,\n}\n\nimpl From\u003cUserModel\u003e for UserProfileResponse {\n    fn from(u: UserModel) -\u003e Self {\n        Self {\n            id: u.id,\n            username: u.username,\n            avatar_url: u.avatar_url,\n            bio: u.bio,\n            karma: u.karma,\n            created_at: u.created_at.to_string(),\n        }\n    }\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateProfileRequest {\n    #[validate(length(max = 500))]\n    pub bio: Option\u003cString\u003e,\n    #[validate(length(max = 500))]\n    pub avatar_url: Option\u003cString\u003e,\n}\n\npub async fn get_user_profile(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(username): Path\u003cString\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = UserService::new(db);\n    let user = service.get_by_username(\u0026username).await?;\n    Ok(ApiResponse::ok(UserProfileResponse::from(user)))\n}\n\npub async fn update_profile(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cUpdateProfileRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = UserService::new(db);\n    let user = service\n        .update_profile(user_id, payload.bio, payload.avatar_url)\n        .await?;\n\n    Ok(ApiResponse::ok(UserProfileResponse::from(user)))\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","vote.rs"],"content":"use crate::error::AppResult;\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::response::ApiResponse;\nuse crate::services::comment::CommentService;\nuse crate::services::notification::NotificationService;\nuse crate::services::post::PostService;\nuse crate::services::vote::VoteService;\nuse crate::websocket::hub::NotificationHub;\nuse axum::{extract::Path, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Debug, Deserialize)]\npub struct VoteRequest {\n    pub value: i16,\n}\n\n#[derive(Debug, Serialize)]\npub struct VoteResponse {\n    pub target_type: String,\n    pub target_id: i32,\n    pub value: i16,\n}\n\npub async fn vote_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cVoteRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = VoteService::new(db.clone());\n    let vote = service.vote(user_id, \"post\", id, payload.value).await?;\n\n    // Notify post author on vote (not on toggle-off)\n    if vote.value != 0 {\n        let post_service = PostService::new(db.clone());\n        if let Ok(post) = post_service.get_by_id(id).await {\n            let notif = NotificationService::new(db, hub);\n            let _ = notif\n                .notify(\n                    post.user_id,\n                    user_id,\n                    \"vote_on_post\",\n                    \"post\",\n                    id,\n                    \"Someone voted on your post\",\n                )\n                .await;\n        }\n    }\n\n    Ok(ApiResponse::ok(VoteResponse {\n        target_type: \"post\".to_string(),\n        target_id: id,\n        value: vote.value,\n    }))\n}\n\npub async fn vote_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cVoteRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = VoteService::new(db.clone());\n    let vote = service.vote(user_id, \"comment\", id, payload.value).await?;\n\n    // Notify comment author on vote (not on toggle-off)\n    if vote.value != 0 {\n        let comment_service = CommentService::new(db.clone());\n        if let Ok(comment) = comment_service.get_by_id(id).await {\n            let notif = NotificationService::new(db, hub);\n            let _ = notif\n                .notify(\n                    comment.user_id,\n                    user_id,\n                    \"vote_on_comment\",\n                    \"comment\",\n                    id,\n                    \"Someone voted on your comment\",\n                )\n                .await;\n        }\n    }\n\n    Ok(ApiResponse::ok(VoteResponse {\n        target_type: \"comment\".to_string(),\n        target_id: id,\n        value: vote.value,\n    }))\n}\n","traces":[{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":34},{"path":["C:","\\","Users","yimo","Codes","xjy","src","lib.rs"],"content":"pub mod config;\npub mod error;\npub mod handlers;\npub mod middleware;\npub mod migration;\npub mod models;\npub mod response;\npub mod routes;\npub mod services;\npub mod utils;\npub mod websocket;\n\npub use error::{AppError, AppResult};\npub use middleware::auth::AuthUser;\npub use response::{ApiResponse, PaginatedResponse, PaginationQuery};\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","main.rs"],"content":"mod config;\nmod error;\nmod handlers;\nmod middleware;\nmod migration;\nmod models;\nmod response;\nmod routes;\nmod services;\nmod utils;\nmod websocket;\n\nuse axum::{extract::Extension, response::IntoResponse, routing::get, Json, Router};\nuse sea_orm::{ConnectionTrait, DatabaseConnection, Statement};\nuse sea_orm_migration::MigratorTrait;\nuse serde_json::json;\nuse services::cache::CacheService;\nuse services::upload::UploadConfig;\nuse std::env;\nuse std::net::SocketAddr;\nuse tower_http::cors::CorsLayer;\nuse tower_http::services::ServeDir;\nuse tower_http::trace::TraceLayer;\nuse tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};\n// use utoipa::OpenApi;\nuse websocket::hub::NotificationHub;\n\n/*\n#[derive(OpenApi)]\n#[openapi(\n    paths(\n        health_check,\n        // Auth routes\n        crate::handlers::register,\n        crate::handlers::login,\n        crate::handlers::auth::refresh_token,\n        crate::handlers::get_current_user,\n        crate::handlers::change_password,\n        crate::handlers::verify_email,\n        crate::handlers::resend_verification,\n        crate::handlers::auth::forgot_password,\n        crate::handlers::auth::reset_password,\n        // User routes\n        crate::handlers::user::get_user_profile,\n        crate::handlers::user::update_profile,\n        // Forum routes\n        crate::handlers::forum::list_forums,\n        crate::handlers::forum::get_forum,\n        crate::handlers::forum::create_forum,\n        crate::handlers::forum::update_forum,\n        crate::handlers::forum::delete_forum,\n        // Post routes\n        crate::handlers::post::list_posts,\n        crate::handlers::post::get_post,\n        crate::handlers::post::create_post,\n        crate::handlers::post::update_post,\n        crate::handlers::post::delete_post,\n        crate::handlers::post::pin_post,\n        crate::handlers::post::lock_post,\n        crate::handlers::post::search_posts,\n        // Comment routes\n        crate::handlers::comment::list_comments,\n        crate::handlers::comment::create_comment,\n        crate::handlers::comment::update_comment,\n        crate::handlers::comment::delete_comment,\n        // Tag routes\n        crate::handlers::tag::list_tags,\n        crate::handlers::tag::get_posts_by_tag,\n        // Vote routes\n        crate::handlers::vote::vote_post,\n        crate::handlers::vote::vote_comment,\n        // Follow routes\n        crate::handlers::follow::list_followers,\n        crate::handlers::follow::list_following,\n        crate::handlers::follow::toggle_follow,\n        // Notification routes\n        crate::handlers::notification::list_notifications,\n        crate::handlers::notification::unread_count,\n        crate::handlers::notification::mark_all_read,\n        crate::handlers::notification::mark_read,\n        // Bookmark routes\n        crate::handlers::bookmark::toggle_bookmark,\n        crate::handlers::bookmark::list_bookmarks,\n        // Upload routes\n        crate::handlers::upload::upload_avatar,\n        crate::handlers::upload::upload_image,\n        // Report routes\n        crate::handlers::report::create_report,\n        crate::handlers::report::list_reports,\n        crate::handlers::report::resolve_report,\n        // Admin routes\n        crate::handlers::admin::get_stats,\n        crate::handlers::admin::list_users,\n        crate::handlers::admin::update_user_role,\n        crate::handlers::admin::admin_delete_post,\n        crate::handlers::admin::admin_delete_comment,\n    ),\n    components(\n        schemas(\n            crate::response::ApiResponse,\n            crate::response::PaginatedResponse,\n            crate::handlers::auth::RegisterRequest,\n            crate::handlers::auth::LoginRequest,\n            crate::handlers::auth::RefreshTokenRequest,\n            crate::handlers::auth::AuthResponse,\n            crate::handlers::auth::RegisterResponse,\n            crate::handlers::auth::TokenResponse,\n            crate::handlers::auth::UserResponse,\n            crate::handlers::auth::ChangePasswordRequest,\n            crate::handlers::auth::VerifyEmailRequest,\n            crate::handlers::auth::ForgotPasswordRequest,\n            crate::handlers::auth::ResetPasswordRequest,\n            crate::models::UserModel,\n            crate::models::ForumModel,\n            crate::models::PostModel,\n            crate::models::CommentModel,\n            crate::models::TagModel,\n            crate::models::VoteModel,\n            crate::models::FollowModel,\n            crate::models::NotificationModel,\n            crate::models::BookmarkModel,\n            crate::models::ReportModel,\n            crate::error::AppError,\n        )\n    ),\n    tags(\n        (name = \"auth\", description = \"Authentication operations\"),\n        (name = \"users\", description = \"User profile operations\"),\n        (name = \"forums\", description = \"Forum management operations\"),\n        (name = \"posts\", description = \"Post management operations\"),\n        (name = \"comments\", description = \"Comment management operations\"),\n        (name = \"tags\", description = \"Tag management operations\"),\n        (name = \"votes\", description = \"Voting operations\"),\n        (name = \"follows\", description = \"Follow operations\"),\n        (name = \"notifications\", description = \"Notification operations\"),\n        (name = \"bookmarks\", description = \"Bookmark operations\"),\n        (name = \"uploads\", description = \"File upload operations\"),\n        (name = \"reports\", description = \"Report management operations\"),\n        (name = \"admin\", description = \"Administrative operations\"),\n    )\n)]\nstruct ApiDoc;\n*/\n\n#[tokio::main]\nasync fn main() -\u003e anyhow::Result\u003c()\u003e {\n    dotenv::dotenv().ok();\n\n    tracing_subscriber::registry()\n        .with(\n            tracing_subscriber::EnvFilter::try_from_default_env()\n                .unwrap_or_else(|_| \"xjy=debug,tower_http=debug,axum=debug\".into()),\n        )\n        .with(tracing_subscriber::fmt::layer())\n        .init();\n\n    // Validate configuration before doing anything else\n    let jwt_config = validate_config()?;\n\n    // Initialize JWT config\n    utils::jwt::init_jwt_config(jwt_config)?;\n\n    tracing::info!(\"Starting Forum API v{}...\", env!(\"CARGO_PKG_VERSION\"));\n\n    let db = config::database::get_database().await?;\n    tracing::info!(\"Database connected successfully\");\n\n    migration::Migrator::up(\u0026db, None).await?;\n    tracing::info!(\"Database migrations applied successfully\");\n\n    let hub = NotificationHub::new();\n\n    let upload_dir = env::var(\"UPLOAD_DIR\").unwrap_or_else(|_| \"./uploads\".to_string());\n    let upload_config = UploadConfig {\n        upload_dir: upload_dir.clone(),\n    };\n\n    // Redis/Cache is optional - graceful degradation if unavailable\n    let cache = match config::redis::get_redis().await {\n        Ok(conn) =\u003e {\n            tracing::info!(\"Redis connected successfully\");\n            Some(CacheService::new(conn))\n        }\n        Err(e) =\u003e {\n            tracing::warn!(\"Redis unavailable, running without cache: {}\", e);\n            None\n        }\n    };\n\n    let email_service = services::email::EmailService::from_env();\n    if email_service.is_configured() {\n        tracing::info!(\"SMTP email service configured\");\n    } else {\n        tracing::warn!(\"SMTP not configured, emails will be skipped\");\n    }\n\n    let mut app = create_app(\u0026upload_dir)\n        .layer(Extension(db))\n        .layer(Extension(hub))\n        .layer(Extension(upload_config))\n        .layer(Extension(email_service));\n\n    if let Some(cache) = cache {\n        app = app.layer(Extension(cache));\n    }\n\n    let host = env::var(\"HOST\").unwrap_or_else(|_| \"127.0.0.1\".to_string());\n    let port = env::var(\"PORT\").unwrap_or_else(|_| \"3000\".to_string());\n    let addr = format!(\"{}:{}\", host, port);\n\n    let listener = tokio::net::TcpListener::bind(\u0026addr).await?;\n    tracing::info!(\"Listening on http://{}\", addr);\n\n    axum::serve(\n        listener,\n        app.into_make_service_with_connect_info::\u003cSocketAddr\u003e(),\n    )\n    .with_graceful_shutdown(shutdown_signal())\n    .await?;\n\n    tracing::info!(\"Server shut down gracefully\");\n    Ok(())\n}\n\n/// Validate all required configuration at startup (fail-fast).\nfn validate_config() -\u003e anyhow::Result\u003ccrate::config::jwt::JwtConfig\u003e {\n    // JWT config  validated and cached\n    let jwt_config = config::jwt::JwtConfig::from_env()?;\n\n    // DATABASE_URL  checked here for early error; actual connection happens later\n    if env::var(\"DATABASE_URL\").is_err() {\n        return Err(anyhow::anyhow!(\n            \"DATABASE_URL environment variable must be set\"\n        ));\n    }\n\n    // Upload directory  create if needed\n    let upload_dir = env::var(\"UPLOAD_DIR\").unwrap_or_else(|_| \"./uploads\".to_string());\n    std::fs::create_dir_all(\u0026upload_dir).map_err(|e| {\n        anyhow::anyhow!(\"Failed to create upload directory '{}': {}\", upload_dir, e)\n    })?;\n\n    Ok(jwt_config)\n}\n\nfn build_cors_layer() -\u003e CorsLayer {\n    use axum::http::{header, HeaderValue, Method};\n\n    let origins_str = env::var(\"CORS_ORIGINS\").unwrap_or_else(|_| \"*\".to_string());\n\n    let cors = CorsLayer::new()\n        .allow_methods([\n            Method::GET,\n            Method::POST,\n            Method::PUT,\n            Method::DELETE,\n            Method::OPTIONS,\n        ])\n        .allow_headers([header::AUTHORIZATION, header::CONTENT_TYPE]);\n\n    if origins_str == \"*\" {\n        cors.allow_origin(tower_http::cors::Any)\n    } else {\n        let origins: Vec\u003cHeaderValue\u003e = origins_str\n            .split(',')\n            .filter_map(|s| s.trim().parse().ok())\n            .collect();\n        cors.allow_origin(origins)\n    }\n}\n\nfn create_app(upload_dir: \u0026str) -\u003e Router {\n    Router::new()\n        .route(\"/\", get(health_check))\n        .merge(routes::create_routes())\n        .nest_service(\"/uploads\", ServeDir::new(upload_dir))\n        .layer(TraceLayer::new_for_http())\n        .layer(build_cors_layer())\n}\n\n#[utoipa::path(\n    get,\n    path = \"/\",\n    responses(\n        (status = 200, description = \"Health check successful\", body = serde_json::Value)\n    )\n)]\nasync fn health_check(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n) -\u003e impl IntoResponse {\n    let db_ok = db\n        .query_one(Statement::from_string(\n            sea_orm::DatabaseBackend::Postgres,\n            \"SELECT 1\".to_string(),\n        ))\n        .await\n        .is_ok();\n\n    let status = if db_ok { \"ok\" } else { \"degraded\" };\n\n    Json(json!({\n        \"status\": status,\n        \"service\": \"Forum API\",\n        \"version\": env!(\"CARGO_PKG_VERSION\"),\n        \"database\": db_ok,\n    }))\n}\n\nasync fn shutdown_signal() {\n    tokio::signal::ctrl_c()\n        .await\n        .expect(\"Failed to install CTRL+C signal handler\");\n    tracing::info!(\"Shutdown signal received, gracefully shutting down...\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","middleware","auth.rs"],"content":"use crate::{error::AppError, models::User, utils::jwt::decode_jwt};\nuse axum::{extract::Request, http::HeaderMap, middleware::Next, response::Response, Extension};\nuse sea_orm::{DatabaseConnection, EntityTrait};\n\n/// Extracted user information from JWT token\n#[derive(Debug, Clone)]\npub struct AuthUser {\n    pub user_id: String,\n}\n\n/// JWT authentication middleware\n///\n/// Verifies the JWT token from the Authorization header,\n/// checks the user is not banned, and adds user info to request extensions.\npub async fn auth_middleware(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    headers: HeaderMap,\n    mut request: Request,\n    next: Next,\n) -\u003e Result\u003cResponse, AppError\u003e {\n    // Extract Authorization header\n    let auth_header = headers\n        .get(\"Authorization\")\n        .and_then(|h| h.to_str().ok())\n        .ok_or(AppError::Unauthorized)?;\n\n    // Parse Bearer token\n    if !auth_header.starts_with(\"Bearer \") {\n        return Err(AppError::Unauthorized);\n    }\n\n    let token = \u0026auth_header[7..]; // Skip \"Bearer \"\n\n    // Verify JWT\n    let claims = decode_jwt(token)?;\n\n    // Check user is not banned\n    let user_id: i32 = claims\n        .sub\n        .parse()\n        .map_err(|_| AppError::Validation(\"Invalid user ID in token\".to_string()))?;\n\n    let user = User::find_by_id(user_id)\n        .one(\u0026db)\n        .await?\n        .ok_or(AppError::Unauthorized)?;\n\n    if user.role == \"banned\" {\n        return Err(AppError::Forbidden);\n    }\n\n    // Add user info to request extensions\n    let auth_user = AuthUser {\n        user_id: claims.sub,\n    };\n    request.extensions_mut().insert(auth_user);\n\n    // Continue to next handler\n    Ok(next.run(request).await)\n}\n\n/// Parse user_id from AuthUser string to i32\npub fn parse_user_id(auth_user: \u0026AuthUser) -\u003e crate::error::AppResult\u003ci32\u003e {\n    auth_user\n        .user_id\n        .parse()\n        .map_err(|_| AppError::Validation(\"Invalid user ID\".to_string()))\n}\n\n/// Verify the current user has admin role\npub async fn require_admin(\n    db: \u0026sea_orm::DatabaseConnection,\n    auth_user: \u0026AuthUser,\n) -\u003e crate::error::AppResult\u003ci32\u003e {\n    let user_id = parse_user_id(auth_user)?;\n    let auth_service = crate::services::auth::AuthService::new(db.clone());\n    let user = auth_service.get_user_by_id(user_id).await?;\n    if user.role != \"admin\" {\n        return Err(AppError::Forbidden);\n    }\n    Ok(user_id)\n}\n\n/// Extractor for AuthUser from request extensions\nuse axum::extract::FromRequestParts;\n\nimpl\u003cS\u003e FromRequestParts\u003cS\u003e for AuthUser\nwhere\n    S: Send + Sync,\n{\n    type Rejection = AppError;\n\n    async fn from_request_parts(\n        parts: \u0026mut axum::http::request::Parts,\n        _state: \u0026S,\n    ) -\u003e Result\u003cSelf, Self::Rejection\u003e {\n        parts\n            .extensions\n            .get::\u003cAuthUser\u003e()\n            .cloned()\n            .ok_or(AppError::Unauthorized)\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":35},{"path":["C:","\\","Users","yimo","Codes","xjy","src","middleware","mod.rs"],"content":"pub mod auth;\n\npub use auth::*;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000001_create_users_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n    Username,\n    Email,\n    PasswordHash,\n    AvatarUrl,\n    Bio,\n    Karma,\n    Role,\n    CreatedAt,\n    UpdatedAt,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Users::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Users::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Users::Username)\n                            .string_len(50)\n                            .not_null()\n                            .unique_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Users::Email)\n                            .string_len(255)\n                            .not_null()\n                            .unique_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Users::PasswordHash)\n                            .string_len(255)\n                            .not_null(),\n                    )\n                    .col(ColumnDef::new(Users::AvatarUrl).string_len(500).null())\n                    .col(ColumnDef::new(Users::Bio).text().null())\n                    .col(ColumnDef::new(Users::Karma).integer().not_null().default(0))\n                    .col(\n                        ColumnDef::new(Users::Role)\n                            .string_len(20)\n                            .not_null()\n                            .default(\"user\"),\n                    )\n                    .col(\n                        ColumnDef::new(Users::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .col(\n                        ColumnDef::new(Users::UpdatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Users::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000002_create_forums_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Forums {\n    Table,\n    Id,\n    Name,\n    Description,\n    Slug,\n    SortOrder,\n    IconUrl,\n    CreatedAt,\n    UpdatedAt,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Forums::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Forums::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::Name)\n                            .string_len(100)\n                            .not_null()\n                            .unique_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::Description)\n                            .string_len(500)\n                            .not_null(),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::Slug)\n                            .string_len(100)\n                            .not_null()\n                            .unique_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::SortOrder)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(ColumnDef::new(Forums::IconUrl).string_len(500).null())\n                    .col(\n                        ColumnDef::new(Forums::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::UpdatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Forums::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000003_create_posts_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Posts {\n    Table,\n    Id,\n    UserId,\n    ForumId,\n    Title,\n    Content,\n    Upvotes,\n    Downvotes,\n    ViewCount,\n    IsPinned,\n    IsLocked,\n    CreatedAt,\n    UpdatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[derive(DeriveIden)]\nenum Forums {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Posts::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Posts::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Posts::UserId).integer().not_null())\n                    .col(ColumnDef::new(Posts::ForumId).integer().not_null())\n                    .col(ColumnDef::new(Posts::Title).string_len(200).not_null())\n                    .col(ColumnDef::new(Posts::Content).text().not_null())\n                    .col(\n                        ColumnDef::new(Posts::Upvotes)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::Downvotes)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::ViewCount)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::IsPinned)\n                            .boolean()\n                            .not_null()\n                            .default(false),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::IsLocked)\n                            .boolean()\n                            .not_null()\n                            .default(false),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::UpdatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_posts_user_id\")\n                            .from(Posts::Table, Posts::UserId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_posts_forum_id\")\n                            .from(Posts::Table, Posts::ForumId)\n                            .to(Forums::Table, Forums::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_posts_forum_id\")\n                    .table(Posts::Table)\n                    .col(Posts::ForumId)\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_posts_user_id\")\n                    .table(Posts::Table)\n                    .col(Posts::UserId)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Posts::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000004_create_comments_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Comments {\n    Table,\n    Id,\n    PostId,\n    UserId,\n    ParentId,\n    Content,\n    Upvotes,\n    Downvotes,\n    CreatedAt,\n    UpdatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Posts {\n    Table,\n    Id,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Comments::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Comments::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Comments::PostId).integer().not_null())\n                    .col(ColumnDef::new(Comments::UserId).integer().not_null())\n                    .col(ColumnDef::new(Comments::ParentId).integer().null())\n                    .col(ColumnDef::new(Comments::Content).text().not_null())\n                    .col(\n                        ColumnDef::new(Comments::Upvotes)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Comments::Downvotes)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Comments::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .col(\n                        ColumnDef::new(Comments::UpdatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_comments_post_id\")\n                            .from(Comments::Table, Comments::PostId)\n                            .to(Posts::Table, Posts::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_comments_user_id\")\n                            .from(Comments::Table, Comments::UserId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_comments_parent_id\")\n                            .from(Comments::Table, Comments::ParentId)\n                            .to(Comments::Table, Comments::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_comments_post_id\")\n                    .table(Comments::Table)\n                    .col(Comments::PostId)\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_comments_user_id\")\n                    .table(Comments::Table)\n                    .col(Comments::UserId)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Comments::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000005_create_votes_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Votes {\n    Table,\n    Id,\n    UserId,\n    TargetType,\n    TargetId,\n    Value,\n    CreatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Votes::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Votes::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Votes::UserId).integer().not_null())\n                    .col(ColumnDef::new(Votes::TargetType).string_len(20).not_null())\n                    .col(ColumnDef::new(Votes::TargetId).integer().not_null())\n                    .col(ColumnDef::new(Votes::Value).small_integer().not_null())\n                    .col(\n                        ColumnDef::new(Votes::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_votes_user_id\")\n                            .from(Votes::Table, Votes::UserId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_votes_unique\")\n                    .table(Votes::Table)\n                    .col(Votes::UserId)\n                    .col(Votes::TargetType)\n                    .col(Votes::TargetId)\n                    .unique()\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_votes_target\")\n                    .table(Votes::Table)\n                    .col(Votes::TargetType)\n                    .col(Votes::TargetId)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Votes::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000006_add_comment_parent_index.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Comments {\n    Table,\n    ParentId,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_comments_parent_id\")\n                    .table(Comments::Table)\n                    .col(Comments::ParentId)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_index(\n                Index::drop()\n                    .name(\"idx_comments_parent_id\")\n                    .table(Comments::Table)\n                    .to_owned(),\n            )\n            .await\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000007_add_search_index.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        // Add generated tsvector column for full-text search\n        db.execute_unprepared(\n            \"ALTER TABLE posts ADD COLUMN search_vector tsvector \\\n             GENERATED ALWAYS AS (\\\n                 to_tsvector('english', coalesce(title, '') || ' ' || coalesce(content, ''))\\\n             ) STORED\",\n        )\n        .await?;\n\n        // Create GIN index for fast full-text search\n        db.execute_unprepared(\"CREATE INDEX idx_posts_search ON posts USING GIN (search_vector)\")\n            .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"DROP INDEX IF EXISTS idx_posts_search\")\n            .await?;\n\n        db.execute_unprepared(\"ALTER TABLE posts DROP COLUMN IF EXISTS search_vector\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000008_create_notifications_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Notifications {\n    Table,\n    Id,\n    UserId,\n    Kind,\n    ActorId,\n    TargetType,\n    TargetId,\n    Message,\n    IsRead,\n    CreatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Notifications::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Notifications::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Notifications::UserId).integer().not_null())\n                    .col(\n                        ColumnDef::new(Notifications::Kind)\n                            .string_len(50)\n                            .not_null(),\n                    )\n                    .col(ColumnDef::new(Notifications::ActorId).integer().not_null())\n                    .col(\n                        ColumnDef::new(Notifications::TargetType)\n                            .string_len(20)\n                            .not_null(),\n                    )\n                    .col(ColumnDef::new(Notifications::TargetId).integer().not_null())\n                    .col(ColumnDef::new(Notifications::Message).text().not_null())\n                    .col(\n                        ColumnDef::new(Notifications::IsRead)\n                            .boolean()\n                            .not_null()\n                            .default(false),\n                    )\n                    .col(\n                        ColumnDef::new(Notifications::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_notifications_user_id\")\n                            .from(Notifications::Table, Notifications::UserId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_notifications_actor_id\")\n                            .from(Notifications::Table, Notifications::ActorId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_notifications_user_id\")\n                    .table(Notifications::Table)\n                    .col(Notifications::UserId)\n                    .to_owned(),\n            )\n            .await?;\n\n        // Partial index for unread notifications\n        let db = manager.get_connection();\n        db.execute_unprepared(\n            \"CREATE INDEX idx_notifications_unread ON notifications (user_id, is_read) WHERE is_read = FALSE\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Notifications::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000009_create_reports_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Reports {\n    Table,\n    Id,\n    ReporterId,\n    TargetType,\n    TargetId,\n    Reason,\n    Description,\n    Status,\n    ResolvedBy,\n    ResolvedAt,\n    CreatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Reports::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Reports::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Reports::ReporterId).integer().not_null())\n                    .col(\n                        ColumnDef::new(Reports::TargetType)\n                            .string_len(20)\n                            .not_null(),\n                    )\n                    .col(ColumnDef::new(Reports::TargetId).integer().not_null())\n                    .col(ColumnDef::new(Reports::Reason).string_len(50).not_null())\n                    .col(ColumnDef::new(Reports::Description).text().null())\n                    .col(\n                        ColumnDef::new(Reports::Status)\n                            .string_len(20)\n                            .not_null()\n                            .default(\"pending\"),\n                    )\n                    .col(ColumnDef::new(Reports::ResolvedBy).integer().null())\n                    .col(ColumnDef::new(Reports::ResolvedAt).timestamp().null())\n                    .col(\n                        ColumnDef::new(Reports::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_reports_reporter_id\")\n                            .from(Reports::Table, Reports::ReporterId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_reports_resolved_by\")\n                            .from(Reports::Table, Reports::ResolvedBy)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::SetNull),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_reports_status\")\n                    .table(Reports::Table)\n                    .col(Reports::Status)\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_reports_target\")\n                    .table(Reports::Table)\n                    .col(Reports::TargetType)\n                    .col(Reports::TargetId)\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_reports_unique\")\n                    .table(Reports::Table)\n                    .col(Reports::ReporterId)\n                    .col(Reports::TargetType)\n                    .col(Reports::TargetId)\n                    .unique()\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Reports::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000010_add_hidden_columns.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"ALTER TABLE posts ADD COLUMN is_hidden BOOLEAN NOT NULL DEFAULT FALSE\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"ALTER TABLE comments ADD COLUMN is_hidden BOOLEAN NOT NULL DEFAULT FALSE\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"ALTER TABLE posts DROP COLUMN IF EXISTS is_hidden\")\n            .await?;\n\n        db.execute_unprepared(\"ALTER TABLE comments DROP COLUMN IF EXISTS is_hidden\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000011_add_email_verification.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN email_verified BOOLEAN NOT NULL DEFAULT FALSE\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN email_verification_token VARCHAR(255) NULL\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN email_verification_expires TIMESTAMP NULL\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS email_verified\")\n            .await?;\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS email_verification_token\")\n            .await?;\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS email_verification_expires\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000012_create_bookmarks_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE TABLE IF NOT EXISTS bookmarks (\n                id SERIAL PRIMARY KEY,\n                user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                post_id INTEGER NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE UNIQUE INDEX idx_bookmarks_user_post ON bookmarks(user_id, post_id)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_bookmarks_user_id ON bookmarks(user_id)\")\n            .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n        db.execute_unprepared(\"DROP TABLE IF EXISTS bookmarks\")\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000013_create_follows_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE TABLE IF NOT EXISTS follows (\n                id SERIAL PRIMARY KEY,\n                follower_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                following_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n                CHECK (follower_id != following_id)\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE UNIQUE INDEX idx_follows_pair ON follows(follower_id, following_id)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_follows_follower ON follows(follower_id)\")\n            .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_follows_following ON follows(following_id)\")\n            .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n        db.execute_unprepared(\"DROP TABLE IF EXISTS follows\")\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000014_create_tags_tables.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE TABLE IF NOT EXISTS tags (\n                id SERIAL PRIMARY KEY,\n                name VARCHAR(50) NOT NULL UNIQUE,\n                slug VARCHAR(50) NOT NULL UNIQUE,\n                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_tags_slug ON tags(slug)\")\n            .await?;\n\n        db.execute_unprepared(\n            \"CREATE TABLE IF NOT EXISTS post_tags (\n                id SERIAL PRIMARY KEY,\n                post_id INTEGER NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n                tag_id INTEGER NOT NULL REFERENCES tags(id) ON DELETE CASCADE\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE UNIQUE INDEX idx_post_tags_pair ON post_tags(post_id, tag_id)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_post_tags_tag ON post_tags(tag_id)\")\n            .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n        db.execute_unprepared(\"DROP TABLE IF EXISTS post_tags\")\n            .await?;\n        db.execute_unprepared(\"DROP TABLE IF EXISTS tags\").await?;\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000015_add_password_reset.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN password_reset_token VARCHAR(255) NULL\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN password_reset_expires TIMESTAMP NULL\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE INDEX idx_users_password_reset_token ON users (password_reset_token) WHERE password_reset_token IS NOT NULL\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"DROP INDEX IF EXISTS idx_users_password_reset_token\")\n            .await?;\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS password_reset_token\")\n            .await?;\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS password_reset_expires\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000016_create_refresh_tokens.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE TABLE refresh_tokens (\n                id SERIAL PRIMARY KEY,\n                user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                token VARCHAR(255) NOT NULL UNIQUE,\n                expires_at TIMESTAMP NOT NULL,\n                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE INDEX idx_refresh_tokens_token ON refresh_tokens (token)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens (user_id)\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n        db.execute_unprepared(\"DROP TABLE IF EXISTS refresh_tokens\")\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000017_add_performance_indexes.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE INDEX IF NOT EXISTS idx_notifications_user_created\n             ON notifications (user_id, created_at DESC)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE INDEX IF NOT EXISTS idx_posts_forum_visible_created\n             ON posts (forum_id, is_hidden, created_at DESC)\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"DROP INDEX IF EXISTS idx_notifications_user_created\")\n            .await?;\n        db.execute_unprepared(\"DROP INDEX IF EXISTS idx_posts_forum_visible_created\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","mod.rs"],"content":"use sea_orm_migration::prelude::*;\n\nmod m20240101_000001_create_users_table;\nmod m20240101_000002_create_forums_table;\nmod m20240101_000003_create_posts_table;\nmod m20240101_000004_create_comments_table;\nmod m20240101_000005_create_votes_table;\nmod m20240101_000006_add_comment_parent_index;\nmod m20240101_000007_add_search_index;\nmod m20240101_000008_create_notifications_table;\nmod m20240101_000009_create_reports_table;\nmod m20240101_000010_add_hidden_columns;\nmod m20240101_000011_add_email_verification;\nmod m20240101_000012_create_bookmarks_table;\nmod m20240101_000013_create_follows_table;\nmod m20240101_000014_create_tags_tables;\nmod m20240101_000015_add_password_reset;\nmod m20240101_000016_create_refresh_tokens;\nmod m20240101_000017_add_performance_indexes;\n\npub struct Migrator;\n\n#[async_trait::async_trait]\nimpl MigratorTrait for Migrator {\n    fn migrations() -\u003e Vec\u003cBox\u003cdyn MigrationTrait\u003e\u003e {\n        vec![\n            Box::new(m20240101_000001_create_users_table::Migration),\n            Box::new(m20240101_000002_create_forums_table::Migration),\n            Box::new(m20240101_000003_create_posts_table::Migration),\n            Box::new(m20240101_000004_create_comments_table::Migration),\n            Box::new(m20240101_000005_create_votes_table::Migration),\n            Box::new(m20240101_000006_add_comment_parent_index::Migration),\n            Box::new(m20240101_000007_add_search_index::Migration),\n            Box::new(m20240101_000008_create_notifications_table::Migration),\n            Box::new(m20240101_000009_create_reports_table::Migration),\n            Box::new(m20240101_000010_add_hidden_columns::Migration),\n            Box::new(m20240101_000011_add_email_verification::Migration),\n            Box::new(m20240101_000012_create_bookmarks_table::Migration),\n            Box::new(m20240101_000013_create_follows_table::Migration),\n            Box::new(m20240101_000014_create_tags_tables::Migration),\n            Box::new(m20240101_000015_add_password_reset::Migration),\n            Box::new(m20240101_000016_create_refresh_tokens::Migration),\n            Box::new(m20240101_000017_add_performance_indexes::Migration),\n        ]\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":19},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","bookmark.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"bookmarks\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    pub post_id: i32,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n    #[sea_orm(\n        belongs_to = \"super::post::Entity\",\n        from = \"Column::PostId\",\n        to = \"super::post::Column::Id\"\n    )]\n    Post,\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl Related\u003csuper::post::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Post.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","comment.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"comments\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub post_id: i32,\n    pub user_id: i32,\n    pub parent_id: Option\u003ci32\u003e,\n    #[sea_orm(column_type = \"Text\")]\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub is_hidden: bool,\n    pub created_at: DateTime,\n    pub updated_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::post::Entity\",\n        from = \"Column::PostId\",\n        to = \"super::post::Column::Id\"\n    )]\n    Post,\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n    #[sea_orm(belongs_to = \"Entity\", from = \"Column::ParentId\", to = \"Column::Id\")]\n    Parent,\n}\n\nimpl Related\u003csuper::post::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Post.def()\n    }\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","follow.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"follows\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub follower_id: i32,\n    pub following_id: i32,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","forum.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize, ToSchema)]\n#[sea_orm(table_name = \"forums\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    #[sea_orm(unique)]\n    pub name: String,\n    pub description: String,\n    #[sea_orm(unique)]\n    pub slug: String,\n    pub sort_order: i32,\n    pub icon_url: Option\u003cString\u003e,\n    pub created_at: DateTime,\n    pub updated_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","mod.rs"],"content":"pub mod bookmark;\npub mod comment;\npub mod follow;\npub mod forum;\npub mod notification;\npub mod post;\npub mod post_tag;\npub mod refresh_token;\npub mod report;\npub mod tag;\npub mod user;\npub mod vote;\n\npub use bookmark::Entity as Bookmark;\npub use comment::{Entity as Comment, Model as CommentModel};\npub use follow::Entity as Follow;\npub use forum::{Entity as Forum, Model as ForumModel};\npub use notification::{Entity as Notification, Model as NotificationModel};\npub use post::{Entity as Post, Model as PostModel};\n#[allow(unused_imports)]\npub use post_tag::Entity as PostTag;\n#[allow(unused_imports)]\npub use refresh_token::Entity as RefreshToken;\npub use report::{Entity as Report, Model as ReportModel};\npub use tag::{Entity as Tag, Model as TagModel};\npub use user::{Entity as User, Model as UserModel};\npub use vote::{Entity as Vote, Model as VoteModel};\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","notification.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"notifications\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    #[sea_orm(column_type = \"String(StringLen::N(50))\")]\n    pub kind: String,\n    pub actor_id: i32,\n    #[sea_orm(column_type = \"String(StringLen::N(20))\")]\n    pub target_type: String,\n    pub target_id: i32,\n    #[sea_orm(column_type = \"Text\")]\n    pub message: String,\n    pub is_read: bool,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::ActorId\",\n        to = \"super::user::Column::Id\"\n    )]\n    Actor,\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","post.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize, ToSchema)]\n#[sea_orm(table_name = \"posts\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    pub forum_id: i32,\n    pub title: String,\n    #[sea_orm(column_type = \"Text\")]\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub view_count: i32,\n    pub is_pinned: bool,\n    pub is_locked: bool,\n    pub is_hidden: bool,\n    pub created_at: DateTime,\n    pub updated_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n    #[sea_orm(\n        belongs_to = \"super::forum::Entity\",\n        from = \"Column::ForumId\",\n        to = \"super::forum::Column::Id\"\n    )]\n    Forum,\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl Related\u003csuper::forum::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Forum.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","post_tag.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"post_tags\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub post_id: i32,\n    pub tag_id: i32,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::post::Entity\",\n        from = \"Column::PostId\",\n        to = \"super::post::Column::Id\"\n    )]\n    Post,\n    #[sea_orm(\n        belongs_to = \"super::tag::Entity\",\n        from = \"Column::TagId\",\n        to = \"super::tag::Column::Id\"\n    )]\n    Tag,\n}\n\nimpl Related\u003csuper::post::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Post.def()\n    }\n}\n\nimpl Related\u003csuper::tag::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Tag.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","refresh_token.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"refresh_tokens\")]\n#[allow(dead_code)]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    #[sea_orm(unique)]\n    pub token: String,\n    pub expires_at: DateTime,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\n#[allow(dead_code)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","report.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"reports\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub reporter_id: i32,\n    #[sea_orm(column_type = \"String(StringLen::N(20))\")]\n    pub target_type: String,\n    pub target_id: i32,\n    #[sea_orm(column_type = \"String(StringLen::N(50))\")]\n    pub reason: String,\n    #[sea_orm(column_type = \"Text\", nullable)]\n    pub description: Option\u003cString\u003e,\n    #[sea_orm(column_type = \"String(StringLen::N(20))\")]\n    pub status: String,\n    pub resolved_by: Option\u003ci32\u003e,\n    pub resolved_at: Option\u003cDateTime\u003e,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::ReporterId\",\n        to = \"super::user::Column::Id\"\n    )]\n    Reporter,\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::ResolvedBy\",\n        to = \"super::user::Column::Id\"\n    )]\n    Resolver,\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","tag.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize, ToSchema)]\n#[sea_orm(table_name = \"tags\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub name: String,\n    pub slug: String,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","user.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize, ToSchema)]\n#[sea_orm(table_name = \"users\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub username: String,\n    pub email: String,\n    #[serde(skip_serializing)]\n    pub password_hash: String,\n    pub avatar_url: Option\u003cString\u003e,\n    pub bio: Option\u003cString\u003e,\n    pub karma: i32,\n    pub role: String,\n    pub email_verified: bool,\n    pub email_verification_token: Option\u003cString\u003e,\n    pub email_verification_expires: Option\u003cDateTime\u003e,\n    #[serde(skip_serializing)]\n    pub password_reset_token: Option\u003cString\u003e,\n    #[serde(skip_serializing)]\n    pub password_reset_expires: Option\u003cDateTime\u003e,\n    pub created_at: DateTime,\n    pub updated_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","vote.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"votes\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    pub target_type: String,\n    pub target_id: i32,\n    pub value: i16,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","response.rs"],"content":"use axum::{response::IntoResponse, Json};\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Serialize, ToSchema)]\npub struct ApiResponse\u003cT\u003e {\n    pub success: bool,\n    pub data: Option\u003cT\u003e,\n    pub message: Option\u003cString\u003e,\n}\n\nimpl\u003cT: Serialize\u003e IntoResponse for ApiResponse\u003cT\u003e {\n    fn into_response(self) -\u003e axum::response::Response {\n        Json(self).into_response()\n    }\n}\n\n#[allow(dead_code)]\nimpl\u003cT: Serialize\u003e ApiResponse\u003cT\u003e {\n    pub fn ok(data: T) -\u003e Self {\n        Self {\n            success: true,\n            data: Some(data),\n            message: None,\n        }\n    }\n\n    pub fn with_message(data: T, message: String) -\u003e Self {\n        Self {\n            success: true,\n            data: Some(data),\n            message: Some(message),\n        }\n    }\n\n    pub fn err(message: String) -\u003e Self {\n        Self {\n            success: false,\n            message: Some(message),\n            data: None,\n        }\n    }\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct PaginatedResponse\u003cT: Serialize\u003e {\n    pub items: Vec\u003cT\u003e,\n    pub total: u64,\n    pub page: u64,\n    pub per_page: u64,\n    pub total_pages: u64,\n}\n\nimpl\u003cT: Serialize\u003e PaginatedResponse\u003cT\u003e {\n    pub fn new(items: Vec\u003cT\u003e, total: u64, page: u64, per_page: u64) -\u003e Self {\n        let total_pages = if per_page == 0 {\n            0\n        } else {\n            (total + per_page - 1) / per_page\n        };\n        Self {\n            items,\n            total,\n            page,\n            per_page,\n            total_pages,\n        }\n    }\n}\n\n#[derive(Debug, Deserialize, ToSchema)]\npub struct PaginationQuery {\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn total_pages_basic() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 100, 1, 20);\n        assert_eq!(resp.total_pages, 5);\n    }\n\n    #[test]\n    fn total_pages_with_remainder() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 101, 1, 20);\n        assert_eq!(resp.total_pages, 6);\n    }\n\n    #[test]\n    fn total_pages_exact_division() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 60, 1, 20);\n        assert_eq!(resp.total_pages, 3);\n    }\n\n    #[test]\n    fn total_pages_zero_per_page() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 10, 1, 0);\n        assert_eq!(resp.total_pages, 0);\n    }\n\n    #[test]\n    fn total_pages_zero_total() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 0, 1, 20);\n        assert_eq!(resp.total_pages, 0);\n    }\n\n    #[test]\n    fn total_pages_single_item() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 1, 1, 20);\n        assert_eq!(resp.total_pages, 1);\n    }\n}\n","traces":[{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":432345564227567616}},{"line":56,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":57,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":59,"address":[],"length":0,"stats":{"Line":360287970189639680}}],"covered":4,"coverable":13},{"path":["C:","\\","Users","yimo","Codes","xjy","src","routes","mod.rs"],"content":"use crate::handlers;\nuse crate::middleware::auth::auth_middleware;\nuse crate::websocket;\nuse axum::{middleware, routing, Router};\nuse tower_governor::{governor::GovernorConfigBuilder, GovernorLayer};\n\npub fn create_routes() -\u003e Router {\n    Router::new()\n        .nest(\"/api/v1\", api_routes())\n        // WebSocket route (auth handled inside the handler via query token)\n        .route(\"/ws\", routing::get(websocket::notification::ws_handler))\n}\n\nfn api_routes() -\u003e Router {\n    let auth = auth_routes();\n    let public_read = public_read_routes();\n    let protected = protected_routes().layer(middleware::from_fn(auth_middleware));\n\n    auth.merge(public_read).merge(protected)\n}\n\n/// Auth routes: register, login, verify-email.\n/// Rate limit: 5 req/s, burst 10.\nfn auth_routes() -\u003e Router {\n    let governor_conf = GovernorConfigBuilder::default()\n        .per_second(5)\n        .burst_size(10)\n        .finish()\n        .unwrap();\n\n    Router::new()\n        .route(\"/auth/register\", routing::post(handlers::register))\n        .route(\"/auth/login\", routing::post(handlers::login))\n        .route(\"/auth/refresh\", routing::post(handlers::auth::refresh_token))\n        .route(\n            \"/auth/verify-email\",\n            routing::post(handlers::verify_email),\n        )\n        .route(\n            \"/auth/forgot-password\",\n            routing::post(handlers::auth::forgot_password),\n        )\n        .route(\n            \"/auth/reset-password\",\n            routing::post(handlers::auth::reset_password),\n        )\n        .layer(GovernorLayer::new(governor_conf))\n}\n\n/// Public read routes: all public GETs + search.\n/// Rate limit: 30 req/s, burst 60.\nfn public_read_routes() -\u003e Router {\n    let governor_conf = GovernorConfigBuilder::default()\n        .per_second(30)\n        .burst_size(60)\n        .finish()\n        .unwrap();\n\n    Router::new()\n        // Users\n        .route(\n            \"/users/{username}\",\n            routing::get(handlers::user::get_user_profile),\n        )\n        // Forums\n        .route(\"/forums\", routing::get(handlers::forum::list_forums))\n        .route(\"/forums/{slug}\", routing::get(handlers::forum::get_forum))\n        // Posts\n        .route(\n            \"/forums/{forum_id}/posts\",\n            routing::get(handlers::post::list_posts),\n        )\n        .route(\"/posts/{id}\", routing::get(handlers::post::get_post))\n        // Comments\n        .route(\n            \"/posts/{post_id}/comments\",\n            routing::get(handlers::comment::list_comments),\n        )\n        // Search\n        .route(\"/search\", routing::get(handlers::post::search_posts))\n        // Tags\n        .route(\"/tags\", routing::get(handlers::tag::list_tags))\n        .route(\n            \"/tags/{slug}/posts\",\n            routing::get(handlers::tag::get_posts_by_tag),\n        )\n        // Follow (public reads)\n        .route(\n            \"/users/{id}/followers\",\n            routing::get(handlers::follow::list_followers),\n        )\n        .route(\n            \"/users/{id}/following\",\n            routing::get(handlers::follow::list_following),\n        )\n        .layer(GovernorLayer::new(governor_conf))\n}\n\n/// Protected routes: all authenticated writes.\n/// Rate limit: 10 req/s, burst 20.\nfn protected_routes() -\u003e Router {\n    let governor_conf = GovernorConfigBuilder::default()\n        .per_second(10)\n        .burst_size(20)\n        .finish()\n        .unwrap();\n\n    Router::new()\n        // Auth\n        .route(\"/auth/me\", routing::get(handlers::get_current_user))\n        .route(\"/auth/logout\", routing::post(handlers::auth::logout))\n        .route(\n            \"/auth/profile\",\n            routing::put(handlers::user::update_profile),\n        )\n        .route(\n            \"/auth/password\",\n            routing::put(handlers::change_password),\n        )\n        .route(\n            \"/auth/resend-verification\",\n            routing::post(handlers::resend_verification),\n        )\n        // Forums (admin only - checked in handler)\n        .route(\"/forums\", routing::post(handlers::forum::create_forum))\n        .route(\n            \"/forums/{slug}\",\n            routing::put(handlers::forum::update_forum).delete(handlers::forum::delete_forum),\n        )\n        // Posts\n        .route(\"/posts\", routing::post(handlers::post::create_post))\n        .route(\n            \"/posts/{id}\",\n            routing::put(handlers::post::update_post).delete(handlers::post::delete_post),\n        )\n        .route(\"/posts/{id}/pin\", routing::put(handlers::post::pin_post))\n        .route(\"/posts/{id}/lock\", routing::put(handlers::post::lock_post))\n        // Votes\n        .route(\"/posts/{id}/vote\", routing::post(handlers::vote::vote_post))\n        .route(\n            \"/comments/{id}/vote\",\n            routing::post(handlers::vote::vote_comment),\n        )\n        // Comments\n        .route(\n            \"/comments\",\n            routing::post(handlers::comment::create_comment),\n        )\n        .route(\n            \"/comments/{id}\",\n            routing::put(handlers::comment::update_comment)\n                .delete(handlers::comment::delete_comment),\n        )\n        // Notifications\n        .route(\n            \"/notifications\",\n            routing::get(handlers::notification::list_notifications),\n        )\n        .route(\n            \"/notifications/unread-count\",\n            routing::get(handlers::notification::unread_count),\n        )\n        .route(\n            \"/notifications/read-all\",\n            routing::put(handlers::notification::mark_all_read),\n        )\n        .route(\n            \"/notifications/{id}/read\",\n            routing::put(handlers::notification::mark_read),\n        )\n        // Admin\n        .route(\"/admin/stats\", routing::get(handlers::admin::get_stats))\n        .route(\"/admin/users\", routing::get(handlers::admin::list_users))\n        .route(\n            \"/admin/users/{id}/role\",\n            routing::put(handlers::admin::update_user_role),\n        )\n        .route(\n            \"/admin/posts/{id}\",\n            routing::delete(handlers::admin::admin_delete_post),\n        )\n        .route(\n            \"/admin/comments/{id}\",\n            routing::delete(handlers::admin::admin_delete_comment),\n        )\n        // Bookmarks\n        .route(\n            \"/posts/{id}/bookmark\",\n            routing::post(handlers::bookmark::toggle_bookmark),\n        )\n        .route(\n            \"/bookmarks\",\n            routing::get(handlers::bookmark::list_bookmarks),\n        )\n        // Follow\n        .route(\n            \"/users/{id}/follow\",\n            routing::post(handlers::follow::toggle_follow),\n        )\n        // Upload\n        .route(\n            \"/upload/avatar\",\n            routing::post(handlers::upload::upload_avatar),\n        )\n        .route(\n            \"/upload/image\",\n            routing::post(handlers::upload::upload_image),\n        )\n        // Reports\n        .route(\"/reports\", routing::post(handlers::report::create_report))\n        .route(\n            \"/admin/reports\",\n            routing::get(handlers::report::list_reports),\n        )\n        .route(\n            \"/admin/reports/{id}/resolve\",\n            routing::put(handlers::report::resolve_report),\n        )\n        // Tags (admin)\n        .route(\"/admin/tags\", routing::post(handlers::tag::create_tag))\n        .route(\n            \"/admin/tags/{id}\",\n            routing::put(handlers::tag::update_tag).delete(handlers::tag::delete_tag),\n        )\n        .layer(GovernorLayer::new(governor_conf))\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":73},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","admin.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{post, user, Comment, Forum, Post, User, UserModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\n\npub struct AdminService {\n    db: DatabaseConnection,\n}\n\nimpl AdminService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn get_stats(\u0026self) -\u003e AppResult\u003cAdminStats\u003e {\n        let total_users = User::find().count(\u0026self.db).await?;\n        let total_posts = Post::find().count(\u0026self.db).await?;\n        let total_comments = Comment::find().count(\u0026self.db).await?;\n        let total_forums = Forum::find().count(\u0026self.db).await?;\n\n        let today = chrono::Utc::now().naive_utc().date();\n        let today_start = today.and_hms_opt(0, 0, 0).unwrap();\n\n        let users_today = User::find()\n            .filter(user::Column::CreatedAt.gte(today_start))\n            .count(\u0026self.db)\n            .await?;\n\n        let posts_today = Post::find()\n            .filter(post::Column::CreatedAt.gte(today_start))\n            .count(\u0026self.db)\n            .await?;\n\n        Ok(AdminStats {\n            total_users,\n            total_posts,\n            total_comments,\n            total_forums,\n            users_today,\n            posts_today,\n        })\n    }\n\n    pub async fn list_users(\u0026self, page: u64, per_page: u64) -\u003e AppResult\u003c(Vec\u003cUserModel\u003e, u64)\u003e {\n        let paginator = User::find()\n            .order_by_desc(user::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let users = paginator.fetch_page(page.saturating_sub(1)).await?;\n        Ok((users, total))\n    }\n\n    pub async fn update_user_role(\u0026self, user_id: i32, role: \u0026str) -\u003e AppResult\u003cUserModel\u003e {\n        let valid_roles = [\"user\", \"admin\", \"moderator\", \"banned\"];\n        if !valid_roles.contains(\u0026role) {\n            return Err(AppError::Validation(format!(\n                \"Invalid role. Must be one of: {}\",\n                valid_roles.join(\", \")\n            )));\n        }\n\n        let existing = User::find_by_id(user_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let mut active: user::ActiveModel = existing.into();\n        active.role = sea_orm::ActiveValue::Set(role.to_string());\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn admin_delete_post(\u0026self, post_id: i32) -\u003e AppResult\u003c()\u003e {\n        Post::find_by_id(post_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        Post::delete_by_id(post_id).exec(\u0026self.db).await?;\n        Ok(())\n    }\n\n    pub async fn admin_delete_comment(\u0026self, comment_id: i32) -\u003e AppResult\u003c()\u003e {\n        Comment::find_by_id(comment_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        Comment::delete_by_id(comment_id).exec(\u0026self.db).await?;\n        Ok(())\n    }\n}\n\npub struct AdminStats {\n    pub total_users: u64,\n    pub total_posts: u64,\n    pub total_comments: u64,\n    pub total_forums: u64,\n    pub users_today: u64,\n    pub posts_today: u64,\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":58},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","auth.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::User,\n    services::email::EmailService,\n    utils::{encode_access_token, encode_refresh_token, hash_password, verify_password},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n};\n\npub struct AuthService {\n    db: DatabaseConnection,\n}\n\nimpl AuthService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    /// Register a new user and send verification email.\n    /// Returns (user_model, access_token, refresh_token).\n    pub async fn register(\n        \u0026self,\n        username: \u0026str,\n        email: \u0026str,\n        password: \u0026str,\n        email_service: \u0026EmailService,\n    ) -\u003e AppResult\u003c(crate::models::UserModel, String, String)\u003e {\n        // Check if username or email already exists\n        if self.user_exists(username, email).await? {\n            return Err(AppError::Validation(\n                \"Username or email already exists\".to_string(),\n            ));\n        }\n\n        let password_hash = hash_password(password)?;\n        let now = chrono::Utc::now().naive_utc();\n        let verification_token = uuid::Uuid::new_v4().to_string();\n        let verification_expires = now + chrono::Duration::hours(24);\n\n        let new_user = crate::models::user::ActiveModel {\n            username: sea_orm::ActiveValue::Set(username.to_string()),\n            email: sea_orm::ActiveValue::Set(email.to_string()),\n            password_hash: sea_orm::ActiveValue::Set(password_hash),\n            karma: sea_orm::ActiveValue::Set(0),\n            role: sea_orm::ActiveValue::Set(\"user\".to_string()),\n            email_verified: sea_orm::ActiveValue::Set(false),\n            email_verification_token: sea_orm::ActiveValue::Set(Some(\n                verification_token.clone(),\n            )),\n            email_verification_expires: sea_orm::ActiveValue::Set(Some(verification_expires)),\n            created_at: sea_orm::ActiveValue::Set(now),\n            updated_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let user = new_user.insert(\u0026self.db).await?;\n        let access_token = encode_access_token(\u0026user.id.to_string())?;\n        let refresh_token = encode_refresh_token(\u0026user.id.to_string())?;\n\n        // Send verification email (non-fatal)\n        if let Err(e) = email_service\n            .send_verification_email(\u0026user.email, \u0026verification_token)\n            .await\n        {\n            tracing::warn!(\"Failed to send verification email: {e}\");\n        }\n\n        Ok((user, access_token, refresh_token))\n    }\n\n    /// Login user\n    /// Returns (user_model, access_token, refresh_token)\n    pub async fn login(\n        \u0026self,\n        username: \u0026str,\n        password: \u0026str,\n    ) -\u003e AppResult\u003c(crate::models::UserModel, String, String)\u003e {\n        // Find user by username\n        let user: crate::models::UserModel = self\n            .find_by_username(username)\n            .await\n            .map_err(|_| AppError::Unauthorized)?;\n\n        // Verify password\n        let is_valid = verify_password(password, \u0026user.password_hash)?;\n        if !is_valid {\n            return Err(AppError::Unauthorized);\n        }\n\n        // Generate JWT tokens\n        let access_token = encode_access_token(\u0026user.id.to_string())?;\n        let refresh_token = encode_refresh_token(\u0026user.id.to_string())?;\n\n        Ok((user, access_token, refresh_token))\n    }\n\n    /// Get user by ID\n    pub async fn get_user_by_id(\u0026self, id: i32) -\u003e AppResult\u003ccrate::models::UserModel\u003e {\n        let user = User::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n        Ok(user)\n    }\n\n    /// Check if user exists by username or email\n    async fn user_exists(\u0026self, username: \u0026str, email: \u0026str) -\u003e AppResult\u003cbool\u003e {\n        let count = User::find()\n            .filter(\n                sea_orm::Condition::any()\n                    .add(crate::models::user::Column::Username.eq(username))\n                    .add(crate::models::user::Column::Email.eq(email)),\n            )\n            .count(\u0026self.db)\n            .await?;\n\n        Ok(count \u003e 0)\n    }\n\n    /// Find user by username\n    async fn find_by_username(\u0026self, username: \u0026str) -\u003e AppResult\u003ccrate::models::UserModel\u003e {\n        let user = User::find()\n            .filter(crate::models::user::Column::Username.eq(username))\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n        Ok(user)\n    }\n\n    /// Change password for authenticated user\n    pub async fn change_password(\n        \u0026self,\n        user_id: i32,\n        current_password: \u0026str,\n        new_password: \u0026str,\n    ) -\u003e AppResult\u003c()\u003e {\n        let user = self.get_user_by_id(user_id).await?;\n        let is_valid = verify_password(current_password, \u0026user.password_hash)?;\n        if !is_valid {\n            return Err(AppError::Validation(\n                \"Current password is incorrect\".to_string(),\n            ));\n        }\n        let new_hash = hash_password(new_password)?;\n        let now = chrono::Utc::now().naive_utc();\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.password_hash = sea_orm::ActiveValue::Set(new_hash);\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n        active.update(\u0026self.db).await?;\n        Ok(())\n    }\n\n    /// Verify email with token\n    pub async fn verify_email(\u0026self, token: \u0026str) -\u003e AppResult\u003c()\u003e {\n        let user = User::find()\n            .filter(crate::models::user::Column::EmailVerificationToken.eq(token))\n            .one(\u0026self.db)\n            .await?\n            .ok_or_else(|| AppError::Validation(\"Invalid verification token\".to_string()))?;\n\n        if let Some(expires) = user.email_verification_expires {\n            if chrono::Utc::now().naive_utc() \u003e expires {\n                return Err(AppError::Validation(\n                    \"Verification token has expired\".to_string(),\n                ));\n            }\n        }\n\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.email_verified = sea_orm::ActiveValue::Set(true);\n        active.email_verification_token = sea_orm::ActiveValue::Set(None);\n        active.email_verification_expires = sea_orm::ActiveValue::Set(None);\n        active.update(\u0026self.db).await?;\n        Ok(())\n    }\n\n    /// Resend email verification token\n    pub async fn resend_verification(\n        \u0026self,\n        user_id: i32,\n        email_service: \u0026EmailService,\n    ) -\u003e AppResult\u003c()\u003e {\n        let user = self.get_user_by_id(user_id).await?;\n        if user.email_verified {\n            return Err(AppError::Validation(\n                \"Email is already verified\".to_string(),\n            ));\n        }\n        let token = uuid::Uuid::new_v4().to_string();\n        let now = chrono::Utc::now().naive_utc();\n        let expires = now + chrono::Duration::hours(24);\n\n        let email = user.email.clone();\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.email_verification_token = sea_orm::ActiveValue::Set(Some(token.clone()));\n        active.email_verification_expires = sea_orm::ActiveValue::Set(Some(expires));\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n        active.update(\u0026self.db).await?;\n\n        if let Err(e) = email_service.send_verification_email(\u0026email, \u0026token).await {\n            tracing::warn!(\"Failed to send verification email: {e}\");\n        }\n\n        Ok(())\n    }\n\n    /// Request a password reset. Timing-safe: silently succeeds if user not found.\n    pub async fn forgot_password(\n        \u0026self,\n        email: \u0026str,\n        email_service: \u0026EmailService,\n    ) -\u003e AppResult\u003c()\u003e {\n        let user = User::find()\n            .filter(crate::models::user::Column::Email.eq(email))\n            .one(\u0026self.db)\n            .await?;\n\n        let user = match user {\n            Some(u) =\u003e u,\n            None =\u003e return Ok(()), // timing-safe: don't reveal whether email exists\n        };\n\n        let token = uuid::Uuid::new_v4().to_string();\n        let now = chrono::Utc::now().naive_utc();\n        let expires = now + chrono::Duration::hours(1);\n\n        let user_email = user.email.clone();\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.password_reset_token = sea_orm::ActiveValue::Set(Some(token.clone()));\n        active.password_reset_expires = sea_orm::ActiveValue::Set(Some(expires));\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n        active.update(\u0026self.db).await?;\n\n        if let Err(e) = email_service\n            .send_password_reset_email(\u0026user_email, \u0026token)\n            .await\n        {\n            tracing::warn!(\"Failed to send password reset email: {e}\");\n        }\n\n        Ok(())\n    }\n\n    /// Reset password using a reset token.\n    pub async fn reset_password(\u0026self, token: \u0026str, new_password: \u0026str) -\u003e AppResult\u003c()\u003e {\n        let user = User::find()\n            .filter(crate::models::user::Column::PasswordResetToken.eq(token))\n            .one(\u0026self.db)\n            .await?\n            .ok_or_else(|| AppError::Validation(\"Invalid reset token\".to_string()))?;\n\n        if let Some(expires) = user.password_reset_expires {\n            if chrono::Utc::now().naive_utc() \u003e expires {\n                return Err(AppError::Validation(\"Reset token has expired\".to_string()));\n            }\n        }\n\n        let new_hash = hash_password(new_password)?;\n        let now = chrono::Utc::now().naive_utc();\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.password_hash = sea_orm::ActiveValue::Set(new_hash);\n        active.password_reset_token = sea_orm::ActiveValue::Set(None);\n        active.password_reset_expires = sea_orm::ActiveValue::Set(None);\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n        active.update(\u0026self.db).await?;\n\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn validate_email_format_valid() {\n        let email = \"user@example.com\";\n        assert!(email.contains('@') \u0026\u0026 email.contains('.'));\n    }\n\n    #[test]\n    fn validate_email_format_missing_at() {\n        let email = \"userexample.com\";\n        assert!(!(email.contains('@') \u0026\u0026 email.contains('.')));\n    }\n\n    #[test]\n    fn validate_email_format_missing_dot() {\n        let email = \"user@examplecom\";\n        assert!(!(email.contains('@') \u0026\u0026 email.contains('.')));\n    }\n\n    #[test]\n    fn validate_username_length_valid() {\n        let username = \"alice\";\n        assert!(username.len() \u003e= 3 \u0026\u0026 username.len() \u003c= 30);\n    }\n\n    #[test]\n    fn validate_username_too_short() {\n        let username = \"ab\";\n        assert!(!(username.len() \u003e= 3 \u0026\u0026 username.len() \u003c= 30));\n    }\n\n    #[test]\n    fn validate_password_length_valid() {\n        let password = \"password123\";\n        assert!(password.len() \u003e= 8);\n    }\n\n    #[test]\n    fn validate_password_too_short() {\n        let password = \"pass\";\n        assert!(!(password.len() \u003e= 8));\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":145},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","bookmark.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{bookmark, post, Bookmark, Post, PostModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\nuse std::collections::HashMap;\n\npub struct BookmarkService {\n    db: DatabaseConnection,\n}\n\nimpl BookmarkService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    /// Toggle bookmark: if exists -\u003e delete, if not -\u003e create.\n    /// Returns true if bookmarked, false if un-bookmarked.\n    pub async fn toggle(\u0026self, user_id: i32, post_id: i32) -\u003e AppResult\u003cbool\u003e {\n        // Verify post exists\n        Post::find_by_id(post_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let existing = Bookmark::find()\n            .filter(bookmark::Column::UserId.eq(user_id))\n            .filter(bookmark::Column::PostId.eq(post_id))\n            .one(\u0026self.db)\n            .await?;\n\n        if let Some(existing) = existing {\n            Bookmark::delete_by_id(existing.id)\n                .exec(\u0026self.db)\n                .await?;\n            Ok(false)\n        } else {\n            let now = chrono::Utc::now().naive_utc();\n            let model = bookmark::ActiveModel {\n                user_id: sea_orm::ActiveValue::Set(user_id),\n                post_id: sea_orm::ActiveValue::Set(post_id),\n                created_at: sea_orm::ActiveValue::Set(now),\n                ..Default::default()\n            };\n            model.insert(\u0026self.db).await?;\n            Ok(true)\n        }\n    }\n\n    /// List user's bookmarked posts with pagination.\n    /// Returns posts in bookmark order (most recently bookmarked first).\n    pub async fn list_user_bookmarks(\n        \u0026self,\n        user_id: i32,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        let paginator = Bookmark::find()\n            .filter(bookmark::Column::UserId.eq(user_id))\n            .order_by_desc(bookmark::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let bookmarks = paginator.fetch_page(page.saturating_sub(1)).await?;\n\n        let post_ids: Vec\u003ci32\u003e = bookmarks.iter().map(|b| b.post_id).collect();\n        if post_ids.is_empty() {\n            return Ok((vec![], total));\n        }\n\n        let posts = Post::find()\n            .filter(post::Column::Id.is_in(post_ids.clone()))\n            .all(\u0026self.db)\n            .await?;\n\n        // Reorder posts to match bookmark order\n        let post_map: HashMap\u003ci32, PostModel\u003e = posts.into_iter().map(|p| (p.id, p)).collect();\n        let ordered: Vec\u003cPostModel\u003e = post_ids\n            .into_iter()\n            .filter_map(|id| post_map.get(\u0026id).cloned())\n            .collect();\n\n        Ok((ordered, total))\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":40},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","cache.rs"],"content":"use redis::aio::ConnectionManager;\nuse redis::AsyncCommands;\nuse serde::{de::DeserializeOwned, Serialize};\n\n#[derive(Clone)]\npub struct CacheService {\n    redis: ConnectionManager,\n}\n\nimpl CacheService {\n    pub fn new(redis: ConnectionManager) -\u003e Self {\n        Self { redis }\n    }\n\n    pub async fn get\u003cT: DeserializeOwned\u003e(\u0026self, key: \u0026str) -\u003e Option\u003cT\u003e {\n        let mut conn = self.redis.clone();\n        let result: Option\u003cString\u003e = conn.get(key).await.ok()?;\n        result.and_then(|s| serde_json::from_str(\u0026s).ok())\n    }\n\n    pub async fn set\u003cT: Serialize\u003e(\u0026self, key: \u0026str, value: \u0026T, ttl_secs: u64) {\n        let mut conn = self.redis.clone();\n        if let Ok(json) = serde_json::to_string(value) {\n            let _: Result\u003c(), _\u003e = conn.set_ex(key, json, ttl_secs).await;\n        }\n    }\n\n    pub async fn invalidate(\u0026self, key: \u0026str) {\n        let mut conn = self.redis.clone();\n        let _: Result\u003c(), _\u003e = conn.del(key).await;\n    }\n\n    #[allow(dead_code)]\n    pub async fn invalidate_pattern(\u0026self, pattern: \u0026str) {\n        let mut conn = self.redis.clone();\n        if let Ok(keys) = redis::cmd(\"KEYS\")\n            .arg(pattern)\n            .query_async::\u003cVec\u003cString\u003e\u003e(\u0026mut conn)\n            .await\n        {\n            if !keys.is_empty() {\n                let _: Result\u003c(), _\u003e = conn.del(keys).await;\n            }\n        }\n    }\n}\n","traces":[{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","comment.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{comment, Comment, CommentModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, QueryFilter, QueryOrder,\n};\n\npub struct CommentService {\n    db: DatabaseConnection,\n}\n\nimpl CommentService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn list_by_post(\u0026self, post_id: i32) -\u003e AppResult\u003cVec\u003cCommentModel\u003e\u003e {\n        let comments = Comment::find()\n            .filter(comment::Column::PostId.eq(post_id))\n            .filter(comment::Column::IsHidden.eq(false))\n            .order_by_asc(comment::Column::CreatedAt)\n            .all(\u0026self.db)\n            .await?;\n        Ok(comments)\n    }\n\n    pub async fn create(\n        \u0026self,\n        post_id: i32,\n        user_id: i32,\n        parent_id: Option\u003ci32\u003e,\n        content: \u0026str,\n    ) -\u003e AppResult\u003cCommentModel\u003e {\n        if let Some(pid) = parent_id {\n            self.validate_parent(pid, post_id).await?;\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let new_comment = comment::ActiveModel {\n            post_id: sea_orm::ActiveValue::Set(post_id),\n            user_id: sea_orm::ActiveValue::Set(user_id),\n            parent_id: sea_orm::ActiveValue::Set(parent_id),\n            content: sea_orm::ActiveValue::Set(content.to_string()),\n            upvotes: sea_orm::ActiveValue::Set(0),\n            downvotes: sea_orm::ActiveValue::Set(0),\n            created_at: sea_orm::ActiveValue::Set(now),\n            updated_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let comment = new_comment.insert(\u0026self.db).await?;\n        Ok(comment)\n    }\n\n    pub async fn update(\u0026self, id: i32, user_id: i32, content: \u0026str) -\u003e AppResult\u003cCommentModel\u003e {\n        let existing = self.get_by_id(id).await?;\n        if existing.user_id != user_id {\n            return Err(AppError::Forbidden);\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: comment::ActiveModel = existing.into();\n        active.content = sea_orm::ActiveValue::Set(content.to_string());\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn delete(\u0026self, id: i32, user_id: i32) -\u003e AppResult\u003c()\u003e {\n        let existing = self.get_by_id(id).await?;\n        if existing.user_id != user_id {\n            return Err(AppError::Forbidden);\n        }\n\n        Comment::delete_by_id(id).exec(\u0026self.db).await?;\n        Ok(())\n    }\n\n    pub async fn get_by_id(\u0026self, id: i32) -\u003e AppResult\u003cCommentModel\u003e {\n        Comment::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    async fn validate_parent(\u0026self, parent_id: i32, post_id: i32) -\u003e AppResult\u003c()\u003e {\n        let parent = Comment::find_by_id(parent_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::Validation(\"Parent comment not found\".to_string()))?;\n\n        if parent.post_id != post_id {\n            return Err(AppError::Validation(\n                \"Parent comment belongs to a different post\".to_string(),\n            ));\n        }\n\n        let depth = self.get_comment_depth(parent_id).await?;\n        if depth \u003e= 10 {\n            return Err(AppError::Validation(\n                \"Maximum comment nesting depth reached\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    async fn get_comment_depth(\u0026self, comment_id: i32) -\u003e AppResult\u003cu32\u003e {\n        let mut depth = 0u32;\n        let mut current_id = Some(comment_id);\n\n        while let Some(id) = current_id {\n            let comment = Comment::find_by_id(id)\n                .one(\u0026self.db)\n                .await?\n                .ok_or(AppError::NotFound)?;\n            current_id = comment.parent_id;\n            depth += 1;\n            if depth \u003e 10 {\n                break;\n            }\n        }\n\n        Ok(depth)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    const MAX_DEPTH: u32 = 10;\n\n    fn is_depth_exceeded(depth: u32) -\u003e bool {\n        depth \u003e MAX_DEPTH\n    }\n\n    #[test]\n    fn test_depth_limit_enforced() {\n        assert!(is_depth_exceeded(11));\n        assert!(!is_depth_exceeded(10));\n    }\n\n    #[test]\n    fn test_root_comment_has_no_parent() {\n        let parent_id: Option\u003ci32\u003e = None;\n        assert!(parent_id.is_none());\n    }\n\n    #[test]\n    fn test_reply_has_parent() {\n        let parent_id = Some(1);\n        assert!(parent_id.is_some());\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":70},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","email.rs"],"content":"use crate::config::email::EmailConfig;\nuse anyhow::Result;\nuse lettre::{\n    message::{header::ContentType, Mailbox},\n    transport::smtp::authentication::Credentials,\n    AsyncSmtpTransport, AsyncTransport, Message, Tokio1Executor,\n};\n\n#[derive(Clone)]\npub struct EmailService {\n    transport: Option\u003cAsyncSmtpTransport\u003cTokio1Executor\u003e\u003e,\n    from_address: Option\u003cString\u003e,\n    frontend_url: String,\n}\n\nimpl EmailService {\n    /// Build from environment variables. If SMTP is not configured, email\n    /// sending is silently skipped (graceful degradation).\n    pub fn from_env() -\u003e Self {\n        match EmailConfig::from_env() {\n            Some(cfg) =\u003e {\n                let creds =\n                    Credentials::new(cfg.smtp_username.clone(), cfg.smtp_password.clone());\n                let transport = AsyncSmtpTransport::\u003cTokio1Executor\u003e::relay(\u0026cfg.smtp_host)\n                    .map(|builder| builder.port(cfg.smtp_port).credentials(creds).build());\n\n                match transport {\n                    Ok(t) =\u003e Self {\n                        transport: Some(t),\n                        from_address: Some(cfg.from_address),\n                        frontend_url: cfg.frontend_url,\n                    },\n                    Err(e) =\u003e {\n                        tracing::warn!(\"Failed to build SMTP transport: {e}\");\n                        Self {\n                            transport: None,\n                            from_address: None,\n                            frontend_url: cfg.frontend_url,\n                        }\n                    }\n                }\n            }\n            None =\u003e {\n                let frontend_url = std::env::var(\"FRONTEND_URL\")\n                    .unwrap_or_else(|_| \"http://localhost:3000\".to_string());\n                Self {\n                    transport: None,\n                    from_address: None,\n                    frontend_url,\n                }\n            }\n        }\n    }\n\n    /// Returns true if SMTP is configured and available.\n    pub fn is_configured(\u0026self) -\u003e bool {\n        self.transport.is_some()\n    }\n\n    /// Send a verification email. Silently succeeds if SMTP is not configured.\n    pub async fn send_verification_email(\u0026self, to: \u0026str, token: \u0026str) -\u003e Result\u003c()\u003e {\n        let link = format!(\"{}/verify-email?token={}\", self.frontend_url, token);\n        let body = format!(\n            \"Welcome! Please verify your email by clicking the link below:\\n\\n{}\\n\\nThis link expires in 24 hours.\",\n            link\n        );\n\n        self.send_email(to, \"Verify your email\", \u0026body).await\n    }\n\n    /// Send a password reset email. Silently succeeds if SMTP is not configured.\n    pub async fn send_password_reset_email(\u0026self, to: \u0026str, token: \u0026str) -\u003e Result\u003c()\u003e {\n        let link = format!(\"{}/reset-password?token={}\", self.frontend_url, token);\n        let body = format!(\n            \"A password reset was requested for your account.\\n\\nClick the link below to reset your password:\\n\\n{}\\n\\nThis link expires in 1 hour. If you did not request this, you can safely ignore this email.\",\n            link\n        );\n\n        self.send_email(to, \"Reset your password\", \u0026body).await\n    }\n\n    async fn send_email(\u0026self, to: \u0026str, subject: \u0026str, body: \u0026str) -\u003e Result\u003c()\u003e {\n        let transport = match \u0026self.transport {\n            Some(t) =\u003e t,\n            None =\u003e {\n                tracing::debug!(\"SMTP not configured, skipping email to {to}\");\n                return Ok(());\n            }\n        };\n        let from_address = match \u0026self.from_address {\n            Some(f) =\u003e f,\n            None =\u003e return Ok(()),\n        };\n\n        let from_mailbox: Mailbox = from_address.parse().map_err(|e: lettre::address::AddressError| {\n            anyhow::anyhow!(\"Invalid from address '{}': {}\", from_address, e)\n        })?;\n        let to_mailbox: Mailbox = to.parse().map_err(|e: lettre::address::AddressError| {\n            anyhow::anyhow!(\"Invalid to address '{}': {}\", to, e)\n        })?;\n\n        let email = Message::builder()\n            .from(from_mailbox)\n            .to(to_mailbox)\n            .subject(subject)\n            .header(ContentType::TEXT_PLAIN)\n            .body(body.to_string())?;\n\n        transport.send(email).await?;\n        tracing::info!(\"Email sent to {to}: {subject}\");\n        Ok(())\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":47},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","follow.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{follow, user, Follow, User, UserModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\nuse std::collections::HashMap;\n\npub struct FollowService {\n    db: DatabaseConnection,\n}\n\nimpl FollowService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    /// Toggle follow: if exists -\u003e unfollow, if not -\u003e follow.\n    /// Returns true if now following, false if unfollowed.\n    pub async fn toggle(\u0026self, follower_id: i32, following_id: i32) -\u003e AppResult\u003cbool\u003e {\n        if follower_id == following_id {\n            return Err(AppError::Validation(\"Cannot follow yourself\".to_string()));\n        }\n\n        // Verify target user exists\n        User::find_by_id(following_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let existing = Follow::find()\n            .filter(follow::Column::FollowerId.eq(follower_id))\n            .filter(follow::Column::FollowingId.eq(following_id))\n            .one(\u0026self.db)\n            .await?;\n\n        if let Some(existing) = existing {\n            Follow::delete_by_id(existing.id)\n                .exec(\u0026self.db)\n                .await?;\n            Ok(false)\n        } else {\n            let now = chrono::Utc::now().naive_utc();\n            let model = follow::ActiveModel {\n                follower_id: sea_orm::ActiveValue::Set(follower_id),\n                following_id: sea_orm::ActiveValue::Set(following_id),\n                created_at: sea_orm::ActiveValue::Set(now),\n                ..Default::default()\n            };\n            model.insert(\u0026self.db).await?;\n            Ok(true)\n        }\n    }\n\n    /// List users who follow the given user (followers of user_id).\n    pub async fn list_followers(\n        \u0026self,\n        user_id: i32,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cUserModel\u003e, u64)\u003e {\n        let paginator = Follow::find()\n            .filter(follow::Column::FollowingId.eq(user_id))\n            .order_by_desc(follow::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let follows = paginator.fetch_page(page.saturating_sub(1)).await?;\n\n        let user_ids: Vec\u003ci32\u003e = follows.iter().map(|f| f.follower_id).collect();\n        if user_ids.is_empty() {\n            return Ok((vec![], total));\n        }\n\n        let users = User::find()\n            .filter(user::Column::Id.is_in(user_ids.clone()))\n            .all(\u0026self.db)\n            .await?;\n\n        // Reorder to match follow order\n        let user_map: HashMap\u003ci32, UserModel\u003e = users.into_iter().map(|u| (u.id, u)).collect();\n        let ordered: Vec\u003cUserModel\u003e = user_ids\n            .into_iter()\n            .filter_map(|id| user_map.get(\u0026id).cloned())\n            .collect();\n\n        Ok((ordered, total))\n    }\n\n    /// List users that the given user follows (following of user_id).\n    pub async fn list_following(\n        \u0026self,\n        user_id: i32,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cUserModel\u003e, u64)\u003e {\n        let paginator = Follow::find()\n            .filter(follow::Column::FollowerId.eq(user_id))\n            .order_by_desc(follow::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let follows = paginator.fetch_page(page.saturating_sub(1)).await?;\n\n        let user_ids: Vec\u003ci32\u003e = follows.iter().map(|f| f.following_id).collect();\n        if user_ids.is_empty() {\n            return Ok((vec![], total));\n        }\n\n        let users = User::find()\n            .filter(user::Column::Id.is_in(user_ids.clone()))\n            .all(\u0026self.db)\n            .await?;\n\n        let user_map: HashMap\u003ci32, UserModel\u003e = users.into_iter().map(|u| (u.id, u)).collect();\n        let ordered: Vec\u003cUserModel\u003e = user_ids\n            .into_iter()\n            .filter_map(|id| user_map.get(\u0026id).cloned())\n            .collect();\n\n        Ok((ordered, total))\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":60},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","forum.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{forum, Forum, ForumModel},\n    services::cache::CacheService,\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, QueryFilter, QueryOrder,\n};\n\nconst CACHE_KEY_FORUMS_LIST: \u0026str = \"forums:list\";\nconst CACHE_TTL_FORUMS: u64 = 300; // 5 minutes\n\npub struct ForumService {\n    db: DatabaseConnection,\n    cache: Option\u003cCacheService\u003e,\n}\n\nimpl ForumService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db, cache: None }\n    }\n\n    pub fn with_cache(mut self, cache: CacheService) -\u003e Self {\n        self.cache = Some(cache);\n        self\n    }\n\n    pub async fn list(\u0026self) -\u003e AppResult\u003cVec\u003cForumModel\u003e\u003e {\n        if let Some(cache) = \u0026self.cache {\n            if let Some(cached) = cache.get::\u003cVec\u003cForumModel\u003e\u003e(CACHE_KEY_FORUMS_LIST).await {\n                return Ok(cached);\n            }\n        }\n\n        let forums = Forum::find()\n            .order_by_asc(forum::Column::SortOrder)\n            .all(\u0026self.db)\n            .await?;\n\n        if let Some(cache) = \u0026self.cache {\n            cache\n                .set(CACHE_KEY_FORUMS_LIST, \u0026forums, CACHE_TTL_FORUMS)\n                .await;\n        }\n\n        Ok(forums)\n    }\n\n    #[allow(dead_code)]\n    pub async fn get_by_id(\u0026self, id: i32) -\u003e AppResult\u003cForumModel\u003e {\n        Forum::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    pub async fn get_by_slug(\u0026self, slug: \u0026str) -\u003e AppResult\u003cForumModel\u003e {\n        Forum::find()\n            .filter(forum::Column::Slug.eq(slug))\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    pub async fn create(\n        \u0026self,\n        name: \u0026str,\n        description: \u0026str,\n        slug: \u0026str,\n        sort_order: i32,\n        icon_url: Option\u003cString\u003e,\n    ) -\u003e AppResult\u003cForumModel\u003e {\n        let now = chrono::Utc::now().naive_utc();\n\n        let new_forum = forum::ActiveModel {\n            name: sea_orm::ActiveValue::Set(name.to_string()),\n            description: sea_orm::ActiveValue::Set(description.to_string()),\n            slug: sea_orm::ActiveValue::Set(slug.to_string()),\n            sort_order: sea_orm::ActiveValue::Set(sort_order),\n            icon_url: sea_orm::ActiveValue::Set(icon_url),\n            created_at: sea_orm::ActiveValue::Set(now),\n            updated_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let forum = new_forum.insert(\u0026self.db).await?;\n        self.invalidate_list_cache().await;\n        Ok(forum)\n    }\n\n    pub async fn update(\n        \u0026self,\n        slug: \u0026str,\n        name: \u0026str,\n        description: \u0026str,\n        sort_order: i32,\n        icon_url: Option\u003cString\u003e,\n    ) -\u003e AppResult\u003cForumModel\u003e {\n        let existing = self.get_by_slug(slug).await?;\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: forum::ActiveModel = existing.into();\n        active.name = sea_orm::ActiveValue::Set(name.to_string());\n        active.description = sea_orm::ActiveValue::Set(description.to_string());\n        active.sort_order = sea_orm::ActiveValue::Set(sort_order);\n        active.icon_url = sea_orm::ActiveValue::Set(icon_url);\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        self.invalidate_list_cache().await;\n        Ok(updated)\n    }\n\n    pub async fn delete(\u0026self, slug: \u0026str) -\u003e AppResult\u003c()\u003e {\n        let existing = self.get_by_slug(slug).await?;\n        Forum::delete_by_id(existing.id).exec(\u0026self.db).await?;\n        self.invalidate_list_cache().await;\n        Ok(())\n    }\n\n    async fn invalidate_list_cache(\u0026self) {\n        if let Some(cache) = \u0026self.cache {\n            cache.invalidate(CACHE_KEY_FORUMS_LIST).await;\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn cache_key_constant() {\n        assert_eq!(CACHE_KEY_FORUMS_LIST, \"forums:list\");\n    }\n\n    #[test]\n    fn cache_ttl_value() {\n        assert_eq!(CACHE_TTL_FORUMS, 300);\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":60},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","mod.rs"],"content":"pub mod admin;\npub mod auth;\npub mod bookmark;\npub mod cache;\npub mod email;\npub mod follow;\npub mod comment;\npub mod forum;\npub mod notification;\npub mod post;\npub mod report;\npub mod tag;\npub mod upload;\npub mod user;\npub mod vote;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","notification.rs"],"content":"use crate::{\n    error::AppResult,\n    models::{notification, Notification, NotificationModel},\n    websocket::hub::NotificationHub,\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\n\npub struct NotificationService {\n    db: DatabaseConnection,\n    hub: NotificationHub,\n}\n\nimpl NotificationService {\n    pub fn new(db: DatabaseConnection, hub: NotificationHub) -\u003e Self {\n        Self { db, hub }\n    }\n\n    pub async fn notify(\n        \u0026self,\n        user_id: i32,\n        actor_id: i32,\n        kind: \u0026str,\n        target_type: \u0026str,\n        target_id: i32,\n        message: \u0026str,\n    ) -\u003e AppResult\u003c()\u003e {\n        // Don't notify yourself\n        if user_id == actor_id {\n            return Ok(());\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n        let model = notification::ActiveModel {\n            user_id: sea_orm::ActiveValue::Set(user_id),\n            kind: sea_orm::ActiveValue::Set(kind.to_string()),\n            actor_id: sea_orm::ActiveValue::Set(actor_id),\n            target_type: sea_orm::ActiveValue::Set(target_type.to_string()),\n            target_id: sea_orm::ActiveValue::Set(target_id),\n            message: sea_orm::ActiveValue::Set(message.to_string()),\n            is_read: sea_orm::ActiveValue::Set(false),\n            created_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let saved = model.insert(\u0026self.db).await?;\n\n        // Push via WebSocket\n        let json = serde_json::json!({\n            \"type\": \"notification\",\n            \"data\": {\n                \"id\": saved.id,\n                \"kind\": \u0026saved.kind,\n                \"message\": \u0026saved.message,\n                \"target_type\": \u0026saved.target_type,\n                \"target_id\": saved.target_id,\n                \"created_at\": saved.created_at.to_string(),\n            }\n        });\n        self.hub.send_to_user(user_id, \u0026json.to_string());\n\n        Ok(())\n    }\n\n    pub async fn list_for_user(\n        \u0026self,\n        user_id: i32,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cNotificationModel\u003e, u64)\u003e {\n        let paginator = Notification::find()\n            .filter(notification::Column::UserId.eq(user_id))\n            .order_by_desc(notification::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let items = paginator.fetch_page(page.saturating_sub(1)).await?;\n        Ok((items, total))\n    }\n\n    pub async fn unread_count(\u0026self, user_id: i32) -\u003e AppResult\u003cu64\u003e {\n        let count = Notification::find()\n            .filter(notification::Column::UserId.eq(user_id))\n            .filter(notification::Column::IsRead.eq(false))\n            .count(\u0026self.db)\n            .await?;\n        Ok(count)\n    }\n\n    pub async fn mark_read(\u0026self, id: i32, user_id: i32) -\u003e AppResult\u003c()\u003e {\n        let existing = Notification::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(crate::error::AppError::NotFound)?;\n\n        if existing.user_id != user_id {\n            return Err(crate::error::AppError::Forbidden);\n        }\n\n        let mut active: notification::ActiveModel = existing.into();\n        active.is_read = sea_orm::ActiveValue::Set(true);\n        active.update(\u0026self.db).await?;\n        Ok(())\n    }\n\n    pub async fn mark_all_read(\u0026self, user_id: i32) -\u003e AppResult\u003cu64\u003e {\n        use sea_orm::sea_query::Expr;\n        let result = Notification::update_many()\n            .col_expr(notification::Column::IsRead, Expr::value(true))\n            .filter(notification::Column::UserId.eq(user_id))\n            .filter(notification::Column::IsRead.eq(false))\n            .exec(\u0026self.db)\n            .await?;\n        Ok(result.rows_affected)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    fn should_notify(user_id: i32, actor_id: i32) -\u003e bool {\n        user_id != actor_id\n    }\n\n    #[test]\n    fn test_no_self_notification() {\n        assert!(!should_notify(1, 1));\n    }\n\n    #[test]\n    fn test_notify_different_user() {\n        assert!(should_notify(1, 2));\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":59},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","post.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{post, Post, PostModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, ConnectionTrait, DatabaseConnection, EntityTrait,\n    FromQueryResult, PaginatorTrait, QueryFilter, QueryOrder, Statement,\n};\n\npub struct PostService {\n    db: DatabaseConnection,\n}\n\nimpl PostService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn list_by_forum(\n        \u0026self,\n        forum_id: i32,\n        page: u64,\n        per_page: u64,\n        sort: \u0026str,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        match sort {\n            \"top\" | \"hot\" =\u003e self.list_by_forum_raw(forum_id, page, per_page, sort).await,\n            _ =\u003e {\n                // \"new\" (default): use SeaORM paginator\n                let paginator = Post::find()\n                    .filter(post::Column::ForumId.eq(forum_id))\n                    .filter(post::Column::IsHidden.eq(false))\n                    .order_by_desc(post::Column::IsPinned)\n                    .order_by_desc(post::Column::CreatedAt)\n                    .paginate(\u0026self.db, per_page);\n\n                let total = paginator.num_items().await?;\n                let posts = paginator.fetch_page(page.saturating_sub(1)).await?;\n\n                Ok((posts, total))\n            }\n        }\n    }\n\n    async fn list_by_forum_raw(\n        \u0026self,\n        forum_id: i32,\n        page: u64,\n        per_page: u64,\n        sort: \u0026str,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        let offset = page.saturating_sub(1) * per_page;\n\n        let order_clause = match sort {\n            \"top\" =\u003e \"is_pinned DESC, (upvotes - downvotes) DESC, created_at DESC\",\n            \"hot\" =\u003e \"is_pinned DESC, \\\n                (upvotes - downvotes)::float / \\\n                POWER(EXTRACT(EPOCH FROM (NOW() - created_at)) / 3600.0 + 2.0, 1.5) DESC, \\\n                created_at DESC\",\n            _ =\u003e \"is_pinned DESC, created_at DESC\",\n        };\n\n        let count_sql = \"SELECT COUNT(*) as count FROM posts \\\n            WHERE forum_id = $1 AND is_hidden = FALSE\";\n\n        let search_sql = format!(\n            \"SELECT id, user_id, forum_id, title, content, upvotes, downvotes, \\\n                view_count, is_pinned, is_locked, is_hidden, created_at, updated_at \\\n                FROM posts \\\n                WHERE forum_id = $1 AND is_hidden = FALSE \\\n                ORDER BY {} \\\n                LIMIT $2 OFFSET $3\",\n            order_clause\n        );\n\n        let count_result = self\n            .db\n            .query_one(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                count_sql,\n                vec![forum_id.into()],\n            ))\n            .await?\n            .ok_or(AppError::Internal(anyhow::anyhow!(\"Count query failed\")))?;\n\n        let total: i64 = count_result.try_get_by_index(0)?;\n\n        let posts = PostModel::find_by_statement(Statement::from_sql_and_values(\n            sea_orm::DatabaseBackend::Postgres,\n            \u0026search_sql,\n            vec![forum_id.into(), (per_page as i64).into(), (offset as i64).into()],\n        ))\n        .all(\u0026self.db)\n        .await?;\n\n        Ok((posts, total as u64))\n    }\n\n    pub async fn get_by_id(\u0026self, id: i32) -\u003e AppResult\u003cPostModel\u003e {\n        Post::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    pub async fn create(\n        \u0026self,\n        user_id: i32,\n        forum_id: i32,\n        title: \u0026str,\n        content: \u0026str,\n    ) -\u003e AppResult\u003cPostModel\u003e {\n        let now = chrono::Utc::now().naive_utc();\n\n        let new_post = post::ActiveModel {\n            user_id: sea_orm::ActiveValue::Set(user_id),\n            forum_id: sea_orm::ActiveValue::Set(forum_id),\n            title: sea_orm::ActiveValue::Set(title.to_string()),\n            content: sea_orm::ActiveValue::Set(content.to_string()),\n            upvotes: sea_orm::ActiveValue::Set(0),\n            downvotes: sea_orm::ActiveValue::Set(0),\n            view_count: sea_orm::ActiveValue::Set(0),\n            is_pinned: sea_orm::ActiveValue::Set(false),\n            is_locked: sea_orm::ActiveValue::Set(false),\n            created_at: sea_orm::ActiveValue::Set(now),\n            updated_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let post = new_post.insert(\u0026self.db).await?;\n        Ok(post)\n    }\n\n    pub async fn update(\n        \u0026self,\n        id: i32,\n        user_id: i32,\n        title: \u0026str,\n        content: \u0026str,\n    ) -\u003e AppResult\u003cPostModel\u003e {\n        let existing = self.get_by_id(id).await?;\n        if existing.user_id != user_id {\n            return Err(AppError::Forbidden);\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: post::ActiveModel = existing.into();\n        active.title = sea_orm::ActiveValue::Set(title.to_string());\n        active.content = sea_orm::ActiveValue::Set(content.to_string());\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn delete(\u0026self, id: i32, user_id: i32) -\u003e AppResult\u003c()\u003e {\n        let existing = self.get_by_id(id).await?;\n        if existing.user_id != user_id {\n            return Err(AppError::Forbidden);\n        }\n\n        Post::delete_by_id(id).exec(\u0026self.db).await?;\n        Ok(())\n    }\n\n    pub async fn increment_view_count(\u0026self, id: i32) -\u003e AppResult\u003c()\u003e {\n        self.db\n            .execute(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \"UPDATE posts SET view_count = view_count + 1 WHERE id = $1\",\n                [id.into()],\n            ))\n            .await?;\n        Ok(())\n    }\n\n    pub async fn toggle_pin(\u0026self, id: i32) -\u003e AppResult\u003cPostModel\u003e {\n        let existing = self.get_by_id(id).await?;\n        let mut active: post::ActiveModel = existing.clone().into();\n        active.is_pinned = sea_orm::ActiveValue::Set(!existing.is_pinned);\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn toggle_lock(\u0026self, id: i32) -\u003e AppResult\u003cPostModel\u003e {\n        let existing = self.get_by_id(id).await?;\n        let mut active: post::ActiveModel = existing.clone().into();\n        active.is_locked = sea_orm::ActiveValue::Set(!existing.is_locked);\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn search(\n        \u0026self,\n        query: \u0026str,\n        forum_id: Option\u003ci32\u003e,\n        page: u64,\n        per_page: u64,\n        sort: \u0026str,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        let offset = page.saturating_sub(1) * per_page;\n\n        let order_clause = match sort {\n            \"new\" =\u003e \"created_at DESC\",\n            \"top\" =\u003e \"(upvotes - downvotes) DESC, created_at DESC\",\n            _ =\u003e \"ts_rank(search_vector, plainto_tsquery('english', $1)) DESC\",\n        };\n\n        // Build parameterized queries  all values passed via bind params\n        let (count_sql, search_sql, values) = if let Some(fid) = forum_id {\n            let count = \"SELECT COUNT(*) as count FROM posts \\\n                WHERE search_vector @@ plainto_tsquery('english', $1) \\\n                AND is_hidden = FALSE AND forum_id = $2\";\n            let search = format!(\n                \"SELECT id, user_id, forum_id, title, content, upvotes, downvotes, \\\n                    view_count, is_pinned, is_locked, is_hidden, created_at, updated_at \\\n                    FROM posts \\\n                    WHERE search_vector @@ plainto_tsquery('english', $1) \\\n                    AND is_hidden = FALSE AND forum_id = $2 \\\n                    ORDER BY {} \\\n                    LIMIT $3 OFFSET $4\",\n                order_clause\n            );\n            let vals: Vec\u003csea_orm::Value\u003e = vec![\n                query.into(),\n                fid.into(),\n                (per_page as i64).into(),\n                (offset as i64).into(),\n            ];\n            (count.to_string(), search, vals)\n        } else {\n            let count = \"SELECT COUNT(*) as count FROM posts \\\n                WHERE search_vector @@ plainto_tsquery('english', $1) \\\n                AND is_hidden = FALSE\";\n            let search = format!(\n                \"SELECT id, user_id, forum_id, title, content, upvotes, downvotes, \\\n                    view_count, is_pinned, is_locked, is_hidden, created_at, updated_at \\\n                    FROM posts \\\n                    WHERE search_vector @@ plainto_tsquery('english', $1) \\\n                    AND is_hidden = FALSE \\\n                    ORDER BY {} \\\n                    LIMIT $2 OFFSET $3\",\n                order_clause\n            );\n            let vals: Vec\u003csea_orm::Value\u003e = vec![\n                query.into(),\n                (per_page as i64).into(),\n                (offset as i64).into(),\n            ];\n            (count.to_string(), search, vals)\n        };\n\n        // Count total matching rows\n        let count_result = self\n            .db\n            .query_one(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \u0026count_sql,\n                values[..if forum_id.is_some() { 2 } else { 1 }].to_vec(),\n            ))\n            .await?\n            .ok_or(AppError::Internal(anyhow::anyhow!(\"Count query failed\")))?;\n\n        let total: i64 = count_result.try_get_by_index(0)?;\n\n        // Fetch paginated results\n        let posts = PostModel::find_by_statement(Statement::from_sql_and_values(\n            sea_orm::DatabaseBackend::Postgres,\n            \u0026search_sql,\n            values,\n        ))\n        .all(\u0026self.db)\n        .await?;\n\n        Ok((posts, total as u64))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    fn get_order_clause(sort: \u0026str) -\u003e \u0026str {\n        match sort {\n            \"top\" =\u003e \"is_pinned DESC, (upvotes - downvotes) DESC, created_at DESC\",\n            \"hot\" =\u003e \"is_pinned DESC, (upvotes - downvotes)::float / POWER(EXTRACT(EPOCH FROM (NOW() - created_at)) / 3600.0 + 2.0, 1.5) DESC, created_at DESC\",\n            _ =\u003e \"is_pinned DESC, created_at DESC\",\n        }\n    }\n\n    fn calculate_offset(page: u64, per_page: u64) -\u003e u64 {\n        page.saturating_sub(1) * per_page\n    }\n\n    #[test]\n    fn test_sort_top_prioritizes_score() {\n        let clause = get_order_clause(\"top\");\n        assert!(clause.contains(\"(upvotes - downvotes)\"));\n        assert!(clause.starts_with(\"is_pinned DESC\"));\n    }\n\n    #[test]\n    fn test_sort_hot_uses_time_decay() {\n        let clause = get_order_clause(\"hot\");\n        assert!(clause.contains(\"POWER\"));\n        assert!(clause.contains(\"EXTRACT(EPOCH\"));\n    }\n\n    #[test]\n    fn test_pagination_first_page() {\n        assert_eq!(calculate_offset(1, 20), 0);\n    }\n\n    #[test]\n    fn test_pagination_second_page() {\n        assert_eq!(calculate_offset(2, 20), 20);\n    }\n\n    #[test]\n    fn test_pagination_zero_page_safe() {\n        assert_eq!(calculate_offset(0, 20), 0);\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":140},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","report.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{comment, post, report, Comment, Post, Report, ReportModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\n\npub struct ReportService {\n    db: DatabaseConnection,\n}\n\nimpl ReportService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn create_report(\n        \u0026self,\n        reporter_id: i32,\n        target_type: \u0026str,\n        target_id: i32,\n        reason: \u0026str,\n        description: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cReportModel\u003e {\n        // Validate target_type\n        if target_type != \"post\" \u0026\u0026 target_type != \"comment\" {\n            return Err(AppError::Validation(\n                \"target_type must be 'post' or 'comment'\".to_string(),\n            ));\n        }\n\n        // Validate reason\n        let valid_reasons = [\"spam\", \"harassment\", \"inappropriate\", \"other\"];\n        if !valid_reasons.contains(\u0026reason) {\n            return Err(AppError::Validation(format!(\n                \"reason must be one of: {}\",\n                valid_reasons.join(\", \")\n            )));\n        }\n\n        // Verify target exists\n        match target_type {\n            \"post\" =\u003e {\n                Post::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::Validation(\"Post not found\".to_string()))?;\n            }\n            \"comment\" =\u003e {\n                Comment::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::Validation(\"Comment not found\".to_string()))?;\n            }\n            _ =\u003e unreachable!(),\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n        let model = report::ActiveModel {\n            reporter_id: sea_orm::ActiveValue::Set(reporter_id),\n            target_type: sea_orm::ActiveValue::Set(target_type.to_string()),\n            target_id: sea_orm::ActiveValue::Set(target_id),\n            reason: sea_orm::ActiveValue::Set(reason.to_string()),\n            description: sea_orm::ActiveValue::Set(description.map(|s| s.to_string())),\n            status: sea_orm::ActiveValue::Set(\"pending\".to_string()),\n            created_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let saved = model.insert(\u0026self.db).await?;\n        Ok(saved)\n    }\n\n    pub async fn list_reports(\n        \u0026self,\n        status: Option\u003c\u0026str\u003e,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cReportModel\u003e, u64)\u003e {\n        let mut query = Report::find();\n\n        if let Some(s) = status {\n            query = query.filter(report::Column::Status.eq(s));\n        }\n\n        let paginator = query\n            .order_by_desc(report::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let reports = paginator.fetch_page(page.saturating_sub(1)).await?;\n        Ok((reports, total))\n    }\n\n    pub async fn resolve(\n        \u0026self,\n        report_id: i32,\n        admin_id: i32,\n        action: \u0026str,\n    ) -\u003e AppResult\u003cReportModel\u003e {\n        let valid_actions = [\"hide\", \"delete\", \"dismiss\"];\n        if !valid_actions.contains(\u0026action) {\n            return Err(AppError::Validation(format!(\n                \"action must be one of: {}\",\n                valid_actions.join(\", \")\n            )));\n        }\n\n        let existing = Report::find_by_id(report_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        if existing.status != \"pending\" {\n            return Err(AppError::Validation(\n                \"Report is already resolved\".to_string(),\n            ));\n        }\n\n        // Apply action on the target\n        match action {\n            \"hide\" =\u003e {\n                self.hide_target(\u0026existing.target_type, existing.target_id)\n                    .await?;\n            }\n            \"delete\" =\u003e {\n                self.delete_target(\u0026existing.target_type, existing.target_id)\n                    .await?;\n            }\n            \"dismiss\" =\u003e {}\n            _ =\u003e unreachable!(),\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n        let mut active: report::ActiveModel = existing.into();\n        active.status = sea_orm::ActiveValue::Set(if action == \"dismiss\" {\n            \"dismissed\".to_string()\n        } else {\n            \"resolved\".to_string()\n        });\n        active.resolved_by = sea_orm::ActiveValue::Set(Some(admin_id));\n        active.resolved_at = sea_orm::ActiveValue::Set(Some(now));\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    async fn hide_target(\u0026self, target_type: \u0026str, target_id: i32) -\u003e AppResult\u003c()\u003e {\n        match target_type {\n            \"post\" =\u003e {\n                let existing = Post::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::NotFound)?;\n                let mut active: post::ActiveModel = existing.into();\n                active.is_hidden = sea_orm::ActiveValue::Set(true);\n                active.update(\u0026self.db).await?;\n            }\n            \"comment\" =\u003e {\n                let existing = Comment::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::NotFound)?;\n                let mut active: comment::ActiveModel = existing.into();\n                active.is_hidden = sea_orm::ActiveValue::Set(true);\n                active.update(\u0026self.db).await?;\n            }\n            _ =\u003e {}\n        }\n        Ok(())\n    }\n\n    async fn delete_target(\u0026self, target_type: \u0026str, target_id: i32) -\u003e AppResult\u003c()\u003e {\n        match target_type {\n            \"post\" =\u003e {\n                Post::delete_by_id(target_id).exec(\u0026self.db).await?;\n            }\n            \"comment\" =\u003e {\n                Comment::delete_by_id(target_id).exec(\u0026self.db).await?;\n            }\n            _ =\u003e {}\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":99},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","tag.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::models::{post_tag, tag, PostModel, Tag, TagModel};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, ConnectionTrait, DatabaseConnection, EntityTrait,\n    FromQueryResult, ModelTrait, QueryFilter, QueryOrder, Statement, Set,\n};\n\npub struct TagService {\n    db: DatabaseConnection,\n}\n\nimpl TagService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    /// Get or create tags by name. Returns all matching TagModels.\n    pub async fn get_or_create_tags(\u0026self, names: Vec\u003cString\u003e) -\u003e AppResult\u003cVec\u003cTagModel\u003e\u003e {\n        let mut result = Vec::new();\n\n        for name in names {\n            let name = name.trim().to_lowercase();\n            if name.is_empty() || name.len() \u003e 30 {\n                continue;\n            }\n\n            let slug = name\n                .chars()\n                .map(|c| if c.is_alphanumeric() { c } else { '-' })\n                .collect::\u003cString\u003e();\n\n            // Try to find existing tag\n            let existing = Tag::find()\n                .filter(tag::Column::Slug.eq(\u0026slug))\n                .one(\u0026self.db)\n                .await?;\n\n            if let Some(tag) = existing {\n                result.push(tag);\n            } else {\n                let now = chrono::Utc::now().naive_utc();\n                let new_tag = tag::ActiveModel {\n                    name: sea_orm::ActiveValue::Set(name),\n                    slug: sea_orm::ActiveValue::Set(slug),\n                    created_at: sea_orm::ActiveValue::Set(now),\n                    ..Default::default()\n                };\n                let tag = new_tag.insert(\u0026self.db).await?;\n                result.push(tag);\n            }\n        }\n\n        Ok(result)\n    }\n\n    /// Replace all tags for a post.\n    pub async fn set_post_tags(\u0026self, post_id: i32, tag_ids: Vec\u003ci32\u003e) -\u003e AppResult\u003c()\u003e {\n        // Delete existing tags\n        self.db\n            .execute(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \"DELETE FROM post_tags WHERE post_id = $1\",\n                vec![post_id.into()],\n            ))\n            .await?;\n\n        // Insert new tags\n        for tag_id in tag_ids {\n            let pt = post_tag::ActiveModel {\n                post_id: sea_orm::ActiveValue::Set(post_id),\n                tag_id: sea_orm::ActiveValue::Set(tag_id),\n                ..Default::default()\n            };\n            pt.insert(\u0026self.db).await?;\n        }\n\n        Ok(())\n    }\n\n    /// Get tags for a single post.\n    pub async fn get_post_tags(\u0026self, post_id: i32) -\u003e AppResult\u003cVec\u003cTagModel\u003e\u003e {\n        let tags = TagModel::find_by_statement(Statement::from_sql_and_values(\n            sea_orm::DatabaseBackend::Postgres,\n            \"SELECT t.id, t.name, t.slug, t.created_at \\\n                FROM tags t \\\n                INNER JOIN post_tags pt ON pt.tag_id = t.id \\\n                WHERE pt.post_id = $1 \\\n                ORDER BY t.name\",\n            vec![post_id.into()],\n        ))\n        .all(\u0026self.db)\n        .await?;\n\n        Ok(tags)\n    }\n\n    /// Get tags for multiple posts (batch).\n    pub async fn get_tags_for_posts(\n        \u0026self,\n        post_ids: \u0026[i32],\n    ) -\u003e AppResult\u003cstd::collections::HashMap\u003ci32, Vec\u003cString\u003e\u003e\u003e {\n        use std::collections::HashMap;\n\n        if post_ids.is_empty() {\n            return Ok(HashMap::new());\n        }\n\n        // Build $1, $2, ... placeholders\n        let placeholders: Vec\u003cString\u003e = post_ids\n            .iter()\n            .enumerate()\n            .map(|(i, _)| format!(\"${}\", i + 1))\n            .collect();\n        let sql = format!(\n            \"SELECT pt.post_id, t.name \\\n                FROM post_tags pt \\\n                INNER JOIN tags t ON t.id = pt.tag_id \\\n                WHERE pt.post_id IN ({}) \\\n                ORDER BY t.name\",\n            placeholders.join(\", \")\n        );\n\n        let values: Vec\u003csea_orm::Value\u003e = post_ids.iter().map(|\u0026id| id.into()).collect();\n\n        let rows = self\n            .db\n            .query_all(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \u0026sql,\n                values,\n            ))\n            .await?;\n\n        let mut map: HashMap\u003ci32, Vec\u003cString\u003e\u003e = HashMap::new();\n        for row in rows {\n            let pid: i32 = row.try_get_by_index(0)?;\n            let name: String = row.try_get_by_index(1)?;\n            map.entry(pid).or_default().push(name);\n        }\n\n        Ok(map)\n    }\n\n    /// List all tags.\n    pub async fn list_tags(\u0026self) -\u003e AppResult\u003cVec\u003cTagModel\u003e\u003e {\n        let tags = Tag::find()\n            .order_by_asc(tag::Column::Name)\n            .all(\u0026self.db)\n            .await?;\n        Ok(tags)\n    }\n\n    /// Get posts by tag slug with pagination.\n    pub async fn get_posts_by_tag(\n        \u0026self,\n        tag_slug: \u0026str,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        let offset = page.saturating_sub(1) * per_page;\n\n        // Look up tag\n        let tag = Tag::find()\n            .filter(tag::Column::Slug.eq(tag_slug))\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        // Count\n        let count_result = self\n            .db\n            .query_one(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \"SELECT COUNT(*) as count FROM posts p \\\n                    INNER JOIN post_tags pt ON pt.post_id = p.id \\\n                    WHERE pt.tag_id = $1 AND p.is_hidden = FALSE\",\n                vec![tag.id.into()],\n            ))\n            .await?\n            .ok_or(AppError::Internal(anyhow::anyhow!(\"Count query failed\")))?;\n\n        let total: i64 = count_result.try_get_by_index(0)?;\n\n        // Fetch\n        let posts = PostModel::find_by_statement(Statement::from_sql_and_values(\n            sea_orm::DatabaseBackend::Postgres,\n            \"SELECT p.id, p.user_id, p.forum_id, p.title, p.content, p.upvotes, p.downvotes, \\\n                p.view_count, p.is_pinned, p.is_locked, p.is_hidden, p.created_at, p.updated_at \\\n                FROM posts p \\\n                INNER JOIN post_tags pt ON pt.post_id = p.id \\\n                WHERE pt.tag_id = $1 AND p.is_hidden = FALSE \\\n                ORDER BY p.created_at DESC \\\n                LIMIT $2 OFFSET $3\",\n            vec![tag.id.into(), (per_page as i64).into(), (offset as i64).into()],\n        ))\n        .all(\u0026self.db)\n        .await?;\n\n        Ok((posts, total as u64))\n    }\n\n    pub async fn create_tag(\u0026self, name: \u0026str) -\u003e AppResult\u003cTagModel\u003e {\n        let name = name.trim().to_lowercase();\n        let slug = name.chars().map(|c| if c.is_alphanumeric() { c } else { '-' }).collect::\u003cString\u003e();\n\n        let existing = Tag::find().filter(tag::Column::Slug.eq(\u0026slug)).one(\u0026self.db).await?;\n        if existing.is_some() {\n            return Err(AppError::Conflict(\"Tag already exists\".to_string()));\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n        let new_tag = tag::ActiveModel {\n            name: Set(name),\n            slug: Set(slug),\n            created_at: Set(now),\n            ..Default::default()\n        };\n        Ok(new_tag.insert(\u0026self.db).await?)\n    }\n\n    pub async fn update_tag(\u0026self, id: i32, name: \u0026str) -\u003e AppResult\u003cTagModel\u003e {\n        let tag = Tag::find_by_id(id).one(\u0026self.db).await?.ok_or(AppError::NotFound)?;\n        let name = name.trim().to_lowercase();\n        let slug = name.chars().map(|c| if c.is_alphanumeric() { c } else { '-' }).collect::\u003cString\u003e();\n\n        let mut active: tag::ActiveModel = tag.into();\n        active.name = Set(name);\n        active.slug = Set(slug);\n        Ok(active.update(\u0026self.db).await?)\n    }\n\n    pub async fn delete_tag(\u0026self, id: i32) -\u003e AppResult\u003c()\u003e {\n        let tag = Tag::find_by_id(id).one(\u0026self.db).await?.ok_or(AppError::NotFound)?;\n        tag.delete(\u0026self.db).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":127},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","upload.rs"],"content":"use crate::error::{AppError, AppResult};\nuse std::path::Path;\nuse tokio::fs;\nuse uuid::Uuid;\n\n#[derive(Clone)]\npub struct UploadConfig {\n    pub upload_dir: String,\n}\n\nconst MAX_FILE_SIZE: usize = 5 * 1024 * 1024; // 5 MB\nconst ALLOWED_CONTENT_TYPES: \u0026[\u0026str] = \u0026[\"image/jpeg\", \"image/png\", \"image/gif\", \"image/webp\"];\n\n/// Validate file magic bytes match the declared content type.\nfn validate_magic_bytes(data: \u0026[u8], content_type: \u0026str) -\u003e bool {\n    match content_type {\n        \"image/jpeg\" =\u003e data.len() \u003e= 3 \u0026\u0026 data[..3] == [0xFF, 0xD8, 0xFF],\n        \"image/png\" =\u003e data.len() \u003e= 4 \u0026\u0026 data[..4] == [0x89, 0x50, 0x4E, 0x47],\n        \"image/gif\" =\u003e data.len() \u003e= 4 \u0026\u0026 data[..4] == [0x47, 0x49, 0x46, 0x38],\n        \"image/webp\" =\u003e {\n            data.len() \u003e= 12\n                \u0026\u0026 data[..4] == [0x52, 0x49, 0x46, 0x46]\n                \u0026\u0026 data[8..12] == [0x57, 0x45, 0x42, 0x50]\n        }\n        _ =\u003e false,\n    }\n}\n\npub struct UploadService;\n\nimpl UploadService {\n    /// Save an uploaded file to disk.\n    /// Returns the public URL path (e.g., `/uploads/avatars/uuid.jpg`).\n    pub async fn save_file(\n        config: \u0026UploadConfig,\n        data: \u0026[u8],\n        content_type: \u0026str,\n        subdirectory: \u0026str,\n    ) -\u003e AppResult\u003cString\u003e {\n        // Validate size\n        if data.len() \u003e MAX_FILE_SIZE {\n            return Err(AppError::PayloadTooLarge);\n        }\n\n        // Validate content type\n        if !ALLOWED_CONTENT_TYPES.contains(\u0026content_type) {\n            return Err(AppError::Validation(format!(\n                \"Unsupported file type: {}. Allowed: jpeg, png, gif, webp\",\n                content_type\n            )));\n        }\n\n        // Validate magic bytes match content type\n        if !validate_magic_bytes(data, content_type) {\n            return Err(AppError::Validation(\n                \"File content does not match declared content type\".to_string(),\n            ));\n        }\n\n        let ext = match content_type {\n            \"image/jpeg\" =\u003e \"jpg\",\n            \"image/png\" =\u003e \"png\",\n            \"image/gif\" =\u003e \"gif\",\n            \"image/webp\" =\u003e \"webp\",\n            _ =\u003e return Err(AppError::Validation(\"Unsupported file type\".to_string())),\n        };\n\n        let filename = format!(\"{}.{}\", Uuid::new_v4(), ext);\n        let dir = Path::new(\u0026config.upload_dir).join(subdirectory);\n\n        fs::create_dir_all(\u0026dir)\n            .await\n            .map_err(|e| AppError::Validation(format!(\"Failed to create upload directory: {}\", e)))?;\n\n        let file_path = dir.join(\u0026filename);\n        fs::write(\u0026file_path, data)\n            .await\n            .map_err(|e| AppError::Validation(format!(\"Failed to write file: {}\", e)))?;\n\n        Ok(format!(\"/uploads/{}/{}\", subdirectory, filename))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn jpeg_magic_bytes_valid() {\n        let data = [0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10];\n        assert!(validate_magic_bytes(\u0026data, \"image/jpeg\"));\n    }\n\n    #[test]\n    fn png_magic_bytes_valid() {\n        let data = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A];\n        assert!(validate_magic_bytes(\u0026data, \"image/png\"));\n    }\n\n    #[test]\n    fn gif_magic_bytes_valid() {\n        let data = [0x47, 0x49, 0x46, 0x38, 0x39, 0x61];\n        assert!(validate_magic_bytes(\u0026data, \"image/gif\"));\n    }\n\n    #[test]\n    fn webp_magic_bytes_valid() {\n        let data = [\n            0x52, 0x49, 0x46, 0x46, // RIFF\n            0x00, 0x00, 0x00, 0x00, // size\n            0x57, 0x45, 0x42, 0x50, // WEBP\n        ];\n        assert!(validate_magic_bytes(\u0026data, \"image/webp\"));\n    }\n\n    #[test]\n    fn wrong_magic_bytes_rejected() {\n        let png_data = [0x89, 0x50, 0x4E, 0x47];\n        assert!(!validate_magic_bytes(\u0026png_data, \"image/jpeg\"));\n    }\n\n    #[test]\n    fn empty_data_rejected() {\n        assert!(!validate_magic_bytes(\u0026[], \"image/jpeg\"));\n        assert!(!validate_magic_bytes(\u0026[], \"image/png\"));\n    }\n\n    #[test]\n    fn unknown_content_type_rejected() {\n        let data = [0xFF, 0xD8, 0xFF];\n        assert!(!validate_magic_bytes(\u0026data, \"application/pdf\"));\n    }\n\n    #[test]\n    fn too_short_data_rejected() {\n        assert!(!validate_magic_bytes(\u0026[0xFF, 0xD8], \"image/jpeg\"));\n        assert!(!validate_magic_bytes(\u0026[0x89, 0x50, 0x4E], \"image/png\"));\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":16,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":17,"address":[],"length":0,"stats":{"Line":1152921504606846976}},{"line":18,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":19,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":20,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":21,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":22,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":23,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":25,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}}],"covered":10,"coverable":36},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","user.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{user, User, UserModel},\n};\nuse sea_orm::{ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, QueryFilter};\n\npub struct UserService {\n    db: DatabaseConnection,\n}\n\nimpl UserService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn get_by_username(\u0026self, username: \u0026str) -\u003e AppResult\u003cUserModel\u003e {\n        User::find()\n            .filter(user::Column::Username.eq(username))\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    pub async fn update_profile(\n        \u0026self,\n        user_id: i32,\n        bio: Option\u003cString\u003e,\n        avatar_url: Option\u003cString\u003e,\n    ) -\u003e AppResult\u003cUserModel\u003e {\n        let existing = User::find_by_id(user_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: user::ActiveModel = existing.into();\n        active.bio = sea_orm::ActiveValue::Set(bio);\n        active.avatar_url = sea_orm::ActiveValue::Set(avatar_url);\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    /// Update only the avatar URL (used by upload handler).\n    pub async fn update_avatar_url(\u0026self, user_id: i32, url: \u0026str) -\u003e AppResult\u003cUserModel\u003e {\n        let existing = User::find_by_id(user_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: user::ActiveModel = existing.into();\n        active.avatar_url = sea_orm::ActiveValue::Set(Some(url.to_string()));\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n}\n","traces":[{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":30},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","vote.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{vote, Comment, Post, Vote, VoteModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, ConnectionTrait, DatabaseConnection, EntityTrait, QueryFilter,\n    Statement,\n};\n\npub struct VoteService {\n    db: DatabaseConnection,\n}\n\nimpl VoteService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn vote(\n        \u0026self,\n        user_id: i32,\n        target_type: \u0026str,\n        target_id: i32,\n        value: i16,\n    ) -\u003e AppResult\u003cVoteModel\u003e {\n        if value != 1 \u0026\u0026 value != -1 {\n            return Err(AppError::Validation(\n                \"Vote value must be 1 or -1\".to_string(),\n            ));\n        }\n\n        // Verify target exists\n        match target_type {\n            \"post\" =\u003e {\n                Post::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::NotFound)?;\n            }\n            \"comment\" =\u003e {\n                Comment::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::NotFound)?;\n            }\n            _ =\u003e return Err(AppError::Validation(\"Invalid target type\".to_string())),\n        }\n\n        // Check for existing vote\n        let existing = Vote::find()\n            .filter(vote::Column::UserId.eq(user_id))\n            .filter(vote::Column::TargetType.eq(target_type))\n            .filter(vote::Column::TargetId.eq(target_id))\n            .one(\u0026self.db)\n            .await?;\n\n        let old_value: i16 = existing.as_ref().map_or(0, |v| v.value);\n\n        let result = if let Some(existing_vote) = existing {\n            if existing_vote.value == value {\n                // Same vote again  remove it (toggle off)\n                Vote::delete_by_id(existing_vote.id).exec(\u0026self.db).await?;\n                self.update_counters(target_type, target_id, -old_value)\n                    .await?;\n                // Return a synthetic model indicating removal\n                return Ok(VoteModel {\n                    id: 0,\n                    user_id,\n                    target_type: target_type.to_string(),\n                    target_id,\n                    value: 0,\n                    created_at: chrono::Utc::now().naive_utc(),\n                });\n            }\n            // Different vote  update\n            let mut active: vote::ActiveModel = existing_vote.into();\n            active.value = sea_orm::ActiveValue::Set(value);\n            let updated = active.update(\u0026self.db).await?;\n            // Swing counters: remove old, add new\n            self.update_counters(target_type, target_id, value - old_value)\n                .await?;\n            updated\n        } else {\n            // New vote\n            let now = chrono::Utc::now().naive_utc();\n            let new_vote = vote::ActiveModel {\n                user_id: sea_orm::ActiveValue::Set(user_id),\n                target_type: sea_orm::ActiveValue::Set(target_type.to_string()),\n                target_id: sea_orm::ActiveValue::Set(target_id),\n                value: sea_orm::ActiveValue::Set(value),\n                created_at: sea_orm::ActiveValue::Set(now),\n                ..Default::default()\n            };\n            let inserted = new_vote.insert(\u0026self.db).await?;\n            self.update_counters(target_type, target_id, value).await?;\n            inserted\n        };\n\n        Ok(result)\n    }\n\n    async fn update_counters(\n        \u0026self,\n        target_type: \u0026str,\n        target_id: i32,\n        delta: i16,\n    ) -\u003e AppResult\u003c()\u003e {\n        let table = match target_type {\n            \"post\" =\u003e \"posts\",\n            \"comment\" =\u003e \"comments\",\n            _ =\u003e return Ok(()),\n        };\n\n        let (col_up, col_down) = if delta \u003e 0 {\n            (\"upvotes\", format!(\"upvotes + {delta}\"))\n        } else {\n            (\"downvotes\", format!(\"downvotes + {}\", -delta))\n        };\n\n        // For vote swing (e.g. -1 to +1, delta=2), handle both columns\n        if delta.abs() \u003e 1 {\n            // Swing: delta=2 means +1 upvote, -1 downvote; delta=-2 means reverse\n            let sql = if delta \u003e 0 {\n                format!(\n                    \"UPDATE {table} SET upvotes = upvotes + 1, downvotes = GREATEST(downvotes - 1, 0) WHERE id = $1\"\n                )\n            } else {\n                format!(\n                    \"UPDATE {table} SET downvotes = downvotes + 1, upvotes = GREATEST(upvotes - 1, 0) WHERE id = $1\"\n                )\n            };\n            self.db\n                .execute(Statement::from_sql_and_values(\n                    sea_orm::DatabaseBackend::Postgres,\n                    \u0026sql,\n                    [target_id.into()],\n                ))\n                .await?;\n        } else {\n            let sql = format!(\"UPDATE {table} SET {col_up} = {col_down} WHERE id = $1\");\n            self.db\n                .execute(Statement::from_sql_and_values(\n                    sea_orm::DatabaseBackend::Postgres,\n                    \u0026sql,\n                    [target_id.into()],\n                ))\n                .await?;\n        }\n\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn validate_vote_value_accepts_one() {\n        let value: i16 = 1;\n        assert!(value == 1 || value == -1);\n    }\n\n    #[test]\n    fn validate_vote_value_accepts_negative_one() {\n        let value: i16 = -1;\n        assert!(value == 1 || value == -1);\n    }\n\n    #[test]\n    fn validate_vote_value_rejects_zero() {\n        let value: i16 = 0;\n        assert!(!(value == 1 || value == -1));\n    }\n\n    #[test]\n    fn validate_vote_value_rejects_two() {\n        let value: i16 = 2;\n        assert!(!(value == 1 || value == -1));\n    }\n\n    #[test]\n    fn toggle_same_vote_returns_zero() {\n        let old_value: i16 = 1;\n        let new_value: i16 = 1;\n        let result = if old_value == new_value { 0 } else { new_value };\n        assert_eq!(result, 0);\n    }\n\n    #[test]\n    fn swing_vote_calculates_delta() {\n        let old_value: i16 = -1;\n        let new_value: i16 = 1;\n        let delta = new_value - old_value;\n        assert_eq!(delta, 2);\n    }\n\n    #[test]\n    fn new_vote_delta_is_value() {\n        let old_value: i16 = 0;\n        let new_value: i16 = 1;\n        let delta = new_value - old_value;\n        assert_eq!(delta, 1);\n    }\n\n    #[test]\n    fn remove_vote_delta_is_negative() {\n        let old_value: i16 = 1;\n        let new_value: i16 = 0;\n        let delta = new_value - old_value;\n        assert_eq!(delta, -1);\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":78},{"path":["C:","\\","Users","yimo","Codes","xjy","src","utils","jwt.rs"],"content":"use anyhow::Result;\nuse jsonwebtoken::{decode, encode, DecodingKey, EncodingKey, Header, Validation};\nuse serde::{Deserialize, Serialize};\nuse std::sync::OnceLock;\n\nstatic JWT_CONFIG: OnceLock\u003ccrate::config::jwt::JwtConfig\u003e = OnceLock::new();\n\n/// Initialize JWT config from environment. Must be called once at startup.\npub fn init_jwt_config(config: crate::config::jwt::JwtConfig) -\u003e Result\u003c()\u003e {\n    JWT_CONFIG\n        .set(config)\n        .map_err(|_| anyhow::anyhow!(\"JWT config already initialized\"))?;\n    Ok(())\n}\n\nfn get_config() -\u003e \u0026'static crate::config::jwt::JwtConfig {\n    JWT_CONFIG\n        .get()\n        .expect(\"JWT config not initialized  call init_jwt_config() at startup\")\n}\n\n#[derive(Debug, Serialize, Deserialize)]\npub struct Claims {\n    pub sub: String, // user_id\n    pub exp: usize,  // expiration time\n    pub iat: usize,  // issued at\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub token_type: Option\u003cString\u003e, // \"access\" or \"refresh\"\n}\n\npub fn encode_access_token(user_id: \u0026str) -\u003e Result\u003cString\u003e {\n    let config = get_config();\n    let now = chrono::Utc::now().timestamp() as usize;\n    let claims = Claims {\n        sub: user_id.to_owned(),\n        exp: now + config.access_token_expiry as usize,\n        iat: now,\n        token_type: Some(\"access\".to_string()),\n    };\n\n    encode(\n        \u0026Header::default(),\n        \u0026claims,\n        \u0026EncodingKey::from_secret(config.secret.as_bytes()),\n    )\n    .map_err(|e| anyhow::anyhow!(\"Failed to encode access token: {}\", e))\n}\n\npub fn encode_refresh_token(user_id: \u0026str) -\u003e Result\u003cString\u003e {\n    let config = get_config();\n    let now = chrono::Utc::now().timestamp() as usize;\n    let claims = Claims {\n        sub: user_id.to_owned(),\n        exp: now + config.refresh_token_expiry as usize,\n        iat: now,\n        token_type: Some(\"refresh\".to_string()),\n    };\n\n    encode(\n        \u0026Header::default(),\n        \u0026claims,\n        \u0026EncodingKey::from_secret(config.secret.as_bytes()),\n    )\n    .map_err(|e| anyhow::anyhow!(\"Failed to encode refresh token: {}\", e))\n}\n\npub fn decode_jwt(token: \u0026str) -\u003e Result\u003cClaims\u003e {\n    let config = get_config();\n\n    decode::\u003cClaims\u003e(\n        token,\n        \u0026DecodingKey::from_secret(config.secret.as_bytes()),\n        \u0026Validation::default(),\n    )\n    .map(|data| data.claims)\n    .map_err(|e| anyhow::anyhow!(\"Failed to decode JWT: {}\", e))\n}\n\n#[allow(dead_code)]\npub fn is_refresh_token(claims: \u0026Claims) -\u003e bool {\n    matches!(claims.token_type.as_deref(), Some(\"refresh\"))\n}\n\n#[allow(dead_code)]\npub fn is_access_token(claims: \u0026Claims) -\u003e bool {\n    matches!(claims.token_type.as_deref(), Some(\"access\"))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::Once;\n\n    static INIT: Once = Once::new();\n\n    fn ensure_config() {\n        INIT.call_once(|| {\n            std::env::set_var(\"JWT_SECRET\", \"a_very_long_secret_key_that_is_at_least_32_chars\");\n            let config = crate::config::jwt::JwtConfig::from_env().unwrap();\n            let _ = init_jwt_config(config);\n        });\n    }\n\n    #[test]\n    fn encode_decode_round_trip() {\n        ensure_config();\n        let token = encode_access_token(\"42\").unwrap();\n        let claims = decode_jwt(\u0026token).unwrap();\n        assert_eq!(claims.sub, \"42\");\n        assert!(claims.exp \u003e claims.iat);\n        assert_eq!(claims.token_type, Some(\"access\".to_string()));\n    }\n\n    #[test]\n    fn refresh_token_encode_decode() {\n        ensure_config();\n        let token = encode_refresh_token(\"42\").unwrap();\n        let claims = decode_jwt(\u0026token).unwrap();\n        assert_eq!(claims.sub, \"42\");\n        assert!(claims.exp \u003e claims.iat);\n        assert_eq!(claims.token_type, Some(\"refresh\".to_string()));\n    }\n\n    #[test]\n    fn tampered_token_fails() {\n        ensure_config();\n        let token = encode_access_token(\"42\").unwrap();\n        // Flip a character in the middle of the token\n        let mut chars: Vec\u003cchar\u003e = token.chars().collect();\n        let mid = chars.len() / 2;\n        chars[mid] = if chars[mid] == 'A' { 'B' } else { 'A' };\n        let tampered: String = chars.into_iter().collect();\n        assert!(decode_jwt(\u0026tampered).is_err());\n    }\n\n    #[test]\n    fn expired_token_fails() {\n        ensure_config();\n        let config = get_config();\n        let now = chrono::Utc::now().timestamp() as usize;\n        let claims = Claims {\n            sub: \"42\".to_string(),\n            exp: now - 3600, // expired 1 hour ago\n            iat: now - 7200,\n            token_type: Some(\"access\".to_string()),\n        };\n        let token = encode(\n            \u0026Header::default(),\n            \u0026claims,\n            \u0026EncodingKey::from_secret(config.secret.as_bytes()),\n        )\n        .unwrap();\n        assert!(decode_jwt(\u0026token).is_err());\n    }\n\n    #[test]\n    fn empty_token_fails() {\n        ensure_config();\n        assert!(decode_jwt(\"\").is_err());\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":10,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":11,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":12,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":13,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":16,"address":[],"length":0,"stats":{"Line":648518346341351424}},{"line":17,"address":[],"length":0,"stats":{"Line":1297036692682702848}},{"line":31,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":32,"address":[],"length":0,"stats":{"Line":288230376151711744}},{"line":33,"address":[],"length":0,"stats":{"Line":288230376151711744}},{"line":35,"address":[],"length":0,"stats":{"Line":432345564227567616}},{"line":36,"address":[],"length":0,"stats":{"Line":288230376151711744}},{"line":38,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":42,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":43,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":44,"address":[],"length":0,"stats":{"Line":288230376151711744}},{"line":46,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":49,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":50,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":51,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":53,"address":[],"length":0,"stats":{"Line":216172782113783808}},{"line":54,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":56,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":60,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":61,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":62,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":64,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":67,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":68,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":71,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":72,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":73,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":75,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":76,"address":[],"length":0,"stats":{"Line":576460752303423488}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":34,"coverable":38},{"path":["C:","\\","Users","yimo","Codes","xjy","src","utils","mod.rs"],"content":"pub mod jwt;\npub mod password;\n\npub use jwt::{encode_access_token, encode_refresh_token};\npub use password::{hash_password, verify_password};\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","utils","password.rs"],"content":"use anyhow::{Context, Result};\n\n/// Hash a password using bcrypt\npub fn hash_password(password: \u0026str) -\u003e Result\u003cString\u003e {\n    bcrypt::hash(password, bcrypt::DEFAULT_COST).context(\"Failed to hash password\")\n}\n\n/// Verify a password against a hash\npub fn verify_password(password: \u0026str, hash: \u0026str) -\u003e Result\u003cbool\u003e {\n    bcrypt::verify(password, hash).context(\"Failed to verify password\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn hash_and_verify_round_trip() {\n        let password = \"test_password_123\";\n        let hash = hash_password(password).unwrap();\n        assert!(verify_password(password, \u0026hash).unwrap());\n    }\n\n    #[test]\n    fn wrong_password_fails() {\n        let hash = hash_password(\"correct_password\").unwrap();\n        assert!(!verify_password(\"wrong_password\", \u0026hash).unwrap());\n    }\n\n    #[test]\n    fn empty_password_hashes() {\n        let hash = hash_password(\"\").unwrap();\n        assert!(verify_password(\"\", \u0026hash).unwrap());\n        assert!(!verify_password(\"notempty\", \u0026hash).unwrap());\n    }\n\n    #[test]\n    fn different_hashes_for_same_password() {\n        let hash1 = hash_password(\"same_password\").unwrap();\n        let hash2 = hash_password(\"same_password\").unwrap();\n        // bcrypt uses random salt, so hashes should differ\n        assert_ne!(hash1, hash2);\n        // But both should verify\n        assert!(verify_password(\"same_password\", \u0026hash1).unwrap());\n        assert!(verify_password(\"same_password\", \u0026hash2).unwrap());\n    }\n}\n","traces":[{"line":4,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":5,"address":[],"length":0,"stats":{"Line":1080863910568919040}},{"line":9,"address":[],"length":0,"stats":{"Line":432345564227567616}},{"line":10,"address":[],"length":0,"stats":{"Line":1729382256910270464}}],"covered":4,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","websocket","hub.rs"],"content":"use dashmap::DashMap;\nuse std::sync::Arc;\nuse tokio::sync::mpsc;\n\npub type WsSender = mpsc::UnboundedSender\u003cString\u003e;\n\n#[derive(Clone)]\npub struct NotificationHub {\n    connections: Arc\u003cDashMap\u003ci32, Vec\u003cWsSender\u003e\u003e\u003e,\n}\n\nimpl Default for NotificationHub {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl NotificationHub {\n    pub fn new() -\u003e Self {\n        Self {\n            connections: Arc::new(DashMap::new()),\n        }\n    }\n\n    pub fn subscribe(\u0026self, user_id: i32) -\u003e mpsc::UnboundedReceiver\u003cString\u003e {\n        let (tx, rx) = mpsc::unbounded_channel();\n        self.connections.entry(user_id).or_default().push(tx);\n        rx\n    }\n\n    pub fn send_to_user(\u0026self, user_id: i32, message: \u0026str) {\n        if let Some(mut senders) = self.connections.get_mut(\u0026user_id) {\n            // Remove closed channels while sending\n            senders.retain(|sender| sender.send(message.to_string()).is_ok());\n            if senders.is_empty() {\n                drop(senders);\n                self.connections.remove(\u0026user_id);\n            }\n        }\n    }\n}\n","traces":[{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":14},{"path":["C:","\\","Users","yimo","Codes","xjy","src","websocket","mod.rs"],"content":"pub mod hub;\npub mod notification;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","websocket","notification.rs"],"content":"use crate::error::AppError;\nuse crate::utils::jwt::decode_jwt;\nuse crate::websocket::hub::NotificationHub;\nuse axum::{\n    extract::{\n        ws::{Message, WebSocket},\n        Query, WebSocketUpgrade,\n    },\n    response::IntoResponse,\n    Extension,\n};\nuse futures_util::{SinkExt, StreamExt};\nuse serde::Deserialize;\n\n#[derive(Deserialize)]\npub struct WsQuery {\n    pub token: String,\n}\n\npub async fn ws_handler(\n    ws: WebSocketUpgrade,\n    Query(query): Query\u003cWsQuery\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n) -\u003e Result\u003cimpl IntoResponse, AppError\u003e {\n    let claims = decode_jwt(\u0026query.token).map_err(|_| AppError::Unauthorized)?;\n    let user_id: i32 = claims.sub.parse().map_err(|_| AppError::Unauthorized)?;\n\n    Ok(ws.on_upgrade(move |socket| handle_socket(socket, user_id, hub)))\n}\n\nasync fn handle_socket(socket: WebSocket, user_id: i32, hub: NotificationHub) {\n    let (mut ws_sender, mut ws_receiver) = socket.split();\n    let mut rx = hub.subscribe(user_id);\n\n    tracing::info!(\"WebSocket connected for user {}\", user_id);\n\n    let send_task = tokio::spawn(async move {\n        while let Some(msg) = rx.recv().await {\n            if ws_sender.send(Message::Text(msg.into())).await.is_err() {\n                break;\n            }\n        }\n    });\n\n    let recv_task = tokio::spawn(async move {\n        while let Some(Ok(msg)) = ws_receiver.next().await {\n            if let Message::Close(_) = msg {\n                break;\n            }\n        }\n    });\n\n    tokio::select! {\n        _ = send_task =\u003e {},\n        _ = recv_task =\u003e {},\n    }\n\n    tracing::info!(\"WebSocket disconnected for user {}\", user_id);\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":20}]};
        var previousData = {"files":[{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","database.rs"],"content":"use sea_orm::{ConnectOptions, Database, DatabaseConnection, DbErr};\nuse std::env;\nuse std::time::Duration;\n\npub async fn get_database() -\u003e Result\u003cDatabaseConnection, DbErr\u003e {\n    let database_url = env::var(\"DATABASE_URL\").expect(\"DATABASE_URL must be set\");\n\n    let max_connections: u32 = env::var(\"DB_MAX_CONNECTIONS\")\n        .ok()\n        .and_then(|s| s.parse().ok())\n        .unwrap_or(10);\n\n    let min_connections: u32 = env::var(\"DB_MIN_CONNECTIONS\")\n        .ok()\n        .and_then(|s| s.parse().ok())\n        .unwrap_or(2);\n\n    let mut opt = ConnectOptions::new(database_url);\n    opt.max_connections(max_connections)\n        .min_connections(min_connections)\n        .connect_timeout(Duration::from_secs(5))\n        .idle_timeout(Duration::from_secs(300))\n        .sqlx_logging(true);\n\n    Database::connect(opt).await\n}\n","traces":[{"line":5,"address":[],"length":0,"stats":{"Line":0}},{"line":6,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":12},{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","email.rs"],"content":"use std::env;\n\n#[derive(Clone)]\npub struct EmailConfig {\n    pub smtp_host: String,\n    pub smtp_port: u16,\n    pub smtp_username: String,\n    pub smtp_password: String,\n    pub from_address: String,\n    pub frontend_url: String,\n}\n\nimpl EmailConfig {\n    /// Read email config from environment variables.\n    /// Returns None if SMTP is not configured (graceful degradation).\n    pub fn from_env() -\u003e Option\u003cSelf\u003e {\n        let smtp_host = env::var(\"SMTP_HOST\").ok()?;\n        let smtp_port = env::var(\"SMTP_PORT\")\n            .ok()\n            .and_then(|s| s.parse().ok())\n            .unwrap_or(587);\n        let smtp_username = env::var(\"SMTP_USERNAME\").ok()?;\n        let smtp_password = env::var(\"SMTP_PASSWORD\").ok()?;\n        let from_address = env::var(\"SMTP_FROM\")\n            .unwrap_or_else(|_| format!(\"Forum \u003c{}\u003e\", smtp_username.clone()));\n        let frontend_url =\n            env::var(\"FRONTEND_URL\").unwrap_or_else(|_| \"http://localhost:3000\".to_string());\n\n        Some(Self {\n            smtp_host,\n            smtp_port,\n            smtp_username,\n            smtp_password,\n            from_address,\n            frontend_url,\n        })\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":17},{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","jwt.rs"],"content":"use anyhow::Result;\nuse std::env;\n\n#[derive(Debug, Clone)]\npub struct JwtConfig {\n    pub secret: String,\n    pub access_token_expiry: u64,   // 15 minutes\n    pub refresh_token_expiry: u64,   // 7 days\n}\n\nimpl JwtConfig {\n    pub fn from_env() -\u003e Result\u003cSelf\u003e {\n        let secret = env::var(\"JWT_SECRET\")\n            .map_err(|_| anyhow::anyhow!(\"JWT_SECRET environment variable must be set\"))?;\n\n        if secret.len() \u003c 32 {\n            return Err(anyhow::anyhow!(\n                \"JWT_SECRET must be at least 32 characters\"\n            ));\n        }\n\n        let access_token_expiry = env::var(\"JWT_ACCESS_EXPIRATION\")\n            .ok()\n            .and_then(|s| s.parse().ok())\n            .unwrap_or(900); // 15 minutes\n\n        let refresh_token_expiry = env::var(\"JWT_REFRESH_EXPIRATION\")\n            .ok()\n            .and_then(|s| s.parse().ok())\n            .unwrap_or(604800); // 7 days\n\n        Ok(Self {\n            secret,\n            access_token_expiry,\n            refresh_token_expiry,\n        })\n    }\n}","traces":[{"line":12,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":13,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":14,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":16,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":24,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":27,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":29,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":32,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":33,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":34,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":35,"address":[],"length":0,"stats":{"Line":72057594037927936}}],"covered":12,"coverable":14},{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","mod.rs"],"content":"pub mod database;\npub mod email;\npub mod jwt;\npub mod redis;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","config","redis.rs"],"content":"use redis::aio::ConnectionManager;\n\npub async fn get_redis() -\u003e anyhow::Result\u003cConnectionManager\u003e {\n    let redis_url =\n        std::env::var(\"REDIS_URL\").unwrap_or_else(|_| \"redis://localhost:6379\".to_string());\n    let client = redis::Client::open(redis_url)?;\n    let manager = ConnectionManager::new(client).await?;\n    Ok(manager)\n}\n","traces":[{"line":3,"address":[],"length":0,"stats":{"Line":0}},{"line":4,"address":[],"length":0,"stats":{"Line":0}},{"line":5,"address":[],"length":0,"stats":{"Line":0}},{"line":6,"address":[],"length":0,"stats":{"Line":0}},{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":6},{"path":["C:","\\","Users","yimo","Codes","xjy","src","error.rs"],"content":"use axum::{\n    http::StatusCode,\n    response::{IntoResponse, Json, Response},\n};\nuse serde_json::json;\nuse thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum AppError {\n    #[error(\"Database error: {0}\")]\n    Database(#[from] sea_orm::DbErr),\n\n    #[error(\"Authentication failed\")]\n    Unauthorized,\n\n    #[error(\"JWT error: {0}\")]\n    Jwt(#[from] jsonwebtoken::errors::Error),\n\n    #[error(\"Not found\")]\n    NotFound,\n\n    #[error(\"Forbidden\")]\n    Forbidden,\n\n    #[error(\"Validation error: {0}\")]\n    Validation(String),\n\n    #[error(\"Conflict: {0}\")]\n    Conflict(String),\n\n    #[error(\"Internal server error: {0}\")]\n    Internal(#[from] anyhow::Error),\n\n    #[error(\"Payload too large\")]\n    PayloadTooLarge,\n}\n\n#[derive(serde::Serialize, utoipa::ToSchema)]\npub struct ErrorResponse {\n    pub error: String,\n}\n\nimpl utoipa::ToSchema for AppError {\n    fn name() -\u003e std::borrow::Cow\u003c'static, str\u003e {\n        \"ErrorResponse\".into()\n    }\n}\n\nimpl utoipa::PartialSchema for AppError {\n    fn schema() -\u003e utoipa::openapi::RefOr\u003cutoipa::openapi::schema::Schema\u003e {\n        ErrorResponse::schema()\n    }\n}\n\nimpl IntoResponse for AppError {\n    fn into_response(self) -\u003e Response {\n        let (status, error_message) = match self {\n            AppError::Database(e) =\u003e {\n                tracing::error!(\"Database error: {:?}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Database error\".to_string(),\n                )\n            }\n            AppError::Unauthorized =\u003e (StatusCode::UNAUTHORIZED, \"Unauthorized\".to_string()),\n            AppError::Jwt(e) =\u003e {\n                tracing::error!(\"JWT error: {:?}\", e);\n                (StatusCode::UNAUTHORIZED, \"Invalid token\".to_string())\n            }\n            AppError::NotFound =\u003e (StatusCode::NOT_FOUND, \"Resource not found\".to_string()),\n            AppError::Forbidden =\u003e (StatusCode::FORBIDDEN, \"Forbidden\".to_string()),\n            AppError::Validation(msg) =\u003e (StatusCode::BAD_REQUEST, msg),\n            AppError::Conflict(msg) =\u003e (StatusCode::CONFLICT, msg),\n            AppError::Internal(e) =\u003e {\n                tracing::error!(\"Internal error: {:?}\", e);\n                (\n                    StatusCode::INTERNAL_SERVER_ERROR,\n                    \"Internal server error\".to_string(),\n                )\n            }\n            AppError::PayloadTooLarge =\u003e (\n                StatusCode::PAYLOAD_TOO_LARGE,\n                \"File too large\".to_string(),\n            ),\n        };\n\n        let body = json!({\n            \"error\": error_message,\n        });\n\n        (status, Json(body)).into_response()\n    }\n}\n\npub type AppResult\u003cT\u003e = Result\u003cT, AppError\u003e;\n","traces":[{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":28},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","admin.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::{require_admin, AuthUser};\nuse crate::models::UserModel;\nuse crate::response::{ApiResponse, PaginatedResponse, PaginationQuery};\nuse crate::services::admin::AdminService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateRoleRequest {\n    #[validate(length(min = 1, max = 20))]\n    pub role: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct StatsResponse {\n    pub total_users: u64,\n    pub total_posts: u64,\n    pub total_comments: u64,\n    pub total_forums: u64,\n    pub users_today: u64,\n    pub posts_today: u64,\n}\n\n#[derive(Debug, Serialize)]\npub struct AdminUserResponse {\n    pub id: i32,\n    pub username: String,\n    pub email: String,\n    pub avatar_url: Option\u003cString\u003e,\n    pub bio: Option\u003cString\u003e,\n    pub karma: i32,\n    pub role: String,\n    pub created_at: String,\n}\n\nimpl From\u003cUserModel\u003e for AdminUserResponse {\n    fn from(u: UserModel) -\u003e Self {\n        Self {\n            id: u.id,\n            username: u.username,\n            email: u.email,\n            avatar_url: u.avatar_url,\n            bio: u.bio,\n            karma: u.karma,\n            role: u.role,\n            created_at: u.created_at.to_string(),\n        }\n    }\n}\n\npub async fn get_stats(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = AdminService::new(db);\n    let stats = service.get_stats().await?;\n\n    Ok(ApiResponse::ok(StatsResponse {\n        total_users: stats.total_users,\n        total_posts: stats.total_posts,\n        total_comments: stats.total_comments,\n        total_forums: stats.total_forums,\n        users_today: stats.users_today,\n        posts_today: stats.posts_today,\n    }))\n}\n\npub async fn list_users(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = AdminService::new(db);\n    let (users, total) = service.list_users(page, per_page).await?;\n    let items = users.into_iter().map(AdminUserResponse::from).collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn update_user_role(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cUpdateRoleRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = AdminService::new(db);\n    let user = service.update_user_role(id, \u0026payload.role).await?;\n\n    Ok(ApiResponse::ok(AdminUserResponse::from(user)))\n}\n\npub async fn admin_delete_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = AdminService::new(db);\n    service.admin_delete_post(id).await?;\n\n    Ok(ApiResponse::ok(\"Post deleted by admin\"))\n}\n\npub async fn admin_delete_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = AdminService::new(db);\n    service.admin_delete_comment(id).await?;\n\n    Ok(ApiResponse::ok(\"Comment deleted by admin\"))\n}\n","traces":[{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":46},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","auth.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::models::UserModel;\nuse crate::response::ApiResponse;\nuse crate::services::auth::AuthService;\nuse crate::services::email::EmailService;\nuse axum::{response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\nuse utoipa::ToSchema;\n\n#[derive(Debug, Deserialize, Validate, ToSchema)]\npub struct RegisterRequest {\n    #[validate(length(min = 3, max = 50))]\n    pub username: String,\n    #[validate(email)]\n    pub email: String,\n    #[validate(length(min = 8))]\n    pub password: String,\n}\n\n#[derive(Debug, Deserialize, ToSchema)]\npub struct LoginRequest {\n    pub username: String,\n    pub password: String,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct AuthResponse {\n    pub token: String,\n    pub refresh_token: String,\n    pub user_id: i32,\n    pub username: String,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct RegisterResponse {\n    pub token: String,\n    pub refresh_token: String,\n    pub user_id: i32,\n    pub username: String,\n    pub message: String,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct UserResponse {\n    pub id: i32,\n    pub username: String,\n    pub email: String,\n    pub avatar_url: Option\u003cString\u003e,\n    pub bio: Option\u003cString\u003e,\n    pub karma: i32,\n    pub role: String,\n}\n\nimpl From\u003cUserModel\u003e for UserResponse {\n    fn from(user: UserModel) -\u003e Self {\n        Self {\n            id: user.id,\n            username: user.username,\n            email: user.email,\n            avatar_url: user.avatar_url,\n            bio: user.bio,\n            karma: user.karma,\n            role: user.role,\n        }\n    }\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/register\",\n    request_body = RegisterRequest,\n    responses(\n        (status = 200, description = \"User registered successfully\", body = RegisterResponse),\n        (status = 400, description = \"Validation error\", body = AppError),\n        (status = 409, description = \"Username or email already exists\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn register(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(email_service): Extension\u003cEmailService\u003e,\n    Json(payload): Json\u003cRegisterRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    // Validate input\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(format!(\"Validation error: {e}\")))?;\n\n    let service = AuthService::new(db);\n    let (user, access_token, refresh_token) = service\n        .register(\u0026payload.username, \u0026payload.email, \u0026payload.password, \u0026email_service)\n        .await?;\n\n    let response = RegisterResponse {\n        token: access_token,\n        refresh_token,\n        user_id: user.id,\n        username: user.username,\n        message: \"Registration successful. Please check your email to verify your account.\".to_string(),\n    };\n\n    Ok(ApiResponse::ok(response))\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/login\",\n    request_body = LoginRequest,\n    responses(\n        (status = 200, description = \"Login successful\", body = AuthResponse),\n        (status = 400, description = \"Invalid credentials\", body = AppError),\n        (status = 401, description = \"Account not verified\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn login(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Json(payload): Json\u003cLoginRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = AuthService::new(db);\n    let (user, access_token, refresh_token) = service.login(\u0026payload.username, \u0026payload.password).await?;\n\n    let response = AuthResponse {\n        token: access_token,\n        refresh_token,\n        user_id: user.id,\n        username: user.username,\n    };\n\n    Ok(ApiResponse::ok(response))\n}\n\n#[utoipa::path(\n    get,\n    path = \"/api/v1/auth/me\",\n    security((\"jwt_token\" = [])),\n    responses(\n        (status = 200, description = \"Current user retrieved successfully\", body = UserResponse),\n        (status = 401, description = \"Unauthorized\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn get_current_user(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = AuthService::new(db);\n    let user = service.get_user_by_id(user_id).await?;\n\n    Ok(ApiResponse::ok(UserResponse::from(user)))\n}\n\n#[derive(Debug, Deserialize, Validate, ToSchema)]\npub struct ChangePasswordRequest {\n    pub current_password: String,\n    #[validate(length(min = 8))]\n    pub new_password: String,\n}\n\n#[utoipa::path(\n    put,\n    path = \"/api/v1/auth/password\",\n    security((\"jwt_token\" = [])),\n    request_body = ChangePasswordRequest,\n    responses(\n        (status = 200, description = \"Password changed successfully\", body = String),\n        (status = 400, description = \"Validation error\", body = AppError),\n        (status = 401, description = \"Unauthorized\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn change_password(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cChangePasswordRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = AuthService::new(db);\n    service\n        .change_password(user_id, \u0026payload.current_password, \u0026payload.new_password)\n        .await?;\n\n    Ok(ApiResponse::ok(\"Password changed successfully\"))\n}\n\n#[derive(Debug, Deserialize, ToSchema)]\npub struct VerifyEmailRequest {\n    pub token: String,\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/verify-email\",\n    request_body = VerifyEmailRequest,\n    responses(\n        (status = 200, description = \"Email verified successfully\", body = String),\n        (status = 400, description = \"Invalid token\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn verify_email(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Json(payload): Json\u003cVerifyEmailRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = AuthService::new(db);\n    service.verify_email(\u0026payload.token).await?;\n    Ok(ApiResponse::ok(\"Email verified successfully\"))\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/resend-verification\",\n    security((\"jwt_token\" = [])),\n    responses(\n        (status = 200, description = \"Verification email sent\", body = serde_json::Value),\n        (status = 401, description = \"Unauthorized\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn resend_verification(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(email_service): Extension\u003cEmailService\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = AuthService::new(db);\n    service.resend_verification(user_id, \u0026email_service).await?;\n    Ok(ApiResponse::ok(\n        serde_json::json!({ \"message\": \"Verification email sent\" }),\n    ))\n}\n\n#[derive(Debug, Deserialize, Validate, ToSchema)]\npub struct ForgotPasswordRequest {\n    #[validate(email)]\n    pub email: String,\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/forgot-password\",\n    request_body = ForgotPasswordRequest,\n    responses(\n        (status = 200, description = \"Password reset email sent if account exists\", body = serde_json::Value),\n        (status = 400, description = \"Validation error\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn forgot_password(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(email_service): Extension\u003cEmailService\u003e,\n    Json(payload): Json\u003cForgotPasswordRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let service = AuthService::new(db);\n    service\n        .forgot_password(\u0026payload.email, \u0026email_service)\n        .await?;\n\n    // Always return success to prevent email enumeration\n    Ok(ApiResponse::ok(\n        serde_json::json!({ \"message\": \"If an account with that email exists, a password reset link has been sent.\" }),\n    ))\n}\n\n#[derive(Debug, Deserialize, Validate, ToSchema)]\npub struct ResetPasswordRequest {\n    pub token: String,\n    #[validate(length(min = 8))]\n    pub new_password: String,\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/reset-password\",\n    request_body = ResetPasswordRequest,\n    responses(\n        (status = 200, description = \"Password reset successfully\", body = serde_json::Value),\n        (status = 400, description = \"Validation error\", body = AppError),\n        (status = 400, description = \"Invalid token\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn reset_password(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Json(payload): Json\u003cResetPasswordRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let service = AuthService::new(db);\n    service\n        .reset_password(\u0026payload.token, \u0026payload.new_password)\n        .await?;\n\n    Ok(ApiResponse::ok(\n        serde_json::json!({ \"message\": \"Password has been reset successfully\" }),\n    ))\n}\n\n#[derive(Debug, Deserialize, ToSchema)]\npub struct RefreshTokenRequest {\n    pub refresh_token: String,\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct TokenResponse {\n    pub token: String,\n    pub refresh_token: String,\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/refresh\",\n    request_body = RefreshTokenRequest,\n    responses(\n        (status = 200, description = \"New access token generated\", body = TokenResponse),\n        (status = 401, description = \"Invalid or expired refresh token\", body = AppError),\n    ),\n    tag = \"auth\"\n)]\npub async fn refresh_token(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Json(payload): Json\u003cRefreshTokenRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    // Decode the refresh token\n    let claims = crate::utils::jwt::decode_jwt(\u0026payload.refresh_token)?;\n\n    // Verify it's a refresh token\n    if !crate::utils::jwt::is_refresh_token(\u0026claims) {\n        return Err(AppError::Unauthorized);\n    }\n\n    // Get user ID from claims\n    let user_id_str = claims.sub;\n    let user_id: i32 = user_id_str.parse().map_err(|_| AppError::Unauthorized)?;\n\n    // Verify user exists\n    let service = AuthService::new(db);\n    let _user = service.get_user_by_id(user_id).await?;\n\n    // Generate new tokens\n    let new_access_token = crate::utils::jwt::encode_access_token(\u0026user_id_str)?;\n    let new_refresh_token = crate::utils::jwt::encode_refresh_token(\u0026user_id_str)?;\n\n    let response = TokenResponse {\n        token: new_access_token,\n        refresh_token: new_refresh_token,\n    };\n\n    Ok(ApiResponse::ok(response))\n}\n\n#[utoipa::path(\n    post,\n    path = \"/api/v1/auth/logout\",\n    security((\"jwt_token\" = [])),\n    responses(\n        (status = 200, description = \"Logout successful\", body = String),\n    ),\n    tag = \"auth\"\n)]\npub async fn logout() -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    Ok(ApiResponse::ok(\"Logout successful\"))\n}\n","traces":[{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":80},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","bookmark.rs"],"content":"use crate::error::AppResult;\nuse crate::handlers::post::PostResponse;\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::response::{ApiResponse, PaginatedResponse, PaginationQuery};\nuse crate::services::bookmark::BookmarkService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension};\nuse sea_orm::DatabaseConnection;\nuse serde::Serialize;\n\n#[derive(Debug, Serialize)]\npub struct BookmarkToggleResponse {\n    pub bookmarked: bool,\n}\n\npub async fn toggle_bookmark(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(post_id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n    let service = BookmarkService::new(db);\n    let bookmarked = service.toggle(user_id, post_id).await?;\n    Ok(ApiResponse::ok(BookmarkToggleResponse { bookmarked }))\n}\n\npub async fn list_bookmarks(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = BookmarkService::new(db);\n    let (posts, total) = service.list_user_bookmarks(user_id, page, per_page).await?;\n    let items = posts.into_iter().map(PostResponse::from).collect();\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":14},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","comment.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::models::CommentModel;\nuse crate::response::ApiResponse;\nuse crate::services::comment::CommentService;\nuse crate::services::notification::NotificationService;\nuse crate::services::post::PostService;\nuse crate::websocket::hub::NotificationHub;\nuse axum::{extract::Path, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreateCommentRequest {\n    pub post_id: i32,\n    pub parent_id: Option\u003ci32\u003e,\n    #[validate(length(min = 1))]\n    pub content: String,\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateCommentRequest {\n    #[validate(length(min = 1))]\n    pub content: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct CommentResponse {\n    pub id: i32,\n    pub post_id: i32,\n    pub user_id: i32,\n    pub parent_id: Option\u003ci32\u003e,\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub created_at: String,\n    pub updated_at: String,\n}\n\nimpl From\u003cCommentModel\u003e for CommentResponse {\n    fn from(c: CommentModel) -\u003e Self {\n        Self {\n            id: c.id,\n            post_id: c.post_id,\n            user_id: c.user_id,\n            parent_id: c.parent_id,\n            content: c.content,\n            upvotes: c.upvotes,\n            downvotes: c.downvotes,\n            created_at: c.created_at.to_string(),\n            updated_at: c.updated_at.to_string(),\n        }\n    }\n}\n\n#[derive(Debug, Serialize, Clone)]\npub struct CommentTreeNode {\n    pub id: i32,\n    pub post_id: i32,\n    pub user_id: i32,\n    pub parent_id: Option\u003ci32\u003e,\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub created_at: String,\n    pub updated_at: String,\n    pub children: Vec\u003cCommentTreeNode\u003e,\n}\n\nimpl From\u003cCommentModel\u003e for CommentTreeNode {\n    fn from(c: CommentModel) -\u003e Self {\n        Self {\n            id: c.id,\n            post_id: c.post_id,\n            user_id: c.user_id,\n            parent_id: c.parent_id,\n            content: c.content,\n            upvotes: c.upvotes,\n            downvotes: c.downvotes,\n            created_at: c.created_at.to_string(),\n            updated_at: c.updated_at.to_string(),\n            children: Vec::new(),\n        }\n    }\n}\n\nfn build_comment_tree(comments: Vec\u003cCommentModel\u003e) -\u003e Vec\u003cCommentTreeNode\u003e {\n    let mut nodes: HashMap\u003ci32, CommentTreeNode\u003e = HashMap::new();\n    let mut children_map: HashMap\u003cOption\u003ci32\u003e, Vec\u003ci32\u003e\u003e = HashMap::new();\n\n    for comment in \u0026comments {\n        children_map\n            .entry(comment.parent_id)\n            .or_default()\n            .push(comment.id);\n    }\n    for comment in comments {\n        let id = comment.id;\n        nodes.insert(id, CommentTreeNode::from(comment));\n    }\n\n    fn attach_children(\n        node_id: i32,\n        nodes: \u0026mut HashMap\u003ci32, CommentTreeNode\u003e,\n        children_map: \u0026HashMap\u003cOption\u003ci32\u003e, Vec\u003ci32\u003e\u003e,\n    ) -\u003e Option\u003cCommentTreeNode\u003e {\n        let mut node = nodes.remove(\u0026node_id)?;\n        if let Some(child_ids) = children_map.get(\u0026Some(node_id)) {\n            for \u0026child_id in child_ids {\n                if nodes.contains_key(\u0026child_id) {\n                    if let Some(child) = attach_children(child_id, nodes, children_map) {\n                        node.children.push(child);\n                    }\n                }\n            }\n        }\n        Some(node)\n    }\n\n    let root_ids = children_map.get(\u0026None).cloned().unwrap_or_default();\n    root_ids\n        .into_iter()\n        .filter_map(|id| attach_children(id, \u0026mut nodes, \u0026children_map))\n        .collect()\n}\n\npub async fn list_comments(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(post_id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = CommentService::new(db);\n    let comments = service.list_by_post(post_id).await?;\n    let tree = build_comment_tree(comments);\n    Ok(ApiResponse::ok(tree))\n}\n\npub async fn create_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreateCommentRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let comment_service = CommentService::new(db.clone());\n    let comment = comment_service\n        .create(\n            payload.post_id,\n            user_id,\n            payload.parent_id,\n            \u0026payload.content,\n        )\n        .await?;\n\n    // Fire notifications (best-effort, don't fail the request)\n    let notif_service = NotificationService::new(db.clone(), hub);\n    let post_service = PostService::new(db);\n\n    // Notify post author\n    if let Ok(post) = post_service.get_by_id(payload.post_id).await {\n        let _ = notif_service\n            .notify(\n                post.user_id,\n                user_id,\n                \"comment_on_post\",\n                \"post\",\n                post.id,\n                \"Someone commented on your post\",\n            )\n            .await;\n    }\n\n    // Notify parent comment author (if replying)\n    if let Some(parent_id) = payload.parent_id {\n        if let Ok(parent) = comment_service.get_by_id(parent_id).await {\n            let _ = notif_service\n                .notify(\n                    parent.user_id,\n                    user_id,\n                    \"reply_to_comment\",\n                    \"comment\",\n                    parent.id,\n                    \"Someone replied to your comment\",\n                )\n                .await;\n        }\n    }\n\n    Ok(ApiResponse::ok(CommentResponse::from(comment)))\n}\n\npub async fn update_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cUpdateCommentRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = CommentService::new(db);\n    let comment = service.update(id, user_id, \u0026payload.content).await?;\n\n    Ok(ApiResponse::ok(CommentResponse::from(comment)))\n}\n\npub async fn delete_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = CommentService::new(db);\n    service.delete(id, user_id).await?;\n\n    Ok(ApiResponse::ok(\"Comment deleted\"))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::NaiveDateTime;\n\n    fn make_comment(id: i32, post_id: i32, parent_id: Option\u003ci32\u003e) -\u003e CommentModel {\n        let now = NaiveDateTime::default();\n        CommentModel {\n            id,\n            post_id,\n            user_id: 1,\n            parent_id,\n            content: format!(\"Comment {}\", id),\n            upvotes: 0,\n            downvotes: 0,\n            is_hidden: false,\n            created_at: now,\n            updated_at: now,\n        }\n    }\n\n    #[test]\n    fn flat_comments_become_roots() {\n        let comments = vec![\n            make_comment(1, 1, None),\n            make_comment(2, 1, None),\n            make_comment(3, 1, None),\n        ];\n        let tree = build_comment_tree(comments);\n        assert_eq!(tree.len(), 3);\n        assert!(tree.iter().all(|n| n.children.is_empty()));\n    }\n\n    #[test]\n    fn nested_comments_build_tree() {\n        let comments = vec![\n            make_comment(1, 1, None),\n            make_comment(2, 1, Some(1)),\n            make_comment(3, 1, Some(2)),\n        ];\n        let tree = build_comment_tree(comments);\n        assert_eq!(tree.len(), 1);\n        assert_eq!(tree[0].id, 1);\n        assert_eq!(tree[0].children.len(), 1);\n        assert_eq!(tree[0].children[0].id, 2);\n        assert_eq!(tree[0].children[0].children.len(), 1);\n        assert_eq!(tree[0].children[0].children[0].id, 3);\n    }\n\n    #[test]\n    fn orphan_comments_are_skipped() {\n        let comments = vec![\n            make_comment(1, 1, None),\n            make_comment(2, 1, Some(999)), // parent doesn't exist\n        ];\n        let tree = build_comment_tree(comments);\n        // Root should be id=1, orphan id=2 is never attached since parent_id 999 isn't a root\n        assert_eq!(tree.len(), 1);\n        assert_eq!(tree[0].id, 1);\n    }\n\n    #[test]\n    fn empty_input_gives_empty_tree() {\n        let tree = build_comment_tree(vec![]);\n        assert!(tree.is_empty());\n    }\n\n    #[test]\n    fn multiple_roots_with_children() {\n        let comments = vec![\n            make_comment(1, 1, None),\n            make_comment(2, 1, None),\n            make_comment(3, 1, Some(1)),\n            make_comment(4, 1, Some(2)),\n        ];\n        let tree = build_comment_tree(comments);\n        assert_eq!(tree.len(), 2);\n        assert_eq!(tree[0].children.len(), 1);\n        assert_eq!(tree[1].children.len(), 1);\n    }\n}\n","traces":[{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":76,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":77,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":78,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":79,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":80,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":81,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":82,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":83,"address":[],"length":0,"stats":{"Line":2594073385365405696}},{"line":84,"address":[],"length":0,"stats":{"Line":1729382256910270464}},{"line":85,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":90,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":91,"address":[],"length":0,"stats":{"Line":1080863910568919040}},{"line":92,"address":[],"length":0,"stats":{"Line":1080863910568919040}},{"line":94,"address":[],"length":0,"stats":{"Line":2089670227099910144}},{"line":95,"address":[],"length":0,"stats":{"Line":2594073385365405696}},{"line":96,"address":[],"length":0,"stats":{"Line":2594073385365405696}},{"line":98,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":100,"address":[],"length":0,"stats":{"Line":2089670227099910144}},{"line":101,"address":[],"length":0,"stats":{"Line":2594073385365405696}},{"line":102,"address":[],"length":0,"stats":{"Line":3458764513820540928}},{"line":105,"address":[],"length":0,"stats":{"Line":792633534417207296}},{"line":110,"address":[],"length":0,"stats":{"Line":3170534137668829184}},{"line":111,"address":[],"length":0,"stats":{"Line":1873497444986126336}},{"line":112,"address":[],"length":0,"stats":{"Line":576460752303423488}},{"line":113,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":114,"address":[],"length":0,"stats":{"Line":1441151880758558720}},{"line":115,"address":[],"length":0,"stats":{"Line":576460752303423488}},{"line":120,"address":[],"length":0,"stats":{"Line":792633534417207296}},{"line":123,"address":[],"length":0,"stats":{"Line":2161727821137838080}},{"line":124,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":126,"address":[],"length":0,"stats":{"Line":2377900603251621888}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}}],"covered":32,"coverable":86},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","follow.rs"],"content":"use crate::error::AppResult;\nuse crate::handlers::user::UserProfileResponse;\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::response::{ApiResponse, PaginatedResponse, PaginationQuery};\nuse crate::services::follow::FollowService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension};\nuse sea_orm::DatabaseConnection;\nuse serde::Serialize;\n\n#[derive(Debug, Serialize)]\npub struct FollowToggleResponse {\n    pub following: bool,\n}\n\npub async fn toggle_follow(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(user_id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let follower_id = parse_user_id(\u0026auth_user)?;\n    let service = FollowService::new(db);\n    let following = service.toggle(follower_id, user_id).await?;\n    Ok(ApiResponse::ok(FollowToggleResponse { following }))\n}\n\npub async fn list_followers(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(user_id): Path\u003ci32\u003e,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = FollowService::new(db);\n    let (users, total) = service.list_followers(user_id, page, per_page).await?;\n    let items = users.into_iter().map(UserProfileResponse::from).collect();\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn list_following(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(user_id): Path\u003ci32\u003e,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = FollowService::new(db);\n    let (users, total) = service.list_following(user_id, page, per_page).await?;\n    let items = users.into_iter().map(UserProfileResponse::from).collect();\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":21},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","forum.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::{require_admin, AuthUser};\nuse crate::models::ForumModel;\nuse crate::response::ApiResponse;\nuse crate::services::cache::CacheService;\nuse crate::services::forum::ForumService;\nuse axum::{extract::Path, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreateForumRequest {\n    #[validate(length(min = 1, max = 100))]\n    pub name: String,\n    #[validate(length(max = 500))]\n    pub description: String,\n    #[validate(length(min = 1, max = 100))]\n    pub slug: String,\n    pub sort_order: Option\u003ci32\u003e,\n    pub icon_url: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateForumRequest {\n    #[validate(length(min = 1, max = 100))]\n    pub name: String,\n    #[validate(length(max = 500))]\n    pub description: String,\n    pub sort_order: Option\u003ci32\u003e,\n    pub icon_url: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\npub struct ForumResponse {\n    pub id: i32,\n    pub name: String,\n    pub description: String,\n    pub slug: String,\n    pub sort_order: i32,\n    pub icon_url: Option\u003cString\u003e,\n    pub created_at: String,\n    pub updated_at: String,\n}\n\nimpl From\u003cForumModel\u003e for ForumResponse {\n    fn from(f: ForumModel) -\u003e Self {\n        Self {\n            id: f.id,\n            name: f.name,\n            description: f.description,\n            slug: f.slug,\n            sort_order: f.sort_order,\n            icon_url: f.icon_url,\n            created_at: f.created_at.to_string(),\n            updated_at: f.updated_at.to_string(),\n        }\n    }\n}\n\nfn make_forum_service(db: DatabaseConnection, cache: Option\u003cCacheService\u003e) -\u003e ForumService {\n    let service = ForumService::new(db);\n    match cache {\n        Some(c) =\u003e service.with_cache(c),\n        None =\u003e service,\n    }\n}\n\npub async fn list_forums(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    cache: Option\u003cExtension\u003cCacheService\u003e\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = make_forum_service(db, cache.map(|c| c.0));\n    let forums = service.list().await?;\n    let response: Vec\u003cForumResponse\u003e = forums.into_iter().map(ForumResponse::from).collect();\n    Ok(ApiResponse::ok(response))\n}\n\npub async fn get_forum(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(slug): Path\u003cString\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = ForumService::new(db);\n    let forum = service.get_by_slug(\u0026slug).await?;\n    Ok(ApiResponse::ok(ForumResponse::from(forum)))\n}\n\npub async fn create_forum(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    cache: Option\u003cExtension\u003cCacheService\u003e\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreateForumRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = make_forum_service(db, cache.map(|c| c.0));\n    let forum = service\n        .create(\n            \u0026payload.name,\n            \u0026payload.description,\n            \u0026payload.slug,\n            payload.sort_order.unwrap_or(0),\n            payload.icon_url,\n        )\n        .await?;\n\n    Ok(ApiResponse::ok(ForumResponse::from(forum)))\n}\n\npub async fn update_forum(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    cache: Option\u003cExtension\u003cCacheService\u003e\u003e,\n    auth_user: AuthUser,\n    Path(slug): Path\u003cString\u003e,\n    Json(payload): Json\u003cUpdateForumRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = make_forum_service(db, cache.map(|c| c.0));\n    let forum = service\n        .update(\n            \u0026slug,\n            \u0026payload.name,\n            \u0026payload.description,\n            payload.sort_order.unwrap_or(0),\n            payload.icon_url,\n        )\n        .await?;\n\n    Ok(ApiResponse::ok(ForumResponse::from(forum)))\n}\n\npub async fn delete_forum(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    cache: Option\u003cExtension\u003cCacheService\u003e\u003e,\n    auth_user: AuthUser,\n    Path(slug): Path\u003cString\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = make_forum_service(db, cache.map(|c| c.0));\n    service.delete(\u0026slug).await?;\n\n    Ok(ApiResponse::ok(\"Forum deleted\"))\n}\n","traces":[{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":54},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","mod.rs"],"content":"pub mod admin;\npub mod auth;\npub mod bookmark;\npub mod comment;\npub mod follow;\npub mod forum;\npub mod notification;\npub mod post;\npub mod report;\npub mod tag;\npub mod upload;\npub mod user;\npub mod vote;\n\npub use auth::*;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","notification.rs"],"content":"use crate::error::AppResult;\nuse crate::middleware::AuthUser;\nuse crate::models::NotificationModel;\nuse crate::response::{ApiResponse, PaginatedResponse, PaginationQuery};\nuse crate::services::notification::NotificationService;\nuse crate::websocket::hub::NotificationHub;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension};\nuse sea_orm::DatabaseConnection;\nuse serde::Serialize;\n\n#[derive(Debug, Serialize)]\npub struct NotificationResponse {\n    pub id: i32,\n    pub kind: String,\n    pub actor_id: i32,\n    pub target_type: String,\n    pub target_id: i32,\n    pub message: String,\n    pub is_read: bool,\n    pub created_at: String,\n}\n\nimpl From\u003cNotificationModel\u003e for NotificationResponse {\n    fn from(n: NotificationModel) -\u003e Self {\n        Self {\n            id: n.id,\n            kind: n.kind,\n            actor_id: n.actor_id,\n            target_type: n.target_type,\n            target_id: n.target_id,\n            message: n.message,\n            is_read: n.is_read,\n            created_at: n.created_at.to_string(),\n        }\n    }\n}\n\n#[derive(Debug, Serialize)]\npub struct UnreadCountResponse {\n    pub count: u64,\n}\n\nfn get_user_id(auth_user: \u0026AuthUser) -\u003e AppResult\u003ci32\u003e {\n    crate::middleware::auth::parse_user_id(auth_user)\n}\n\npub async fn list_notifications(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Query(params): Query\u003cPaginationQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = get_user_id(\u0026auth_user)?;\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = NotificationService::new(db, hub);\n    let (notifications, total) = service.list_for_user(user_id, page, per_page).await?;\n    let items = notifications\n        .into_iter()\n        .map(NotificationResponse::from)\n        .collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn unread_count(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = get_user_id(\u0026auth_user)?;\n    let service = NotificationService::new(db, hub);\n    let count = service.unread_count(user_id).await?;\n    Ok(ApiResponse::ok(UnreadCountResponse { count }))\n}\n\npub async fn mark_read(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = get_user_id(\u0026auth_user)?;\n    let service = NotificationService::new(db, hub);\n    service.mark_read(id, user_id).await?;\n    Ok(ApiResponse::ok(\"Notification marked as read\"))\n}\n\npub async fn mark_all_read(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = get_user_id(\u0026auth_user)?;\n    let service = NotificationService::new(db, hub);\n    let count = service.mark_all_read(user_id).await?;\n    Ok(ApiResponse::ok(serde_json::json!({ \"marked_read\": count })))\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":36},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","post.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::{parse_user_id, require_admin, AuthUser};\nuse crate::models::PostModel;\nuse crate::response::{ApiResponse, PaginatedResponse};\nuse crate::services::post::PostService;\nuse crate::services::tag::TagService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreatePostRequest {\n    pub forum_id: i32,\n    #[validate(length(min = 1, max = 200))]\n    pub title: String,\n    #[validate(length(min = 1))]\n    pub content: String,\n    /// Up to 5 tags, each max 30 characters.\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdatePostRequest {\n    #[validate(length(min = 1, max = 200))]\n    pub title: String,\n    #[validate(length(min = 1))]\n    pub content: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct PostResponse {\n    pub id: i32,\n    pub user_id: i32,\n    pub forum_id: i32,\n    pub title: String,\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub view_count: i32,\n    pub is_pinned: bool,\n    pub is_locked: bool,\n    pub created_at: String,\n    pub updated_at: String,\n    pub tags: Vec\u003cString\u003e,\n}\n\nimpl From\u003cPostModel\u003e for PostResponse {\n    fn from(p: PostModel) -\u003e Self {\n        Self {\n            id: p.id,\n            user_id: p.user_id,\n            forum_id: p.forum_id,\n            title: p.title,\n            content: p.content,\n            upvotes: p.upvotes,\n            downvotes: p.downvotes,\n            view_count: p.view_count,\n            is_pinned: p.is_pinned,\n            is_locked: p.is_locked,\n            created_at: p.created_at.to_string(),\n            updated_at: p.updated_at.to_string(),\n            tags: Vec::new(),\n        }\n    }\n}\n\nimpl PostResponse {\n    pub fn with_tags(p: PostModel, tags: Vec\u003cString\u003e) -\u003e Self {\n        Self {\n            id: p.id,\n            user_id: p.user_id,\n            forum_id: p.forum_id,\n            title: p.title,\n            content: p.content,\n            upvotes: p.upvotes,\n            downvotes: p.downvotes,\n            view_count: p.view_count,\n            is_pinned: p.is_pinned,\n            is_locked: p.is_locked,\n            created_at: p.created_at.to_string(),\n            updated_at: p.updated_at.to_string(),\n            tags,\n        }\n    }\n}\n\n#[derive(Debug, Deserialize)]\npub struct PostListQuery {\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n    /// Sort order: \"new\" (default), \"top\", \"hot\"\n    pub sort: Option\u003cString\u003e,\n}\n\npub async fn list_posts(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(forum_id): Path\u003ci32\u003e,\n    Query(params): Query\u003cPostListQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n    let sort = params.sort.as_deref().unwrap_or(\"new\");\n\n    let service = PostService::new(db.clone());\n    let (posts, total) = service.list_by_forum(forum_id, page, per_page, sort).await?;\n\n    // Batch-fetch tags for all posts in the page\n    let post_ids: Vec\u003ci32\u003e = posts.iter().map(|p| p.id).collect();\n    let tag_service = TagService::new(db);\n    let tags_map = tag_service.get_tags_for_posts(\u0026post_ids).await?;\n\n    let items: Vec\u003cPostResponse\u003e = posts\n        .into_iter()\n        .map(|p| {\n            let tags = tags_map.get(\u0026p.id).cloned().unwrap_or_default();\n            PostResponse::with_tags(p, tags)\n        })\n        .collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn get_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = PostService::new(db.clone());\n    service.increment_view_count(id).await?;\n    let post = service.get_by_id(id).await?;\n\n    let tag_service = TagService::new(db);\n    let tags = tag_service.get_post_tags(id).await?;\n    let tag_names: Vec\u003cString\u003e = tags.into_iter().map(|t| t.name).collect();\n\n    Ok(ApiResponse::ok(PostResponse::with_tags(post, tag_names)))\n}\n\npub async fn create_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreatePostRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    // Validate tags\n    let tag_names = payload.tags.unwrap_or_default();\n    if tag_names.len() \u003e 5 {\n        return Err(AppError::Validation(\"Maximum 5 tags allowed\".to_string()));\n    }\n    for tag in \u0026tag_names {\n        if tag.trim().is_empty() || tag.len() \u003e 30 {\n            return Err(AppError::Validation(\n                \"Each tag must be 1-30 characters\".to_string(),\n            ));\n        }\n    }\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = PostService::new(db.clone());\n    let post = service\n        .create(user_id, payload.forum_id, \u0026payload.title, \u0026payload.content)\n        .await?;\n\n    // Assign tags\n    let mut response_tags = Vec::new();\n    if !tag_names.is_empty() {\n        let tag_service = TagService::new(db);\n        let tags = tag_service.get_or_create_tags(tag_names).await?;\n        response_tags = tags.iter().map(|t| t.name.clone()).collect();\n        let tag_ids: Vec\u003ci32\u003e = tags.into_iter().map(|t| t.id).collect();\n        tag_service.set_post_tags(post.id, tag_ids).await?;\n    }\n\n    Ok(ApiResponse::ok(PostResponse::with_tags(post, response_tags)))\n}\n\npub async fn update_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cUpdatePostRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = PostService::new(db);\n    let post = service\n        .update(id, user_id, \u0026payload.title, \u0026payload.content)\n        .await?;\n\n    Ok(ApiResponse::ok(PostResponse::from(post)))\n}\n\npub async fn delete_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = PostService::new(db);\n    service.delete(id, user_id).await?;\n\n    Ok(ApiResponse::ok(\"Post deleted\"))\n}\n\npub async fn pin_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = PostService::new(db);\n    let post = service.toggle_pin(id).await?;\n    Ok(ApiResponse::ok(PostResponse::from(post)))\n}\n\npub async fn lock_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = PostService::new(db);\n    let post = service.toggle_lock(id).await?;\n    Ok(ApiResponse::ok(PostResponse::from(post)))\n}\n\n#[derive(Debug, Deserialize)]\npub struct SearchPostsQuery {\n    pub q: String,\n    pub forum_id: Option\u003ci32\u003e,\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n    /// Sort order: \"relevance\" (default), \"new\", \"top\"\n    pub sort: Option\u003cString\u003e,\n}\n\npub async fn search_posts(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Query(params): Query\u003cSearchPostsQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let q = params.q.trim();\n    if q.is_empty() || q.len() \u003e 200 {\n        return Err(AppError::Validation(\n            \"Search query must be 1-200 characters\".to_string(),\n        ));\n    }\n\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n    let sort = params.sort.as_deref().unwrap_or(\"relevance\");\n\n    let service = PostService::new(db);\n    let (posts, total) = service.search(q, params.forum_id, page, per_page, sort).await?;\n    let items = posts.into_iter().map(PostResponse::from).collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n","traces":[{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":110},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","report.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::{parse_user_id, require_admin, AuthUser};\nuse crate::models::ReportModel;\nuse crate::response::{ApiResponse, PaginatedResponse};\nuse crate::services::report::ReportService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreateReportRequest {\n    #[validate(length(min = 1, max = 20))]\n    pub target_type: String,\n    pub target_id: i32,\n    #[validate(length(min = 1, max = 50))]\n    pub reason: String,\n    pub description: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ListReportsQuery {\n    pub status: Option\u003cString\u003e,\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct ResolveReportRequest {\n    #[validate(length(min = 1, max = 20))]\n    pub action: String,\n}\n\n#[derive(Debug, Serialize)]\npub struct ReportResponse {\n    pub id: i32,\n    pub reporter_id: i32,\n    pub target_type: String,\n    pub target_id: i32,\n    pub reason: String,\n    pub description: Option\u003cString\u003e,\n    pub status: String,\n    pub resolved_by: Option\u003ci32\u003e,\n    pub resolved_at: Option\u003cString\u003e,\n    pub created_at: String,\n}\n\nimpl From\u003cReportModel\u003e for ReportResponse {\n    fn from(r: ReportModel) -\u003e Self {\n        Self {\n            id: r.id,\n            reporter_id: r.reporter_id,\n            target_type: r.target_type,\n            target_id: r.target_id,\n            reason: r.reason,\n            description: r.description,\n            status: r.status,\n            resolved_by: r.resolved_by,\n            resolved_at: r.resolved_at.map(|t| t.to_string()),\n            created_at: r.created_at.to_string(),\n        }\n    }\n}\n\npub async fn create_report(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreateReportRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = ReportService::new(db);\n    let report = service\n        .create_report(\n            user_id,\n            \u0026payload.target_type,\n            payload.target_id,\n            \u0026payload.reason,\n            payload.description.as_deref(),\n        )\n        .await?;\n\n    Ok(ApiResponse::ok(ReportResponse::from(report)))\n}\n\npub async fn list_reports(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Query(params): Query\u003cListReportsQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = ReportService::new(db);\n    let (reports, total) = service\n        .list_reports(params.status.as_deref(), page, per_page)\n        .await?;\n    let items = reports.into_iter().map(ReportResponse::from).collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\npub async fn resolve_report(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cResolveReportRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let admin_id = require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = ReportService::new(db);\n    let report = service.resolve(id, admin_id, \u0026payload.action).await?;\n\n    Ok(ApiResponse::ok(ReportResponse::from(report)))\n}\n","traces":[{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":42},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","tag.rs"],"content":"use crate::error::AppResult;\nuse crate::handlers::post::PostResponse;\nuse crate::middleware::auth::require_admin;\nuse crate::middleware::AuthUser;\nuse crate::models::TagModel;\nuse crate::response::{ApiResponse, PaginatedResponse};\nuse crate::services::tag::TagService;\nuse axum::{extract::Path, extract::Query, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Serialize)]\npub struct TagResponse {\n    pub id: i32,\n    pub name: String,\n    pub slug: String,\n}\n\nimpl From\u003cTagModel\u003e for TagResponse {\n    fn from(t: TagModel) -\u003e Self {\n        Self {\n            id: t.id,\n            name: t.name,\n            slug: t.slug,\n        }\n    }\n}\n\n#[derive(Debug, Deserialize)]\npub struct TagPostsQuery {\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n}\n\npub async fn list_tags(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = TagService::new(db);\n    let tags = service.list_tags().await?;\n    let items: Vec\u003cTagResponse\u003e = tags.into_iter().map(TagResponse::from).collect();\n    Ok(ApiResponse::ok(items))\n}\n\npub async fn get_posts_by_tag(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(slug): Path\u003cString\u003e,\n    Query(params): Query\u003cTagPostsQuery\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let page = params.page.unwrap_or(1);\n    let per_page = params.per_page.unwrap_or(20).min(100);\n\n    let service = TagService::new(db);\n    let (posts, total) = service.get_posts_by_tag(\u0026slug, page, per_page).await?;\n    let items: Vec\u003cPostResponse\u003e = posts.into_iter().map(PostResponse::from).collect();\n\n    Ok(ApiResponse::ok(PaginatedResponse::new(\n        items, total, page, per_page,\n    )))\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct CreateTagRequest {\n    #[validate(length(min = 1, max = 30))]\n    pub name: String,\n}\n\npub async fn create_tag(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cCreateTagRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload.validate().map_err(|e| crate::error::AppError::Validation(e.to_string()))?;\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = TagService::new(db);\n    let tag = service.create_tag(\u0026payload.name).await?;\n    Ok(ApiResponse::ok(TagResponse::from(tag)))\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateTagRequest {\n    #[validate(length(min = 1, max = 30))]\n    pub name: String,\n}\n\npub async fn update_tag(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cUpdateTagRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload.validate().map_err(|e| crate::error::AppError::Validation(e.to_string()))?;\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = TagService::new(db);\n    let tag = service.update_tag(id, \u0026payload.name).await?;\n    Ok(ApiResponse::ok(TagResponse::from(tag)))\n}\n\npub async fn delete_tag(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    require_admin(\u0026db, \u0026auth_user).await?;\n\n    let service = TagService::new(db);\n    service.delete_tag(id).await?;\n    Ok(ApiResponse::ok(\"Tag deleted successfully\"))\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":34},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","upload.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::response::ApiResponse;\nuse crate::services::upload::{UploadConfig, UploadService};\nuse crate::services::user::UserService;\nuse axum::{extract::Multipart, response::IntoResponse, Extension};\nuse sea_orm::DatabaseConnection;\nuse serde::Serialize;\n\n#[derive(Debug, Serialize)]\npub struct UploadResponse {\n    pub url: String,\n}\n\n/// Upload and set user avatar.\n/// POST /upload/avatar (multipart form: field \"file\")\npub async fn upload_avatar(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(config): Extension\u003cUploadConfig\u003e,\n    auth_user: AuthUser,\n    mut multipart: Multipart,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let field = multipart\n        .next_field()\n        .await\n        .map_err(|e| AppError::Validation(format!(\"Failed to read upload: {}\", e)))?\n        .ok_or_else(|| AppError::Validation(\"No file provided\".to_string()))?;\n\n    let content_type = field\n        .content_type()\n        .unwrap_or(\"application/octet-stream\")\n        .to_string();\n\n    let data = field\n        .bytes()\n        .await\n        .map_err(|e| AppError::Validation(format!(\"Failed to read file data: {}\", e)))?;\n\n    let url = UploadService::save_file(\u0026config, \u0026data, \u0026content_type, \"avatars\").await?;\n\n    // Update user avatar_url\n    let service = UserService::new(db);\n    service.update_avatar_url(user_id, \u0026url).await?;\n\n    Ok(ApiResponse::ok(UploadResponse { url }))\n}\n\n/// Upload a general image (for posts, comments, etc.).\n/// POST /upload/image (multipart form: field \"file\")\npub async fn upload_image(\n    Extension(config): Extension\u003cUploadConfig\u003e,\n    _auth_user: AuthUser,\n    mut multipart: Multipart,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let field = multipart\n        .next_field()\n        .await\n        .map_err(|e| AppError::Validation(format!(\"Failed to read upload: {}\", e)))?\n        .ok_or_else(|| AppError::Validation(\"No file provided\".to_string()))?;\n\n    let content_type = field\n        .content_type()\n        .unwrap_or(\"application/octet-stream\")\n        .to_string();\n\n    let data = field\n        .bytes()\n        .await\n        .map_err(|e| AppError::Validation(format!(\"Failed to read file data: {}\", e)))?;\n\n    let url = UploadService::save_file(\u0026config, \u0026data, \u0026content_type, \"images\").await?;\n\n    Ok(ApiResponse::ok(UploadResponse { url }))\n}\n","traces":[{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":25},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","user.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::models::UserModel;\nuse crate::response::ApiResponse;\nuse crate::services::user::UserService;\nuse axum::{extract::Path, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\nuse validator::Validate;\n\n#[derive(Debug, Serialize)]\npub struct UserProfileResponse {\n    pub id: i32,\n    pub username: String,\n    pub avatar_url: Option\u003cString\u003e,\n    pub bio: Option\u003cString\u003e,\n    pub karma: i32,\n    pub created_at: String,\n}\n\nimpl From\u003cUserModel\u003e for UserProfileResponse {\n    fn from(u: UserModel) -\u003e Self {\n        Self {\n            id: u.id,\n            username: u.username,\n            avatar_url: u.avatar_url,\n            bio: u.bio,\n            karma: u.karma,\n            created_at: u.created_at.to_string(),\n        }\n    }\n}\n\n#[derive(Debug, Deserialize, Validate)]\npub struct UpdateProfileRequest {\n    #[validate(length(max = 500))]\n    pub bio: Option\u003cString\u003e,\n    #[validate(length(max = 500))]\n    pub avatar_url: Option\u003cString\u003e,\n}\n\npub async fn get_user_profile(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Path(username): Path\u003cString\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let service = UserService::new(db);\n    let user = service.get_by_username(\u0026username).await?;\n    Ok(ApiResponse::ok(UserProfileResponse::from(user)))\n}\n\npub async fn update_profile(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    auth_user: AuthUser,\n    Json(payload): Json\u003cUpdateProfileRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    payload\n        .validate()\n        .map_err(|e| AppError::Validation(e.to_string()))?;\n\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = UserService::new(db);\n    let user = service\n        .update_profile(user_id, payload.bio, payload.avatar_url)\n        .await?;\n\n    Ok(ApiResponse::ok(UserProfileResponse::from(user)))\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["C:","\\","Users","yimo","Codes","xjy","src","handlers","vote.rs"],"content":"use crate::error::AppResult;\nuse crate::middleware::auth::parse_user_id;\nuse crate::middleware::AuthUser;\nuse crate::response::ApiResponse;\nuse crate::services::comment::CommentService;\nuse crate::services::notification::NotificationService;\nuse crate::services::post::PostService;\nuse crate::services::vote::VoteService;\nuse crate::websocket::hub::NotificationHub;\nuse axum::{extract::Path, response::IntoResponse, Extension, Json};\nuse sea_orm::DatabaseConnection;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Debug, Deserialize)]\npub struct VoteRequest {\n    pub value: i16,\n}\n\n#[derive(Debug, Serialize)]\npub struct VoteResponse {\n    pub target_type: String,\n    pub target_id: i32,\n    pub value: i16,\n}\n\npub async fn vote_post(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cVoteRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = VoteService::new(db.clone());\n    let vote = service.vote(user_id, \"post\", id, payload.value).await?;\n\n    // Notify post author on vote (not on toggle-off)\n    if vote.value != 0 {\n        let post_service = PostService::new(db.clone());\n        if let Ok(post) = post_service.get_by_id(id).await {\n            let notif = NotificationService::new(db, hub);\n            let _ = notif\n                .notify(\n                    post.user_id,\n                    user_id,\n                    \"vote_on_post\",\n                    \"post\",\n                    id,\n                    \"Someone voted on your post\",\n                )\n                .await;\n        }\n    }\n\n    Ok(ApiResponse::ok(VoteResponse {\n        target_type: \"post\".to_string(),\n        target_id: id,\n        value: vote.value,\n    }))\n}\n\npub async fn vote_comment(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n    auth_user: AuthUser,\n    Path(id): Path\u003ci32\u003e,\n    Json(payload): Json\u003cVoteRequest\u003e,\n) -\u003e AppResult\u003cimpl IntoResponse\u003e {\n    let user_id = parse_user_id(\u0026auth_user)?;\n\n    let service = VoteService::new(db.clone());\n    let vote = service.vote(user_id, \"comment\", id, payload.value).await?;\n\n    // Notify comment author on vote (not on toggle-off)\n    if vote.value != 0 {\n        let comment_service = CommentService::new(db.clone());\n        if let Ok(comment) = comment_service.get_by_id(id).await {\n            let notif = NotificationService::new(db, hub);\n            let _ = notif\n                .notify(\n                    comment.user_id,\n                    user_id,\n                    \"vote_on_comment\",\n                    \"comment\",\n                    id,\n                    \"Someone voted on your comment\",\n                )\n                .await;\n        }\n    }\n\n    Ok(ApiResponse::ok(VoteResponse {\n        target_type: \"comment\".to_string(),\n        target_id: id,\n        value: vote.value,\n    }))\n}\n","traces":[{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":34},{"path":["C:","\\","Users","yimo","Codes","xjy","src","lib.rs"],"content":"pub mod config;\npub mod error;\npub mod handlers;\npub mod middleware;\npub mod migration;\npub mod models;\npub mod response;\npub mod routes;\npub mod services;\npub mod utils;\npub mod websocket;\n\npub use error::{AppError, AppResult};\npub use middleware::auth::AuthUser;\npub use response::{ApiResponse, PaginatedResponse, PaginationQuery};\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","main.rs"],"content":"mod config;\nmod error;\nmod handlers;\nmod middleware;\nmod migration;\nmod models;\nmod response;\nmod routes;\nmod services;\nmod utils;\nmod websocket;\n\nuse axum::{extract::Extension, response::IntoResponse, routing::get, Json, Router};\nuse sea_orm::{ConnectionTrait, DatabaseConnection, Statement};\nuse sea_orm_migration::MigratorTrait;\nuse serde_json::json;\nuse services::cache::CacheService;\nuse services::upload::UploadConfig;\nuse std::env;\nuse std::net::SocketAddr;\nuse tower_http::cors::CorsLayer;\nuse tower_http::services::ServeDir;\nuse tower_http::trace::TraceLayer;\nuse tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};\n// use utoipa::OpenApi;\nuse websocket::hub::NotificationHub;\n\n/*\n#[derive(OpenApi)]\n#[openapi(\n    paths(\n        health_check,\n        // Auth routes\n        crate::handlers::register,\n        crate::handlers::login,\n        crate::handlers::auth::refresh_token,\n        crate::handlers::get_current_user,\n        crate::handlers::change_password,\n        crate::handlers::verify_email,\n        crate::handlers::resend_verification,\n        crate::handlers::auth::forgot_password,\n        crate::handlers::auth::reset_password,\n        // User routes\n        crate::handlers::user::get_user_profile,\n        crate::handlers::user::update_profile,\n        // Forum routes\n        crate::handlers::forum::list_forums,\n        crate::handlers::forum::get_forum,\n        crate::handlers::forum::create_forum,\n        crate::handlers::forum::update_forum,\n        crate::handlers::forum::delete_forum,\n        // Post routes\n        crate::handlers::post::list_posts,\n        crate::handlers::post::get_post,\n        crate::handlers::post::create_post,\n        crate::handlers::post::update_post,\n        crate::handlers::post::delete_post,\n        crate::handlers::post::pin_post,\n        crate::handlers::post::lock_post,\n        crate::handlers::post::search_posts,\n        // Comment routes\n        crate::handlers::comment::list_comments,\n        crate::handlers::comment::create_comment,\n        crate::handlers::comment::update_comment,\n        crate::handlers::comment::delete_comment,\n        // Tag routes\n        crate::handlers::tag::list_tags,\n        crate::handlers::tag::get_posts_by_tag,\n        // Vote routes\n        crate::handlers::vote::vote_post,\n        crate::handlers::vote::vote_comment,\n        // Follow routes\n        crate::handlers::follow::list_followers,\n        crate::handlers::follow::list_following,\n        crate::handlers::follow::toggle_follow,\n        // Notification routes\n        crate::handlers::notification::list_notifications,\n        crate::handlers::notification::unread_count,\n        crate::handlers::notification::mark_all_read,\n        crate::handlers::notification::mark_read,\n        // Bookmark routes\n        crate::handlers::bookmark::toggle_bookmark,\n        crate::handlers::bookmark::list_bookmarks,\n        // Upload routes\n        crate::handlers::upload::upload_avatar,\n        crate::handlers::upload::upload_image,\n        // Report routes\n        crate::handlers::report::create_report,\n        crate::handlers::report::list_reports,\n        crate::handlers::report::resolve_report,\n        // Admin routes\n        crate::handlers::admin::get_stats,\n        crate::handlers::admin::list_users,\n        crate::handlers::admin::update_user_role,\n        crate::handlers::admin::admin_delete_post,\n        crate::handlers::admin::admin_delete_comment,\n    ),\n    components(\n        schemas(\n            crate::response::ApiResponse,\n            crate::response::PaginatedResponse,\n            crate::handlers::auth::RegisterRequest,\n            crate::handlers::auth::LoginRequest,\n            crate::handlers::auth::RefreshTokenRequest,\n            crate::handlers::auth::AuthResponse,\n            crate::handlers::auth::RegisterResponse,\n            crate::handlers::auth::TokenResponse,\n            crate::handlers::auth::UserResponse,\n            crate::handlers::auth::ChangePasswordRequest,\n            crate::handlers::auth::VerifyEmailRequest,\n            crate::handlers::auth::ForgotPasswordRequest,\n            crate::handlers::auth::ResetPasswordRequest,\n            crate::models::UserModel,\n            crate::models::ForumModel,\n            crate::models::PostModel,\n            crate::models::CommentModel,\n            crate::models::TagModel,\n            crate::models::VoteModel,\n            crate::models::FollowModel,\n            crate::models::NotificationModel,\n            crate::models::BookmarkModel,\n            crate::models::ReportModel,\n            crate::error::AppError,\n        )\n    ),\n    tags(\n        (name = \"auth\", description = \"Authentication operations\"),\n        (name = \"users\", description = \"User profile operations\"),\n        (name = \"forums\", description = \"Forum management operations\"),\n        (name = \"posts\", description = \"Post management operations\"),\n        (name = \"comments\", description = \"Comment management operations\"),\n        (name = \"tags\", description = \"Tag management operations\"),\n        (name = \"votes\", description = \"Voting operations\"),\n        (name = \"follows\", description = \"Follow operations\"),\n        (name = \"notifications\", description = \"Notification operations\"),\n        (name = \"bookmarks\", description = \"Bookmark operations\"),\n        (name = \"uploads\", description = \"File upload operations\"),\n        (name = \"reports\", description = \"Report management operations\"),\n        (name = \"admin\", description = \"Administrative operations\"),\n    )\n)]\nstruct ApiDoc;\n*/\n\n#[tokio::main]\nasync fn main() -\u003e anyhow::Result\u003c()\u003e {\n    dotenv::dotenv().ok();\n\n    tracing_subscriber::registry()\n        .with(\n            tracing_subscriber::EnvFilter::try_from_default_env()\n                .unwrap_or_else(|_| \"xjy=debug,tower_http=debug,axum=debug\".into()),\n        )\n        .with(tracing_subscriber::fmt::layer())\n        .init();\n\n    // Validate configuration before doing anything else\n    let jwt_config = validate_config()?;\n\n    // Initialize JWT config\n    utils::jwt::init_jwt_config(jwt_config)?;\n\n    tracing::info!(\"Starting Forum API v{}...\", env!(\"CARGO_PKG_VERSION\"));\n\n    let db = config::database::get_database().await?;\n    tracing::info!(\"Database connected successfully\");\n\n    migration::Migrator::up(\u0026db, None).await?;\n    tracing::info!(\"Database migrations applied successfully\");\n\n    let hub = NotificationHub::new();\n\n    let upload_dir = env::var(\"UPLOAD_DIR\").unwrap_or_else(|_| \"./uploads\".to_string());\n    let upload_config = UploadConfig {\n        upload_dir: upload_dir.clone(),\n    };\n\n    // Redis/Cache is optional - graceful degradation if unavailable\n    let cache = match config::redis::get_redis().await {\n        Ok(conn) =\u003e {\n            tracing::info!(\"Redis connected successfully\");\n            Some(CacheService::new(conn))\n        }\n        Err(e) =\u003e {\n            tracing::warn!(\"Redis unavailable, running without cache: {}\", e);\n            None\n        }\n    };\n\n    let email_service = services::email::EmailService::from_env();\n    if email_service.is_configured() {\n        tracing::info!(\"SMTP email service configured\");\n    } else {\n        tracing::warn!(\"SMTP not configured, emails will be skipped\");\n    }\n\n    let mut app = create_app(\u0026upload_dir)\n        .layer(Extension(db))\n        .layer(Extension(hub))\n        .layer(Extension(upload_config))\n        .layer(Extension(email_service));\n\n    if let Some(cache) = cache {\n        app = app.layer(Extension(cache));\n    }\n\n    let host = env::var(\"HOST\").unwrap_or_else(|_| \"127.0.0.1\".to_string());\n    let port = env::var(\"PORT\").unwrap_or_else(|_| \"3000\".to_string());\n    let addr = format!(\"{}:{}\", host, port);\n\n    let listener = tokio::net::TcpListener::bind(\u0026addr).await?;\n    tracing::info!(\"Listening on http://{}\", addr);\n\n    axum::serve(\n        listener,\n        app.into_make_service_with_connect_info::\u003cSocketAddr\u003e(),\n    )\n    .with_graceful_shutdown(shutdown_signal())\n    .await?;\n\n    tracing::info!(\"Server shut down gracefully\");\n    Ok(())\n}\n\n/// Validate all required configuration at startup (fail-fast).\nfn validate_config() -\u003e anyhow::Result\u003ccrate::config::jwt::JwtConfig\u003e {\n    // JWT config  validated and cached\n    let jwt_config = config::jwt::JwtConfig::from_env()?;\n\n    // DATABASE_URL  checked here for early error; actual connection happens later\n    if env::var(\"DATABASE_URL\").is_err() {\n        return Err(anyhow::anyhow!(\n            \"DATABASE_URL environment variable must be set\"\n        ));\n    }\n\n    // Upload directory  create if needed\n    let upload_dir = env::var(\"UPLOAD_DIR\").unwrap_or_else(|_| \"./uploads\".to_string());\n    std::fs::create_dir_all(\u0026upload_dir).map_err(|e| {\n        anyhow::anyhow!(\"Failed to create upload directory '{}': {}\", upload_dir, e)\n    })?;\n\n    Ok(jwt_config)\n}\n\nfn build_cors_layer() -\u003e CorsLayer {\n    use axum::http::{header, HeaderValue, Method};\n\n    let origins_str = env::var(\"CORS_ORIGINS\").unwrap_or_else(|_| \"*\".to_string());\n\n    let cors = CorsLayer::new()\n        .allow_methods([\n            Method::GET,\n            Method::POST,\n            Method::PUT,\n            Method::DELETE,\n            Method::OPTIONS,\n        ])\n        .allow_headers([header::AUTHORIZATION, header::CONTENT_TYPE]);\n\n    if origins_str == \"*\" {\n        cors.allow_origin(tower_http::cors::Any)\n    } else {\n        let origins: Vec\u003cHeaderValue\u003e = origins_str\n            .split(',')\n            .filter_map(|s| s.trim().parse().ok())\n            .collect();\n        cors.allow_origin(origins)\n    }\n}\n\nfn create_app(upload_dir: \u0026str) -\u003e Router {\n    Router::new()\n        .route(\"/\", get(health_check))\n        .merge(routes::create_routes())\n        .nest_service(\"/uploads\", ServeDir::new(upload_dir))\n        .layer(TraceLayer::new_for_http())\n        .layer(build_cors_layer())\n}\n\n#[utoipa::path(\n    get,\n    path = \"/\",\n    responses(\n        (status = 200, description = \"Health check successful\", body = serde_json::Value)\n    )\n)]\nasync fn health_check(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n) -\u003e impl IntoResponse {\n    let db_ok = db\n        .query_one(Statement::from_string(\n            sea_orm::DatabaseBackend::Postgres,\n            \"SELECT 1\".to_string(),\n        ))\n        .await\n        .is_ok();\n\n    let status = if db_ok { \"ok\" } else { \"degraded\" };\n\n    Json(json!({\n        \"status\": status,\n        \"service\": \"Forum API\",\n        \"version\": env!(\"CARGO_PKG_VERSION\"),\n        \"database\": db_ok,\n    }))\n}\n\nasync fn shutdown_signal() {\n    tokio::signal::ctrl_c()\n        .await\n        .expect(\"Failed to install CTRL+C signal handler\");\n    tracing::info!(\"Shutdown signal received, gracefully shutting down...\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","middleware","auth.rs"],"content":"use crate::{error::AppError, models::User, utils::jwt::decode_jwt};\nuse axum::{extract::Request, http::HeaderMap, middleware::Next, response::Response, Extension};\nuse sea_orm::{DatabaseConnection, EntityTrait};\n\n/// Extracted user information from JWT token\n#[derive(Debug, Clone)]\npub struct AuthUser {\n    pub user_id: String,\n}\n\n/// JWT authentication middleware\n///\n/// Verifies the JWT token from the Authorization header,\n/// checks the user is not banned, and adds user info to request extensions.\npub async fn auth_middleware(\n    Extension(db): Extension\u003cDatabaseConnection\u003e,\n    headers: HeaderMap,\n    mut request: Request,\n    next: Next,\n) -\u003e Result\u003cResponse, AppError\u003e {\n    // Extract Authorization header\n    let auth_header = headers\n        .get(\"Authorization\")\n        .and_then(|h| h.to_str().ok())\n        .ok_or(AppError::Unauthorized)?;\n\n    // Parse Bearer token\n    if !auth_header.starts_with(\"Bearer \") {\n        return Err(AppError::Unauthorized);\n    }\n\n    let token = \u0026auth_header[7..]; // Skip \"Bearer \"\n\n    // Verify JWT\n    let claims = decode_jwt(token)?;\n\n    // Check user is not banned\n    let user_id: i32 = claims\n        .sub\n        .parse()\n        .map_err(|_| AppError::Validation(\"Invalid user ID in token\".to_string()))?;\n\n    let user = User::find_by_id(user_id)\n        .one(\u0026db)\n        .await?\n        .ok_or(AppError::Unauthorized)?;\n\n    if user.role == \"banned\" {\n        return Err(AppError::Forbidden);\n    }\n\n    // Add user info to request extensions\n    let auth_user = AuthUser {\n        user_id: claims.sub,\n    };\n    request.extensions_mut().insert(auth_user);\n\n    // Continue to next handler\n    Ok(next.run(request).await)\n}\n\n/// Parse user_id from AuthUser string to i32\npub fn parse_user_id(auth_user: \u0026AuthUser) -\u003e crate::error::AppResult\u003ci32\u003e {\n    auth_user\n        .user_id\n        .parse()\n        .map_err(|_| AppError::Validation(\"Invalid user ID\".to_string()))\n}\n\n/// Verify the current user has admin role\npub async fn require_admin(\n    db: \u0026sea_orm::DatabaseConnection,\n    auth_user: \u0026AuthUser,\n) -\u003e crate::error::AppResult\u003ci32\u003e {\n    let user_id = parse_user_id(auth_user)?;\n    let auth_service = crate::services::auth::AuthService::new(db.clone());\n    let user = auth_service.get_user_by_id(user_id).await?;\n    if user.role != \"admin\" {\n        return Err(AppError::Forbidden);\n    }\n    Ok(user_id)\n}\n\n/// Extractor for AuthUser from request extensions\nuse axum::extract::FromRequestParts;\n\nimpl\u003cS\u003e FromRequestParts\u003cS\u003e for AuthUser\nwhere\n    S: Send + Sync,\n{\n    type Rejection = AppError;\n\n    async fn from_request_parts(\n        parts: \u0026mut axum::http::request::Parts,\n        _state: \u0026S,\n    ) -\u003e Result\u003cSelf, Self::Rejection\u003e {\n        parts\n            .extensions\n            .get::\u003cAuthUser\u003e()\n            .cloned()\n            .ok_or(AppError::Unauthorized)\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":35},{"path":["C:","\\","Users","yimo","Codes","xjy","src","middleware","mod.rs"],"content":"pub mod auth;\n\npub use auth::*;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000001_create_users_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n    Username,\n    Email,\n    PasswordHash,\n    AvatarUrl,\n    Bio,\n    Karma,\n    Role,\n    CreatedAt,\n    UpdatedAt,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Users::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Users::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Users::Username)\n                            .string_len(50)\n                            .not_null()\n                            .unique_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Users::Email)\n                            .string_len(255)\n                            .not_null()\n                            .unique_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Users::PasswordHash)\n                            .string_len(255)\n                            .not_null(),\n                    )\n                    .col(ColumnDef::new(Users::AvatarUrl).string_len(500).null())\n                    .col(ColumnDef::new(Users::Bio).text().null())\n                    .col(ColumnDef::new(Users::Karma).integer().not_null().default(0))\n                    .col(\n                        ColumnDef::new(Users::Role)\n                            .string_len(20)\n                            .not_null()\n                            .default(\"user\"),\n                    )\n                    .col(\n                        ColumnDef::new(Users::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .col(\n                        ColumnDef::new(Users::UpdatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Users::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000002_create_forums_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Forums {\n    Table,\n    Id,\n    Name,\n    Description,\n    Slug,\n    SortOrder,\n    IconUrl,\n    CreatedAt,\n    UpdatedAt,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Forums::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Forums::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::Name)\n                            .string_len(100)\n                            .not_null()\n                            .unique_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::Description)\n                            .string_len(500)\n                            .not_null(),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::Slug)\n                            .string_len(100)\n                            .not_null()\n                            .unique_key(),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::SortOrder)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(ColumnDef::new(Forums::IconUrl).string_len(500).null())\n                    .col(\n                        ColumnDef::new(Forums::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .col(\n                        ColumnDef::new(Forums::UpdatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Forums::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000003_create_posts_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Posts {\n    Table,\n    Id,\n    UserId,\n    ForumId,\n    Title,\n    Content,\n    Upvotes,\n    Downvotes,\n    ViewCount,\n    IsPinned,\n    IsLocked,\n    CreatedAt,\n    UpdatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[derive(DeriveIden)]\nenum Forums {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Posts::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Posts::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Posts::UserId).integer().not_null())\n                    .col(ColumnDef::new(Posts::ForumId).integer().not_null())\n                    .col(ColumnDef::new(Posts::Title).string_len(200).not_null())\n                    .col(ColumnDef::new(Posts::Content).text().not_null())\n                    .col(\n                        ColumnDef::new(Posts::Upvotes)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::Downvotes)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::ViewCount)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::IsPinned)\n                            .boolean()\n                            .not_null()\n                            .default(false),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::IsLocked)\n                            .boolean()\n                            .not_null()\n                            .default(false),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .col(\n                        ColumnDef::new(Posts::UpdatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_posts_user_id\")\n                            .from(Posts::Table, Posts::UserId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_posts_forum_id\")\n                            .from(Posts::Table, Posts::ForumId)\n                            .to(Forums::Table, Forums::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_posts_forum_id\")\n                    .table(Posts::Table)\n                    .col(Posts::ForumId)\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_posts_user_id\")\n                    .table(Posts::Table)\n                    .col(Posts::UserId)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Posts::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000004_create_comments_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Comments {\n    Table,\n    Id,\n    PostId,\n    UserId,\n    ParentId,\n    Content,\n    Upvotes,\n    Downvotes,\n    CreatedAt,\n    UpdatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Posts {\n    Table,\n    Id,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Comments::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Comments::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Comments::PostId).integer().not_null())\n                    .col(ColumnDef::new(Comments::UserId).integer().not_null())\n                    .col(ColumnDef::new(Comments::ParentId).integer().null())\n                    .col(ColumnDef::new(Comments::Content).text().not_null())\n                    .col(\n                        ColumnDef::new(Comments::Upvotes)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Comments::Downvotes)\n                            .integer()\n                            .not_null()\n                            .default(0),\n                    )\n                    .col(\n                        ColumnDef::new(Comments::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .col(\n                        ColumnDef::new(Comments::UpdatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_comments_post_id\")\n                            .from(Comments::Table, Comments::PostId)\n                            .to(Posts::Table, Posts::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_comments_user_id\")\n                            .from(Comments::Table, Comments::UserId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_comments_parent_id\")\n                            .from(Comments::Table, Comments::ParentId)\n                            .to(Comments::Table, Comments::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_comments_post_id\")\n                    .table(Comments::Table)\n                    .col(Comments::PostId)\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_comments_user_id\")\n                    .table(Comments::Table)\n                    .col(Comments::UserId)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Comments::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000005_create_votes_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Votes {\n    Table,\n    Id,\n    UserId,\n    TargetType,\n    TargetId,\n    Value,\n    CreatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Votes::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Votes::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Votes::UserId).integer().not_null())\n                    .col(ColumnDef::new(Votes::TargetType).string_len(20).not_null())\n                    .col(ColumnDef::new(Votes::TargetId).integer().not_null())\n                    .col(ColumnDef::new(Votes::Value).small_integer().not_null())\n                    .col(\n                        ColumnDef::new(Votes::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_votes_user_id\")\n                            .from(Votes::Table, Votes::UserId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_votes_unique\")\n                    .table(Votes::Table)\n                    .col(Votes::UserId)\n                    .col(Votes::TargetType)\n                    .col(Votes::TargetId)\n                    .unique()\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_votes_target\")\n                    .table(Votes::Table)\n                    .col(Votes::TargetType)\n                    .col(Votes::TargetId)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Votes::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000006_add_comment_parent_index.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Comments {\n    Table,\n    ParentId,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_comments_parent_id\")\n                    .table(Comments::Table)\n                    .col(Comments::ParentId)\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_index(\n                Index::drop()\n                    .name(\"idx_comments_parent_id\")\n                    .table(Comments::Table)\n                    .to_owned(),\n            )\n            .await\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000007_add_search_index.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        // Add generated tsvector column for full-text search\n        db.execute_unprepared(\n            \"ALTER TABLE posts ADD COLUMN search_vector tsvector \\\n             GENERATED ALWAYS AS (\\\n                 to_tsvector('english', coalesce(title, '') || ' ' || coalesce(content, ''))\\\n             ) STORED\",\n        )\n        .await?;\n\n        // Create GIN index for fast full-text search\n        db.execute_unprepared(\"CREATE INDEX idx_posts_search ON posts USING GIN (search_vector)\")\n            .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"DROP INDEX IF EXISTS idx_posts_search\")\n            .await?;\n\n        db.execute_unprepared(\"ALTER TABLE posts DROP COLUMN IF EXISTS search_vector\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000008_create_notifications_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Notifications {\n    Table,\n    Id,\n    UserId,\n    Kind,\n    ActorId,\n    TargetType,\n    TargetId,\n    Message,\n    IsRead,\n    CreatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Notifications::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Notifications::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Notifications::UserId).integer().not_null())\n                    .col(\n                        ColumnDef::new(Notifications::Kind)\n                            .string_len(50)\n                            .not_null(),\n                    )\n                    .col(ColumnDef::new(Notifications::ActorId).integer().not_null())\n                    .col(\n                        ColumnDef::new(Notifications::TargetType)\n                            .string_len(20)\n                            .not_null(),\n                    )\n                    .col(ColumnDef::new(Notifications::TargetId).integer().not_null())\n                    .col(ColumnDef::new(Notifications::Message).text().not_null())\n                    .col(\n                        ColumnDef::new(Notifications::IsRead)\n                            .boolean()\n                            .not_null()\n                            .default(false),\n                    )\n                    .col(\n                        ColumnDef::new(Notifications::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_notifications_user_id\")\n                            .from(Notifications::Table, Notifications::UserId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_notifications_actor_id\")\n                            .from(Notifications::Table, Notifications::ActorId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_notifications_user_id\")\n                    .table(Notifications::Table)\n                    .col(Notifications::UserId)\n                    .to_owned(),\n            )\n            .await?;\n\n        // Partial index for unread notifications\n        let db = manager.get_connection();\n        db.execute_unprepared(\n            \"CREATE INDEX idx_notifications_unread ON notifications (user_id, is_read) WHERE is_read = FALSE\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Notifications::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000009_create_reports_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[derive(DeriveIden)]\nenum Reports {\n    Table,\n    Id,\n    ReporterId,\n    TargetType,\n    TargetId,\n    Reason,\n    Description,\n    Status,\n    ResolvedBy,\n    ResolvedAt,\n    CreatedAt,\n}\n\n#[derive(DeriveIden)]\nenum Users {\n    Table,\n    Id,\n}\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .create_table(\n                Table::create()\n                    .table(Reports::Table)\n                    .if_not_exists()\n                    .col(\n                        ColumnDef::new(Reports::Id)\n                            .integer()\n                            .not_null()\n                            .auto_increment()\n                            .primary_key(),\n                    )\n                    .col(ColumnDef::new(Reports::ReporterId).integer().not_null())\n                    .col(\n                        ColumnDef::new(Reports::TargetType)\n                            .string_len(20)\n                            .not_null(),\n                    )\n                    .col(ColumnDef::new(Reports::TargetId).integer().not_null())\n                    .col(ColumnDef::new(Reports::Reason).string_len(50).not_null())\n                    .col(ColumnDef::new(Reports::Description).text().null())\n                    .col(\n                        ColumnDef::new(Reports::Status)\n                            .string_len(20)\n                            .not_null()\n                            .default(\"pending\"),\n                    )\n                    .col(ColumnDef::new(Reports::ResolvedBy).integer().null())\n                    .col(ColumnDef::new(Reports::ResolvedAt).timestamp().null())\n                    .col(\n                        ColumnDef::new(Reports::CreatedAt)\n                            .timestamp()\n                            .not_null()\n                            .default(Expr::current_timestamp()),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_reports_reporter_id\")\n                            .from(Reports::Table, Reports::ReporterId)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::Cascade),\n                    )\n                    .foreign_key(\n                        ForeignKey::create()\n                            .name(\"fk_reports_resolved_by\")\n                            .from(Reports::Table, Reports::ResolvedBy)\n                            .to(Users::Table, Users::Id)\n                            .on_delete(ForeignKeyAction::SetNull),\n                    )\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_reports_status\")\n                    .table(Reports::Table)\n                    .col(Reports::Status)\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_reports_target\")\n                    .table(Reports::Table)\n                    .col(Reports::TargetType)\n                    .col(Reports::TargetId)\n                    .to_owned(),\n            )\n            .await?;\n\n        manager\n            .create_index(\n                Index::create()\n                    .name(\"idx_reports_unique\")\n                    .table(Reports::Table)\n                    .col(Reports::ReporterId)\n                    .col(Reports::TargetType)\n                    .col(Reports::TargetId)\n                    .unique()\n                    .to_owned(),\n            )\n            .await\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        manager\n            .drop_table(Table::drop().table(Reports::Table).to_owned())\n            .await\n    }\n}\n","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000010_add_hidden_columns.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"ALTER TABLE posts ADD COLUMN is_hidden BOOLEAN NOT NULL DEFAULT FALSE\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"ALTER TABLE comments ADD COLUMN is_hidden BOOLEAN NOT NULL DEFAULT FALSE\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"ALTER TABLE posts DROP COLUMN IF EXISTS is_hidden\")\n            .await?;\n\n        db.execute_unprepared(\"ALTER TABLE comments DROP COLUMN IF EXISTS is_hidden\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000011_add_email_verification.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN email_verified BOOLEAN NOT NULL DEFAULT FALSE\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN email_verification_token VARCHAR(255) NULL\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN email_verification_expires TIMESTAMP NULL\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS email_verified\")\n            .await?;\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS email_verification_token\")\n            .await?;\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS email_verification_expires\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000012_create_bookmarks_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE TABLE IF NOT EXISTS bookmarks (\n                id SERIAL PRIMARY KEY,\n                user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                post_id INTEGER NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE UNIQUE INDEX idx_bookmarks_user_post ON bookmarks(user_id, post_id)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_bookmarks_user_id ON bookmarks(user_id)\")\n            .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n        db.execute_unprepared(\"DROP TABLE IF EXISTS bookmarks\")\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000013_create_follows_table.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE TABLE IF NOT EXISTS follows (\n                id SERIAL PRIMARY KEY,\n                follower_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                following_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n                CHECK (follower_id != following_id)\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE UNIQUE INDEX idx_follows_pair ON follows(follower_id, following_id)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_follows_follower ON follows(follower_id)\")\n            .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_follows_following ON follows(following_id)\")\n            .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n        db.execute_unprepared(\"DROP TABLE IF EXISTS follows\")\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000014_create_tags_tables.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE TABLE IF NOT EXISTS tags (\n                id SERIAL PRIMARY KEY,\n                name VARCHAR(50) NOT NULL UNIQUE,\n                slug VARCHAR(50) NOT NULL UNIQUE,\n                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_tags_slug ON tags(slug)\")\n            .await?;\n\n        db.execute_unprepared(\n            \"CREATE TABLE IF NOT EXISTS post_tags (\n                id SERIAL PRIMARY KEY,\n                post_id INTEGER NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n                tag_id INTEGER NOT NULL REFERENCES tags(id) ON DELETE CASCADE\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE UNIQUE INDEX idx_post_tags_pair ON post_tags(post_id, tag_id)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\"CREATE INDEX idx_post_tags_tag ON post_tags(tag_id)\")\n            .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n        db.execute_unprepared(\"DROP TABLE IF EXISTS post_tags\")\n            .await?;\n        db.execute_unprepared(\"DROP TABLE IF EXISTS tags\").await?;\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000015_add_password_reset.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN password_reset_token VARCHAR(255) NULL\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"ALTER TABLE users ADD COLUMN password_reset_expires TIMESTAMP NULL\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE INDEX idx_users_password_reset_token ON users (password_reset_token) WHERE password_reset_token IS NOT NULL\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"DROP INDEX IF EXISTS idx_users_password_reset_token\")\n            .await?;\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS password_reset_token\")\n            .await?;\n        db.execute_unprepared(\"ALTER TABLE users DROP COLUMN IF EXISTS password_reset_expires\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000016_create_refresh_tokens.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE TABLE refresh_tokens (\n                id SERIAL PRIMARY KEY,\n                user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                token VARCHAR(255) NOT NULL UNIQUE,\n                expires_at TIMESTAMP NOT NULL,\n                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP\n            )\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE INDEX idx_refresh_tokens_token ON refresh_tokens (token)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens (user_id)\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n        db.execute_unprepared(\"DROP TABLE IF EXISTS refresh_tokens\")\n            .await?;\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","m20240101_000017_add_performance_indexes.rs"],"content":"use sea_orm_migration::prelude::*;\n\n#[derive(DeriveMigrationName)]\npub struct Migration;\n\n#[async_trait::async_trait]\nimpl MigrationTrait for Migration {\n    async fn up(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\n            \"CREATE INDEX IF NOT EXISTS idx_notifications_user_created\n             ON notifications (user_id, created_at DESC)\",\n        )\n        .await?;\n\n        db.execute_unprepared(\n            \"CREATE INDEX IF NOT EXISTS idx_posts_forum_visible_created\n             ON posts (forum_id, is_hidden, created_at DESC)\",\n        )\n        .await?;\n\n        Ok(())\n    }\n\n    async fn down(\u0026self, manager: \u0026SchemaManager) -\u003e Result\u003c(), DbErr\u003e {\n        let db = manager.get_connection();\n\n        db.execute_unprepared(\"DROP INDEX IF EXISTS idx_notifications_user_created\")\n            .await?;\n        db.execute_unprepared(\"DROP INDEX IF EXISTS idx_posts_forum_visible_created\")\n            .await?;\n\n        Ok(())\n    }\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","migration","mod.rs"],"content":"use sea_orm_migration::prelude::*;\n\nmod m20240101_000001_create_users_table;\nmod m20240101_000002_create_forums_table;\nmod m20240101_000003_create_posts_table;\nmod m20240101_000004_create_comments_table;\nmod m20240101_000005_create_votes_table;\nmod m20240101_000006_add_comment_parent_index;\nmod m20240101_000007_add_search_index;\nmod m20240101_000008_create_notifications_table;\nmod m20240101_000009_create_reports_table;\nmod m20240101_000010_add_hidden_columns;\nmod m20240101_000011_add_email_verification;\nmod m20240101_000012_create_bookmarks_table;\nmod m20240101_000013_create_follows_table;\nmod m20240101_000014_create_tags_tables;\nmod m20240101_000015_add_password_reset;\nmod m20240101_000016_create_refresh_tokens;\nmod m20240101_000017_add_performance_indexes;\n\npub struct Migrator;\n\n#[async_trait::async_trait]\nimpl MigratorTrait for Migrator {\n    fn migrations() -\u003e Vec\u003cBox\u003cdyn MigrationTrait\u003e\u003e {\n        vec![\n            Box::new(m20240101_000001_create_users_table::Migration),\n            Box::new(m20240101_000002_create_forums_table::Migration),\n            Box::new(m20240101_000003_create_posts_table::Migration),\n            Box::new(m20240101_000004_create_comments_table::Migration),\n            Box::new(m20240101_000005_create_votes_table::Migration),\n            Box::new(m20240101_000006_add_comment_parent_index::Migration),\n            Box::new(m20240101_000007_add_search_index::Migration),\n            Box::new(m20240101_000008_create_notifications_table::Migration),\n            Box::new(m20240101_000009_create_reports_table::Migration),\n            Box::new(m20240101_000010_add_hidden_columns::Migration),\n            Box::new(m20240101_000011_add_email_verification::Migration),\n            Box::new(m20240101_000012_create_bookmarks_table::Migration),\n            Box::new(m20240101_000013_create_follows_table::Migration),\n            Box::new(m20240101_000014_create_tags_tables::Migration),\n            Box::new(m20240101_000015_add_password_reset::Migration),\n            Box::new(m20240101_000016_create_refresh_tokens::Migration),\n            Box::new(m20240101_000017_add_performance_indexes::Migration),\n        ]\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":19},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","bookmark.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"bookmarks\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    pub post_id: i32,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n    #[sea_orm(\n        belongs_to = \"super::post::Entity\",\n        from = \"Column::PostId\",\n        to = \"super::post::Column::Id\"\n    )]\n    Post,\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl Related\u003csuper::post::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Post.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","comment.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"comments\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub post_id: i32,\n    pub user_id: i32,\n    pub parent_id: Option\u003ci32\u003e,\n    #[sea_orm(column_type = \"Text\")]\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub is_hidden: bool,\n    pub created_at: DateTime,\n    pub updated_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::post::Entity\",\n        from = \"Column::PostId\",\n        to = \"super::post::Column::Id\"\n    )]\n    Post,\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n    #[sea_orm(belongs_to = \"Entity\", from = \"Column::ParentId\", to = \"Column::Id\")]\n    Parent,\n}\n\nimpl Related\u003csuper::post::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Post.def()\n    }\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","follow.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"follows\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub follower_id: i32,\n    pub following_id: i32,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","forum.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize, ToSchema)]\n#[sea_orm(table_name = \"forums\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    #[sea_orm(unique)]\n    pub name: String,\n    pub description: String,\n    #[sea_orm(unique)]\n    pub slug: String,\n    pub sort_order: i32,\n    pub icon_url: Option\u003cString\u003e,\n    pub created_at: DateTime,\n    pub updated_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","mod.rs"],"content":"pub mod bookmark;\npub mod comment;\npub mod follow;\npub mod forum;\npub mod notification;\npub mod post;\npub mod post_tag;\npub mod refresh_token;\npub mod report;\npub mod tag;\npub mod user;\npub mod vote;\n\npub use bookmark::Entity as Bookmark;\npub use comment::{Entity as Comment, Model as CommentModel};\npub use follow::Entity as Follow;\npub use forum::{Entity as Forum, Model as ForumModel};\npub use notification::{Entity as Notification, Model as NotificationModel};\npub use post::{Entity as Post, Model as PostModel};\n#[allow(unused_imports)]\npub use post_tag::Entity as PostTag;\n#[allow(unused_imports)]\npub use refresh_token::Entity as RefreshToken;\npub use report::{Entity as Report, Model as ReportModel};\npub use tag::{Entity as Tag, Model as TagModel};\npub use user::{Entity as User, Model as UserModel};\npub use vote::{Entity as Vote, Model as VoteModel};\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","notification.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"notifications\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    #[sea_orm(column_type = \"String(StringLen::N(50))\")]\n    pub kind: String,\n    pub actor_id: i32,\n    #[sea_orm(column_type = \"String(StringLen::N(20))\")]\n    pub target_type: String,\n    pub target_id: i32,\n    #[sea_orm(column_type = \"Text\")]\n    pub message: String,\n    pub is_read: bool,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::ActorId\",\n        to = \"super::user::Column::Id\"\n    )]\n    Actor,\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","post.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize, ToSchema)]\n#[sea_orm(table_name = \"posts\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    pub forum_id: i32,\n    pub title: String,\n    #[sea_orm(column_type = \"Text\")]\n    pub content: String,\n    pub upvotes: i32,\n    pub downvotes: i32,\n    pub view_count: i32,\n    pub is_pinned: bool,\n    pub is_locked: bool,\n    pub is_hidden: bool,\n    pub created_at: DateTime,\n    pub updated_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n    #[sea_orm(\n        belongs_to = \"super::forum::Entity\",\n        from = \"Column::ForumId\",\n        to = \"super::forum::Column::Id\"\n    )]\n    Forum,\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl Related\u003csuper::forum::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Forum.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","post_tag.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"post_tags\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub post_id: i32,\n    pub tag_id: i32,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::post::Entity\",\n        from = \"Column::PostId\",\n        to = \"super::post::Column::Id\"\n    )]\n    Post,\n    #[sea_orm(\n        belongs_to = \"super::tag::Entity\",\n        from = \"Column::TagId\",\n        to = \"super::tag::Column::Id\"\n    )]\n    Tag,\n}\n\nimpl Related\u003csuper::post::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Post.def()\n    }\n}\n\nimpl Related\u003csuper::tag::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::Tag.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","refresh_token.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"refresh_tokens\")]\n#[allow(dead_code)]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    #[sea_orm(unique)]\n    pub token: String,\n    pub expires_at: DateTime,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\n#[allow(dead_code)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","report.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"reports\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub reporter_id: i32,\n    #[sea_orm(column_type = \"String(StringLen::N(20))\")]\n    pub target_type: String,\n    pub target_id: i32,\n    #[sea_orm(column_type = \"String(StringLen::N(50))\")]\n    pub reason: String,\n    #[sea_orm(column_type = \"Text\", nullable)]\n    pub description: Option\u003cString\u003e,\n    #[sea_orm(column_type = \"String(StringLen::N(20))\")]\n    pub status: String,\n    pub resolved_by: Option\u003ci32\u003e,\n    pub resolved_at: Option\u003cDateTime\u003e,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::ReporterId\",\n        to = \"super::user::Column::Id\"\n    )]\n    Reporter,\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::ResolvedBy\",\n        to = \"super::user::Column::Id\"\n    )]\n    Resolver,\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","tag.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize, ToSchema)]\n#[sea_orm(table_name = \"tags\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub name: String,\n    pub slug: String,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","user.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize, ToSchema)]\n#[sea_orm(table_name = \"users\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub username: String,\n    pub email: String,\n    #[serde(skip_serializing)]\n    pub password_hash: String,\n    pub avatar_url: Option\u003cString\u003e,\n    pub bio: Option\u003cString\u003e,\n    pub karma: i32,\n    pub role: String,\n    pub email_verified: bool,\n    pub email_verification_token: Option\u003cString\u003e,\n    pub email_verification_expires: Option\u003cDateTime\u003e,\n    #[serde(skip_serializing)]\n    pub password_reset_token: Option\u003cString\u003e,\n    #[serde(skip_serializing)]\n    pub password_reset_expires: Option\u003cDateTime\u003e,\n    pub created_at: DateTime,\n    pub updated_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","models","vote.rs"],"content":"use sea_orm::entity::prelude::*;\nuse serde::{Deserialize, Serialize};\n\n#[derive(Clone, Debug, PartialEq, DeriveEntityModel, Serialize, Deserialize)]\n#[sea_orm(table_name = \"votes\")]\npub struct Model {\n    #[sea_orm(primary_key)]\n    pub id: i32,\n    pub user_id: i32,\n    pub target_type: String,\n    pub target_id: i32,\n    pub value: i16,\n    pub created_at: DateTime,\n}\n\n#[derive(Copy, Clone, Debug, EnumIter, DeriveRelation)]\npub enum Relation {\n    #[sea_orm(\n        belongs_to = \"super::user::Entity\",\n        from = \"Column::UserId\",\n        to = \"super::user::Column::Id\"\n    )]\n    User,\n}\n\nimpl Related\u003csuper::user::Entity\u003e for Entity {\n    fn to() -\u003e RelationDef {\n        Relation::User.def()\n    }\n}\n\nimpl ActiveModelBehavior for ActiveModel {}\n","traces":[{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["C:","\\","Users","yimo","Codes","xjy","src","response.rs"],"content":"use axum::{response::IntoResponse, Json};\nuse serde::{Deserialize, Serialize};\nuse utoipa::ToSchema;\n\n#[derive(Serialize, ToSchema)]\npub struct ApiResponse\u003cT\u003e {\n    pub success: bool,\n    pub data: Option\u003cT\u003e,\n    pub message: Option\u003cString\u003e,\n}\n\nimpl\u003cT: Serialize\u003e IntoResponse for ApiResponse\u003cT\u003e {\n    fn into_response(self) -\u003e axum::response::Response {\n        Json(self).into_response()\n    }\n}\n\n#[allow(dead_code)]\nimpl\u003cT: Serialize\u003e ApiResponse\u003cT\u003e {\n    pub fn ok(data: T) -\u003e Self {\n        Self {\n            success: true,\n            data: Some(data),\n            message: None,\n        }\n    }\n\n    pub fn with_message(data: T, message: String) -\u003e Self {\n        Self {\n            success: true,\n            data: Some(data),\n            message: Some(message),\n        }\n    }\n\n    pub fn err(message: String) -\u003e Self {\n        Self {\n            success: false,\n            message: Some(message),\n            data: None,\n        }\n    }\n}\n\n#[derive(Debug, Serialize, ToSchema)]\npub struct PaginatedResponse\u003cT: Serialize\u003e {\n    pub items: Vec\u003cT\u003e,\n    pub total: u64,\n    pub page: u64,\n    pub per_page: u64,\n    pub total_pages: u64,\n}\n\nimpl\u003cT: Serialize\u003e PaginatedResponse\u003cT\u003e {\n    pub fn new(items: Vec\u003cT\u003e, total: u64, page: u64, per_page: u64) -\u003e Self {\n        let total_pages = if per_page == 0 {\n            0\n        } else {\n            (total + per_page - 1) / per_page\n        };\n        Self {\n            items,\n            total,\n            page,\n            per_page,\n            total_pages,\n        }\n    }\n}\n\n#[derive(Debug, Deserialize, ToSchema)]\npub struct PaginationQuery {\n    pub page: Option\u003cu64\u003e,\n    pub per_page: Option\u003cu64\u003e,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn total_pages_basic() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 100, 1, 20);\n        assert_eq!(resp.total_pages, 5);\n    }\n\n    #[test]\n    fn total_pages_with_remainder() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 101, 1, 20);\n        assert_eq!(resp.total_pages, 6);\n    }\n\n    #[test]\n    fn total_pages_exact_division() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 60, 1, 20);\n        assert_eq!(resp.total_pages, 3);\n    }\n\n    #[test]\n    fn total_pages_zero_per_page() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 10, 1, 0);\n        assert_eq!(resp.total_pages, 0);\n    }\n\n    #[test]\n    fn total_pages_zero_total() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 0, 1, 20);\n        assert_eq!(resp.total_pages, 0);\n    }\n\n    #[test]\n    fn total_pages_single_item() {\n        let resp = PaginatedResponse::\u003cString\u003e::new(vec![], 1, 1, 20);\n        assert_eq!(resp.total_pages, 1);\n    }\n}\n","traces":[{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":432345564227567616}},{"line":56,"address":[],"length":0,"stats":{"Line":864691128455135232}},{"line":57,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":59,"address":[],"length":0,"stats":{"Line":360287970189639680}}],"covered":4,"coverable":13},{"path":["C:","\\","Users","yimo","Codes","xjy","src","routes","mod.rs"],"content":"use crate::handlers;\nuse crate::middleware::auth::auth_middleware;\nuse crate::websocket;\nuse axum::{middleware, routing, Router};\nuse tower_governor::{governor::GovernorConfigBuilder, GovernorLayer};\n\npub fn create_routes() -\u003e Router {\n    Router::new()\n        .nest(\"/api/v1\", api_routes())\n        // WebSocket route (auth handled inside the handler via query token)\n        .route(\"/ws\", routing::get(websocket::notification::ws_handler))\n}\n\nfn api_routes() -\u003e Router {\n    let auth = auth_routes();\n    let public_read = public_read_routes();\n    let protected = protected_routes().layer(middleware::from_fn(auth_middleware));\n\n    auth.merge(public_read).merge(protected)\n}\n\n/// Auth routes: register, login, verify-email.\n/// Rate limit: 5 req/s, burst 10.\nfn auth_routes() -\u003e Router {\n    let governor_conf = GovernorConfigBuilder::default()\n        .per_second(5)\n        .burst_size(10)\n        .finish()\n        .unwrap();\n\n    Router::new()\n        .route(\"/auth/register\", routing::post(handlers::register))\n        .route(\"/auth/login\", routing::post(handlers::login))\n        .route(\"/auth/refresh\", routing::post(handlers::auth::refresh_token))\n        .route(\n            \"/auth/verify-email\",\n            routing::post(handlers::verify_email),\n        )\n        .route(\n            \"/auth/forgot-password\",\n            routing::post(handlers::auth::forgot_password),\n        )\n        .route(\n            \"/auth/reset-password\",\n            routing::post(handlers::auth::reset_password),\n        )\n        .layer(GovernorLayer::new(governor_conf))\n}\n\n/// Public read routes: all public GETs + search.\n/// Rate limit: 30 req/s, burst 60.\nfn public_read_routes() -\u003e Router {\n    let governor_conf = GovernorConfigBuilder::default()\n        .per_second(30)\n        .burst_size(60)\n        .finish()\n        .unwrap();\n\n    Router::new()\n        // Users\n        .route(\n            \"/users/{username}\",\n            routing::get(handlers::user::get_user_profile),\n        )\n        // Forums\n        .route(\"/forums\", routing::get(handlers::forum::list_forums))\n        .route(\"/forums/{slug}\", routing::get(handlers::forum::get_forum))\n        // Posts\n        .route(\n            \"/forums/{forum_id}/posts\",\n            routing::get(handlers::post::list_posts),\n        )\n        .route(\"/posts/{id}\", routing::get(handlers::post::get_post))\n        // Comments\n        .route(\n            \"/posts/{post_id}/comments\",\n            routing::get(handlers::comment::list_comments),\n        )\n        // Search\n        .route(\"/search\", routing::get(handlers::post::search_posts))\n        // Tags\n        .route(\"/tags\", routing::get(handlers::tag::list_tags))\n        .route(\n            \"/tags/{slug}/posts\",\n            routing::get(handlers::tag::get_posts_by_tag),\n        )\n        // Follow (public reads)\n        .route(\n            \"/users/{id}/followers\",\n            routing::get(handlers::follow::list_followers),\n        )\n        .route(\n            \"/users/{id}/following\",\n            routing::get(handlers::follow::list_following),\n        )\n        .layer(GovernorLayer::new(governor_conf))\n}\n\n/// Protected routes: all authenticated writes.\n/// Rate limit: 10 req/s, burst 20.\nfn protected_routes() -\u003e Router {\n    let governor_conf = GovernorConfigBuilder::default()\n        .per_second(10)\n        .burst_size(20)\n        .finish()\n        .unwrap();\n\n    Router::new()\n        // Auth\n        .route(\"/auth/me\", routing::get(handlers::get_current_user))\n        .route(\"/auth/logout\", routing::post(handlers::auth::logout))\n        .route(\n            \"/auth/profile\",\n            routing::put(handlers::user::update_profile),\n        )\n        .route(\n            \"/auth/password\",\n            routing::put(handlers::change_password),\n        )\n        .route(\n            \"/auth/resend-verification\",\n            routing::post(handlers::resend_verification),\n        )\n        // Forums (admin only - checked in handler)\n        .route(\"/forums\", routing::post(handlers::forum::create_forum))\n        .route(\n            \"/forums/{slug}\",\n            routing::put(handlers::forum::update_forum).delete(handlers::forum::delete_forum),\n        )\n        // Posts\n        .route(\"/posts\", routing::post(handlers::post::create_post))\n        .route(\n            \"/posts/{id}\",\n            routing::put(handlers::post::update_post).delete(handlers::post::delete_post),\n        )\n        .route(\"/posts/{id}/pin\", routing::put(handlers::post::pin_post))\n        .route(\"/posts/{id}/lock\", routing::put(handlers::post::lock_post))\n        // Votes\n        .route(\"/posts/{id}/vote\", routing::post(handlers::vote::vote_post))\n        .route(\n            \"/comments/{id}/vote\",\n            routing::post(handlers::vote::vote_comment),\n        )\n        // Comments\n        .route(\n            \"/comments\",\n            routing::post(handlers::comment::create_comment),\n        )\n        .route(\n            \"/comments/{id}\",\n            routing::put(handlers::comment::update_comment)\n                .delete(handlers::comment::delete_comment),\n        )\n        // Notifications\n        .route(\n            \"/notifications\",\n            routing::get(handlers::notification::list_notifications),\n        )\n        .route(\n            \"/notifications/unread-count\",\n            routing::get(handlers::notification::unread_count),\n        )\n        .route(\n            \"/notifications/read-all\",\n            routing::put(handlers::notification::mark_all_read),\n        )\n        .route(\n            \"/notifications/{id}/read\",\n            routing::put(handlers::notification::mark_read),\n        )\n        // Admin\n        .route(\"/admin/stats\", routing::get(handlers::admin::get_stats))\n        .route(\"/admin/users\", routing::get(handlers::admin::list_users))\n        .route(\n            \"/admin/users/{id}/role\",\n            routing::put(handlers::admin::update_user_role),\n        )\n        .route(\n            \"/admin/posts/{id}\",\n            routing::delete(handlers::admin::admin_delete_post),\n        )\n        .route(\n            \"/admin/comments/{id}\",\n            routing::delete(handlers::admin::admin_delete_comment),\n        )\n        // Bookmarks\n        .route(\n            \"/posts/{id}/bookmark\",\n            routing::post(handlers::bookmark::toggle_bookmark),\n        )\n        .route(\n            \"/bookmarks\",\n            routing::get(handlers::bookmark::list_bookmarks),\n        )\n        // Follow\n        .route(\n            \"/users/{id}/follow\",\n            routing::post(handlers::follow::toggle_follow),\n        )\n        // Upload\n        .route(\n            \"/upload/avatar\",\n            routing::post(handlers::upload::upload_avatar),\n        )\n        .route(\n            \"/upload/image\",\n            routing::post(handlers::upload::upload_image),\n        )\n        // Reports\n        .route(\"/reports\", routing::post(handlers::report::create_report))\n        .route(\n            \"/admin/reports\",\n            routing::get(handlers::report::list_reports),\n        )\n        .route(\n            \"/admin/reports/{id}/resolve\",\n            routing::put(handlers::report::resolve_report),\n        )\n        // Tags (admin)\n        .route(\"/admin/tags\", routing::post(handlers::tag::create_tag))\n        .route(\n            \"/admin/tags/{id}\",\n            routing::put(handlers::tag::update_tag).delete(handlers::tag::delete_tag),\n        )\n        .layer(GovernorLayer::new(governor_conf))\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":73},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","admin.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{post, user, Comment, Forum, Post, User, UserModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\n\npub struct AdminService {\n    db: DatabaseConnection,\n}\n\nimpl AdminService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn get_stats(\u0026self) -\u003e AppResult\u003cAdminStats\u003e {\n        let total_users = User::find().count(\u0026self.db).await?;\n        let total_posts = Post::find().count(\u0026self.db).await?;\n        let total_comments = Comment::find().count(\u0026self.db).await?;\n        let total_forums = Forum::find().count(\u0026self.db).await?;\n\n        let today = chrono::Utc::now().naive_utc().date();\n        let today_start = today.and_hms_opt(0, 0, 0).unwrap();\n\n        let users_today = User::find()\n            .filter(user::Column::CreatedAt.gte(today_start))\n            .count(\u0026self.db)\n            .await?;\n\n        let posts_today = Post::find()\n            .filter(post::Column::CreatedAt.gte(today_start))\n            .count(\u0026self.db)\n            .await?;\n\n        Ok(AdminStats {\n            total_users,\n            total_posts,\n            total_comments,\n            total_forums,\n            users_today,\n            posts_today,\n        })\n    }\n\n    pub async fn list_users(\u0026self, page: u64, per_page: u64) -\u003e AppResult\u003c(Vec\u003cUserModel\u003e, u64)\u003e {\n        let paginator = User::find()\n            .order_by_desc(user::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let users = paginator.fetch_page(page.saturating_sub(1)).await?;\n        Ok((users, total))\n    }\n\n    pub async fn update_user_role(\u0026self, user_id: i32, role: \u0026str) -\u003e AppResult\u003cUserModel\u003e {\n        let valid_roles = [\"user\", \"admin\", \"moderator\", \"banned\"];\n        if !valid_roles.contains(\u0026role) {\n            return Err(AppError::Validation(format!(\n                \"Invalid role. Must be one of: {}\",\n                valid_roles.join(\", \")\n            )));\n        }\n\n        let existing = User::find_by_id(user_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let mut active: user::ActiveModel = existing.into();\n        active.role = sea_orm::ActiveValue::Set(role.to_string());\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn admin_delete_post(\u0026self, post_id: i32) -\u003e AppResult\u003c()\u003e {\n        Post::find_by_id(post_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        Post::delete_by_id(post_id).exec(\u0026self.db).await?;\n        Ok(())\n    }\n\n    pub async fn admin_delete_comment(\u0026self, comment_id: i32) -\u003e AppResult\u003c()\u003e {\n        Comment::find_by_id(comment_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        Comment::delete_by_id(comment_id).exec(\u0026self.db).await?;\n        Ok(())\n    }\n}\n\npub struct AdminStats {\n    pub total_users: u64,\n    pub total_posts: u64,\n    pub total_comments: u64,\n    pub total_forums: u64,\n    pub users_today: u64,\n    pub posts_today: u64,\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":58},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","auth.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::User,\n    services::email::EmailService,\n    utils::{encode_access_token, encode_refresh_token, hash_password, verify_password},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n};\n\npub struct AuthService {\n    db: DatabaseConnection,\n}\n\nimpl AuthService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    /// Register a new user and send verification email.\n    /// Returns (user_model, access_token, refresh_token).\n    pub async fn register(\n        \u0026self,\n        username: \u0026str,\n        email: \u0026str,\n        password: \u0026str,\n        email_service: \u0026EmailService,\n    ) -\u003e AppResult\u003c(crate::models::UserModel, String, String)\u003e {\n        // Check if username or email already exists\n        if self.user_exists(username, email).await? {\n            return Err(AppError::Validation(\n                \"Username or email already exists\".to_string(),\n            ));\n        }\n\n        let password_hash = hash_password(password)?;\n        let now = chrono::Utc::now().naive_utc();\n        let verification_token = uuid::Uuid::new_v4().to_string();\n        let verification_expires = now + chrono::Duration::hours(24);\n\n        let new_user = crate::models::user::ActiveModel {\n            username: sea_orm::ActiveValue::Set(username.to_string()),\n            email: sea_orm::ActiveValue::Set(email.to_string()),\n            password_hash: sea_orm::ActiveValue::Set(password_hash),\n            karma: sea_orm::ActiveValue::Set(0),\n            role: sea_orm::ActiveValue::Set(\"user\".to_string()),\n            email_verified: sea_orm::ActiveValue::Set(false),\n            email_verification_token: sea_orm::ActiveValue::Set(Some(\n                verification_token.clone(),\n            )),\n            email_verification_expires: sea_orm::ActiveValue::Set(Some(verification_expires)),\n            created_at: sea_orm::ActiveValue::Set(now),\n            updated_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let user = new_user.insert(\u0026self.db).await?;\n        let access_token = encode_access_token(\u0026user.id.to_string())?;\n        let refresh_token = encode_refresh_token(\u0026user.id.to_string())?;\n\n        // Send verification email (non-fatal)\n        if let Err(e) = email_service\n            .send_verification_email(\u0026user.email, \u0026verification_token)\n            .await\n        {\n            tracing::warn!(\"Failed to send verification email: {e}\");\n        }\n\n        Ok((user, access_token, refresh_token))\n    }\n\n    /// Login user\n    /// Returns (user_model, access_token, refresh_token)\n    pub async fn login(\n        \u0026self,\n        username: \u0026str,\n        password: \u0026str,\n    ) -\u003e AppResult\u003c(crate::models::UserModel, String, String)\u003e {\n        // Find user by username\n        let user: crate::models::UserModel = self\n            .find_by_username(username)\n            .await\n            .map_err(|_| AppError::Unauthorized)?;\n\n        // Verify password\n        let is_valid = verify_password(password, \u0026user.password_hash)?;\n        if !is_valid {\n            return Err(AppError::Unauthorized);\n        }\n\n        // Generate JWT tokens\n        let access_token = encode_access_token(\u0026user.id.to_string())?;\n        let refresh_token = encode_refresh_token(\u0026user.id.to_string())?;\n\n        Ok((user, access_token, refresh_token))\n    }\n\n    /// Get user by ID\n    pub async fn get_user_by_id(\u0026self, id: i32) -\u003e AppResult\u003ccrate::models::UserModel\u003e {\n        let user = User::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n        Ok(user)\n    }\n\n    /// Check if user exists by username or email\n    async fn user_exists(\u0026self, username: \u0026str, email: \u0026str) -\u003e AppResult\u003cbool\u003e {\n        let count = User::find()\n            .filter(\n                sea_orm::Condition::any()\n                    .add(crate::models::user::Column::Username.eq(username))\n                    .add(crate::models::user::Column::Email.eq(email)),\n            )\n            .count(\u0026self.db)\n            .await?;\n\n        Ok(count \u003e 0)\n    }\n\n    /// Find user by username\n    async fn find_by_username(\u0026self, username: \u0026str) -\u003e AppResult\u003ccrate::models::UserModel\u003e {\n        let user = User::find()\n            .filter(crate::models::user::Column::Username.eq(username))\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n        Ok(user)\n    }\n\n    /// Change password for authenticated user\n    pub async fn change_password(\n        \u0026self,\n        user_id: i32,\n        current_password: \u0026str,\n        new_password: \u0026str,\n    ) -\u003e AppResult\u003c()\u003e {\n        let user = self.get_user_by_id(user_id).await?;\n        let is_valid = verify_password(current_password, \u0026user.password_hash)?;\n        if !is_valid {\n            return Err(AppError::Validation(\n                \"Current password is incorrect\".to_string(),\n            ));\n        }\n        let new_hash = hash_password(new_password)?;\n        let now = chrono::Utc::now().naive_utc();\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.password_hash = sea_orm::ActiveValue::Set(new_hash);\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n        active.update(\u0026self.db).await?;\n        Ok(())\n    }\n\n    /// Verify email with token\n    pub async fn verify_email(\u0026self, token: \u0026str) -\u003e AppResult\u003c()\u003e {\n        let user = User::find()\n            .filter(crate::models::user::Column::EmailVerificationToken.eq(token))\n            .one(\u0026self.db)\n            .await?\n            .ok_or_else(|| AppError::Validation(\"Invalid verification token\".to_string()))?;\n\n        if let Some(expires) = user.email_verification_expires {\n            if chrono::Utc::now().naive_utc() \u003e expires {\n                return Err(AppError::Validation(\n                    \"Verification token has expired\".to_string(),\n                ));\n            }\n        }\n\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.email_verified = sea_orm::ActiveValue::Set(true);\n        active.email_verification_token = sea_orm::ActiveValue::Set(None);\n        active.email_verification_expires = sea_orm::ActiveValue::Set(None);\n        active.update(\u0026self.db).await?;\n        Ok(())\n    }\n\n    /// Resend email verification token\n    pub async fn resend_verification(\n        \u0026self,\n        user_id: i32,\n        email_service: \u0026EmailService,\n    ) -\u003e AppResult\u003c()\u003e {\n        let user = self.get_user_by_id(user_id).await?;\n        if user.email_verified {\n            return Err(AppError::Validation(\n                \"Email is already verified\".to_string(),\n            ));\n        }\n        let token = uuid::Uuid::new_v4().to_string();\n        let now = chrono::Utc::now().naive_utc();\n        let expires = now + chrono::Duration::hours(24);\n\n        let email = user.email.clone();\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.email_verification_token = sea_orm::ActiveValue::Set(Some(token.clone()));\n        active.email_verification_expires = sea_orm::ActiveValue::Set(Some(expires));\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n        active.update(\u0026self.db).await?;\n\n        if let Err(e) = email_service.send_verification_email(\u0026email, \u0026token).await {\n            tracing::warn!(\"Failed to send verification email: {e}\");\n        }\n\n        Ok(())\n    }\n\n    /// Request a password reset. Timing-safe: silently succeeds if user not found.\n    pub async fn forgot_password(\n        \u0026self,\n        email: \u0026str,\n        email_service: \u0026EmailService,\n    ) -\u003e AppResult\u003c()\u003e {\n        let user = User::find()\n            .filter(crate::models::user::Column::Email.eq(email))\n            .one(\u0026self.db)\n            .await?;\n\n        let user = match user {\n            Some(u) =\u003e u,\n            None =\u003e return Ok(()), // timing-safe: don't reveal whether email exists\n        };\n\n        let token = uuid::Uuid::new_v4().to_string();\n        let now = chrono::Utc::now().naive_utc();\n        let expires = now + chrono::Duration::hours(1);\n\n        let user_email = user.email.clone();\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.password_reset_token = sea_orm::ActiveValue::Set(Some(token.clone()));\n        active.password_reset_expires = sea_orm::ActiveValue::Set(Some(expires));\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n        active.update(\u0026self.db).await?;\n\n        if let Err(e) = email_service\n            .send_password_reset_email(\u0026user_email, \u0026token)\n            .await\n        {\n            tracing::warn!(\"Failed to send password reset email: {e}\");\n        }\n\n        Ok(())\n    }\n\n    /// Reset password using a reset token.\n    pub async fn reset_password(\u0026self, token: \u0026str, new_password: \u0026str) -\u003e AppResult\u003c()\u003e {\n        let user = User::find()\n            .filter(crate::models::user::Column::PasswordResetToken.eq(token))\n            .one(\u0026self.db)\n            .await?\n            .ok_or_else(|| AppError::Validation(\"Invalid reset token\".to_string()))?;\n\n        if let Some(expires) = user.password_reset_expires {\n            if chrono::Utc::now().naive_utc() \u003e expires {\n                return Err(AppError::Validation(\"Reset token has expired\".to_string()));\n            }\n        }\n\n        let new_hash = hash_password(new_password)?;\n        let now = chrono::Utc::now().naive_utc();\n        let mut active: crate::models::user::ActiveModel = user.into();\n        active.password_hash = sea_orm::ActiveValue::Set(new_hash);\n        active.password_reset_token = sea_orm::ActiveValue::Set(None);\n        active.password_reset_expires = sea_orm::ActiveValue::Set(None);\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n        active.update(\u0026self.db).await?;\n\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn validate_email_format_valid() {\n        let email = \"user@example.com\";\n        assert!(email.contains('@') \u0026\u0026 email.contains('.'));\n    }\n\n    #[test]\n    fn validate_email_format_missing_at() {\n        let email = \"userexample.com\";\n        assert!(!(email.contains('@') \u0026\u0026 email.contains('.')));\n    }\n\n    #[test]\n    fn validate_email_format_missing_dot() {\n        let email = \"user@examplecom\";\n        assert!(!(email.contains('@') \u0026\u0026 email.contains('.')));\n    }\n\n    #[test]\n    fn validate_username_length_valid() {\n        let username = \"alice\";\n        assert!(username.len() \u003e= 3 \u0026\u0026 username.len() \u003c= 30);\n    }\n\n    #[test]\n    fn validate_username_too_short() {\n        let username = \"ab\";\n        assert!(!(username.len() \u003e= 3 \u0026\u0026 username.len() \u003c= 30));\n    }\n\n    #[test]\n    fn validate_password_length_valid() {\n        let password = \"password123\";\n        assert!(password.len() \u003e= 8);\n    }\n\n    #[test]\n    fn validate_password_too_short() {\n        let password = \"pass\";\n        assert!(!(password.len() \u003e= 8));\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":145},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","bookmark.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{bookmark, post, Bookmark, Post, PostModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\nuse std::collections::HashMap;\n\npub struct BookmarkService {\n    db: DatabaseConnection,\n}\n\nimpl BookmarkService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    /// Toggle bookmark: if exists -\u003e delete, if not -\u003e create.\n    /// Returns true if bookmarked, false if un-bookmarked.\n    pub async fn toggle(\u0026self, user_id: i32, post_id: i32) -\u003e AppResult\u003cbool\u003e {\n        // Verify post exists\n        Post::find_by_id(post_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let existing = Bookmark::find()\n            .filter(bookmark::Column::UserId.eq(user_id))\n            .filter(bookmark::Column::PostId.eq(post_id))\n            .one(\u0026self.db)\n            .await?;\n\n        if let Some(existing) = existing {\n            Bookmark::delete_by_id(existing.id)\n                .exec(\u0026self.db)\n                .await?;\n            Ok(false)\n        } else {\n            let now = chrono::Utc::now().naive_utc();\n            let model = bookmark::ActiveModel {\n                user_id: sea_orm::ActiveValue::Set(user_id),\n                post_id: sea_orm::ActiveValue::Set(post_id),\n                created_at: sea_orm::ActiveValue::Set(now),\n                ..Default::default()\n            };\n            model.insert(\u0026self.db).await?;\n            Ok(true)\n        }\n    }\n\n    /// List user's bookmarked posts with pagination.\n    /// Returns posts in bookmark order (most recently bookmarked first).\n    pub async fn list_user_bookmarks(\n        \u0026self,\n        user_id: i32,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        let paginator = Bookmark::find()\n            .filter(bookmark::Column::UserId.eq(user_id))\n            .order_by_desc(bookmark::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let bookmarks = paginator.fetch_page(page.saturating_sub(1)).await?;\n\n        let post_ids: Vec\u003ci32\u003e = bookmarks.iter().map(|b| b.post_id).collect();\n        if post_ids.is_empty() {\n            return Ok((vec![], total));\n        }\n\n        let posts = Post::find()\n            .filter(post::Column::Id.is_in(post_ids.clone()))\n            .all(\u0026self.db)\n            .await?;\n\n        // Reorder posts to match bookmark order\n        let post_map: HashMap\u003ci32, PostModel\u003e = posts.into_iter().map(|p| (p.id, p)).collect();\n        let ordered: Vec\u003cPostModel\u003e = post_ids\n            .into_iter()\n            .filter_map(|id| post_map.get(\u0026id).cloned())\n            .collect();\n\n        Ok((ordered, total))\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":40},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","cache.rs"],"content":"use redis::aio::ConnectionManager;\nuse redis::AsyncCommands;\nuse serde::{de::DeserializeOwned, Serialize};\n\n#[derive(Clone)]\npub struct CacheService {\n    redis: ConnectionManager,\n}\n\nimpl CacheService {\n    pub fn new(redis: ConnectionManager) -\u003e Self {\n        Self { redis }\n    }\n\n    pub async fn get\u003cT: DeserializeOwned\u003e(\u0026self, key: \u0026str) -\u003e Option\u003cT\u003e {\n        let mut conn = self.redis.clone();\n        let result: Option\u003cString\u003e = conn.get(key).await.ok()?;\n        result.and_then(|s| serde_json::from_str(\u0026s).ok())\n    }\n\n    pub async fn set\u003cT: Serialize\u003e(\u0026self, key: \u0026str, value: \u0026T, ttl_secs: u64) {\n        let mut conn = self.redis.clone();\n        if let Ok(json) = serde_json::to_string(value) {\n            let _: Result\u003c(), _\u003e = conn.set_ex(key, json, ttl_secs).await;\n        }\n    }\n\n    pub async fn invalidate(\u0026self, key: \u0026str) {\n        let mut conn = self.redis.clone();\n        let _: Result\u003c(), _\u003e = conn.del(key).await;\n    }\n\n    #[allow(dead_code)]\n    pub async fn invalidate_pattern(\u0026self, pattern: \u0026str) {\n        let mut conn = self.redis.clone();\n        if let Ok(keys) = redis::cmd(\"KEYS\")\n            .arg(pattern)\n            .query_async::\u003cVec\u003cString\u003e\u003e(\u0026mut conn)\n            .await\n        {\n            if !keys.is_empty() {\n                let _: Result\u003c(), _\u003e = conn.del(keys).await;\n            }\n        }\n    }\n}\n","traces":[{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","comment.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{comment, Comment, CommentModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, QueryFilter, QueryOrder,\n};\n\npub struct CommentService {\n    db: DatabaseConnection,\n}\n\nimpl CommentService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn list_by_post(\u0026self, post_id: i32) -\u003e AppResult\u003cVec\u003cCommentModel\u003e\u003e {\n        let comments = Comment::find()\n            .filter(comment::Column::PostId.eq(post_id))\n            .filter(comment::Column::IsHidden.eq(false))\n            .order_by_asc(comment::Column::CreatedAt)\n            .all(\u0026self.db)\n            .await?;\n        Ok(comments)\n    }\n\n    pub async fn create(\n        \u0026self,\n        post_id: i32,\n        user_id: i32,\n        parent_id: Option\u003ci32\u003e,\n        content: \u0026str,\n    ) -\u003e AppResult\u003cCommentModel\u003e {\n        if let Some(pid) = parent_id {\n            self.validate_parent(pid, post_id).await?;\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let new_comment = comment::ActiveModel {\n            post_id: sea_orm::ActiveValue::Set(post_id),\n            user_id: sea_orm::ActiveValue::Set(user_id),\n            parent_id: sea_orm::ActiveValue::Set(parent_id),\n            content: sea_orm::ActiveValue::Set(content.to_string()),\n            upvotes: sea_orm::ActiveValue::Set(0),\n            downvotes: sea_orm::ActiveValue::Set(0),\n            created_at: sea_orm::ActiveValue::Set(now),\n            updated_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let comment = new_comment.insert(\u0026self.db).await?;\n        Ok(comment)\n    }\n\n    pub async fn update(\u0026self, id: i32, user_id: i32, content: \u0026str) -\u003e AppResult\u003cCommentModel\u003e {\n        let existing = self.get_by_id(id).await?;\n        if existing.user_id != user_id {\n            return Err(AppError::Forbidden);\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: comment::ActiveModel = existing.into();\n        active.content = sea_orm::ActiveValue::Set(content.to_string());\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn delete(\u0026self, id: i32, user_id: i32) -\u003e AppResult\u003c()\u003e {\n        let existing = self.get_by_id(id).await?;\n        if existing.user_id != user_id {\n            return Err(AppError::Forbidden);\n        }\n\n        Comment::delete_by_id(id).exec(\u0026self.db).await?;\n        Ok(())\n    }\n\n    pub async fn get_by_id(\u0026self, id: i32) -\u003e AppResult\u003cCommentModel\u003e {\n        Comment::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    async fn validate_parent(\u0026self, parent_id: i32, post_id: i32) -\u003e AppResult\u003c()\u003e {\n        let parent = Comment::find_by_id(parent_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::Validation(\"Parent comment not found\".to_string()))?;\n\n        if parent.post_id != post_id {\n            return Err(AppError::Validation(\n                \"Parent comment belongs to a different post\".to_string(),\n            ));\n        }\n\n        let depth = self.get_comment_depth(parent_id).await?;\n        if depth \u003e= 10 {\n            return Err(AppError::Validation(\n                \"Maximum comment nesting depth reached\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    async fn get_comment_depth(\u0026self, comment_id: i32) -\u003e AppResult\u003cu32\u003e {\n        let mut depth = 0u32;\n        let mut current_id = Some(comment_id);\n\n        while let Some(id) = current_id {\n            let comment = Comment::find_by_id(id)\n                .one(\u0026self.db)\n                .await?\n                .ok_or(AppError::NotFound)?;\n            current_id = comment.parent_id;\n            depth += 1;\n            if depth \u003e 10 {\n                break;\n            }\n        }\n\n        Ok(depth)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    const MAX_DEPTH: u32 = 10;\n\n    fn is_depth_exceeded(depth: u32) -\u003e bool {\n        depth \u003e MAX_DEPTH\n    }\n\n    #[test]\n    fn test_depth_limit_enforced() {\n        assert!(is_depth_exceeded(11));\n        assert!(!is_depth_exceeded(10));\n    }\n\n    #[test]\n    fn test_root_comment_has_no_parent() {\n        let parent_id: Option\u003ci32\u003e = None;\n        assert!(parent_id.is_none());\n    }\n\n    #[test]\n    fn test_reply_has_parent() {\n        let parent_id = Some(1);\n        assert!(parent_id.is_some());\n    }\n}\n","traces":[{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":70},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","email.rs"],"content":"use crate::config::email::EmailConfig;\nuse anyhow::Result;\nuse lettre::{\n    message::{header::ContentType, Mailbox},\n    transport::smtp::authentication::Credentials,\n    AsyncSmtpTransport, AsyncTransport, Message, Tokio1Executor,\n};\n\n#[derive(Clone)]\npub struct EmailService {\n    transport: Option\u003cAsyncSmtpTransport\u003cTokio1Executor\u003e\u003e,\n    from_address: Option\u003cString\u003e,\n    frontend_url: String,\n}\n\nimpl EmailService {\n    /// Build from environment variables. If SMTP is not configured, email\n    /// sending is silently skipped (graceful degradation).\n    pub fn from_env() -\u003e Self {\n        match EmailConfig::from_env() {\n            Some(cfg) =\u003e {\n                let creds =\n                    Credentials::new(cfg.smtp_username.clone(), cfg.smtp_password.clone());\n                let transport = AsyncSmtpTransport::\u003cTokio1Executor\u003e::relay(\u0026cfg.smtp_host)\n                    .map(|builder| builder.port(cfg.smtp_port).credentials(creds).build());\n\n                match transport {\n                    Ok(t) =\u003e Self {\n                        transport: Some(t),\n                        from_address: Some(cfg.from_address),\n                        frontend_url: cfg.frontend_url,\n                    },\n                    Err(e) =\u003e {\n                        tracing::warn!(\"Failed to build SMTP transport: {e}\");\n                        Self {\n                            transport: None,\n                            from_address: None,\n                            frontend_url: cfg.frontend_url,\n                        }\n                    }\n                }\n            }\n            None =\u003e {\n                let frontend_url = std::env::var(\"FRONTEND_URL\")\n                    .unwrap_or_else(|_| \"http://localhost:3000\".to_string());\n                Self {\n                    transport: None,\n                    from_address: None,\n                    frontend_url,\n                }\n            }\n        }\n    }\n\n    /// Returns true if SMTP is configured and available.\n    pub fn is_configured(\u0026self) -\u003e bool {\n        self.transport.is_some()\n    }\n\n    /// Send a verification email. Silently succeeds if SMTP is not configured.\n    pub async fn send_verification_email(\u0026self, to: \u0026str, token: \u0026str) -\u003e Result\u003c()\u003e {\n        let link = format!(\"{}/verify-email?token={}\", self.frontend_url, token);\n        let body = format!(\n            \"Welcome! Please verify your email by clicking the link below:\\n\\n{}\\n\\nThis link expires in 24 hours.\",\n            link\n        );\n\n        self.send_email(to, \"Verify your email\", \u0026body).await\n    }\n\n    /// Send a password reset email. Silently succeeds if SMTP is not configured.\n    pub async fn send_password_reset_email(\u0026self, to: \u0026str, token: \u0026str) -\u003e Result\u003c()\u003e {\n        let link = format!(\"{}/reset-password?token={}\", self.frontend_url, token);\n        let body = format!(\n            \"A password reset was requested for your account.\\n\\nClick the link below to reset your password:\\n\\n{}\\n\\nThis link expires in 1 hour. If you did not request this, you can safely ignore this email.\",\n            link\n        );\n\n        self.send_email(to, \"Reset your password\", \u0026body).await\n    }\n\n    async fn send_email(\u0026self, to: \u0026str, subject: \u0026str, body: \u0026str) -\u003e Result\u003c()\u003e {\n        let transport = match \u0026self.transport {\n            Some(t) =\u003e t,\n            None =\u003e {\n                tracing::debug!(\"SMTP not configured, skipping email to {to}\");\n                return Ok(());\n            }\n        };\n        let from_address = match \u0026self.from_address {\n            Some(f) =\u003e f,\n            None =\u003e return Ok(()),\n        };\n\n        let from_mailbox: Mailbox = from_address.parse().map_err(|e: lettre::address::AddressError| {\n            anyhow::anyhow!(\"Invalid from address '{}': {}\", from_address, e)\n        })?;\n        let to_mailbox: Mailbox = to.parse().map_err(|e: lettre::address::AddressError| {\n            anyhow::anyhow!(\"Invalid to address '{}': {}\", to, e)\n        })?;\n\n        let email = Message::builder()\n            .from(from_mailbox)\n            .to(to_mailbox)\n            .subject(subject)\n            .header(ContentType::TEXT_PLAIN)\n            .body(body.to_string())?;\n\n        transport.send(email).await?;\n        tracing::info!(\"Email sent to {to}: {subject}\");\n        Ok(())\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":47},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","follow.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{follow, user, Follow, User, UserModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\nuse std::collections::HashMap;\n\npub struct FollowService {\n    db: DatabaseConnection,\n}\n\nimpl FollowService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    /// Toggle follow: if exists -\u003e unfollow, if not -\u003e follow.\n    /// Returns true if now following, false if unfollowed.\n    pub async fn toggle(\u0026self, follower_id: i32, following_id: i32) -\u003e AppResult\u003cbool\u003e {\n        if follower_id == following_id {\n            return Err(AppError::Validation(\"Cannot follow yourself\".to_string()));\n        }\n\n        // Verify target user exists\n        User::find_by_id(following_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let existing = Follow::find()\n            .filter(follow::Column::FollowerId.eq(follower_id))\n            .filter(follow::Column::FollowingId.eq(following_id))\n            .one(\u0026self.db)\n            .await?;\n\n        if let Some(existing) = existing {\n            Follow::delete_by_id(existing.id)\n                .exec(\u0026self.db)\n                .await?;\n            Ok(false)\n        } else {\n            let now = chrono::Utc::now().naive_utc();\n            let model = follow::ActiveModel {\n                follower_id: sea_orm::ActiveValue::Set(follower_id),\n                following_id: sea_orm::ActiveValue::Set(following_id),\n                created_at: sea_orm::ActiveValue::Set(now),\n                ..Default::default()\n            };\n            model.insert(\u0026self.db).await?;\n            Ok(true)\n        }\n    }\n\n    /// List users who follow the given user (followers of user_id).\n    pub async fn list_followers(\n        \u0026self,\n        user_id: i32,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cUserModel\u003e, u64)\u003e {\n        let paginator = Follow::find()\n            .filter(follow::Column::FollowingId.eq(user_id))\n            .order_by_desc(follow::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let follows = paginator.fetch_page(page.saturating_sub(1)).await?;\n\n        let user_ids: Vec\u003ci32\u003e = follows.iter().map(|f| f.follower_id).collect();\n        if user_ids.is_empty() {\n            return Ok((vec![], total));\n        }\n\n        let users = User::find()\n            .filter(user::Column::Id.is_in(user_ids.clone()))\n            .all(\u0026self.db)\n            .await?;\n\n        // Reorder to match follow order\n        let user_map: HashMap\u003ci32, UserModel\u003e = users.into_iter().map(|u| (u.id, u)).collect();\n        let ordered: Vec\u003cUserModel\u003e = user_ids\n            .into_iter()\n            .filter_map(|id| user_map.get(\u0026id).cloned())\n            .collect();\n\n        Ok((ordered, total))\n    }\n\n    /// List users that the given user follows (following of user_id).\n    pub async fn list_following(\n        \u0026self,\n        user_id: i32,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cUserModel\u003e, u64)\u003e {\n        let paginator = Follow::find()\n            .filter(follow::Column::FollowerId.eq(user_id))\n            .order_by_desc(follow::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let follows = paginator.fetch_page(page.saturating_sub(1)).await?;\n\n        let user_ids: Vec\u003ci32\u003e = follows.iter().map(|f| f.following_id).collect();\n        if user_ids.is_empty() {\n            return Ok((vec![], total));\n        }\n\n        let users = User::find()\n            .filter(user::Column::Id.is_in(user_ids.clone()))\n            .all(\u0026self.db)\n            .await?;\n\n        let user_map: HashMap\u003ci32, UserModel\u003e = users.into_iter().map(|u| (u.id, u)).collect();\n        let ordered: Vec\u003cUserModel\u003e = user_ids\n            .into_iter()\n            .filter_map(|id| user_map.get(\u0026id).cloned())\n            .collect();\n\n        Ok((ordered, total))\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":60},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","forum.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{forum, Forum, ForumModel},\n    services::cache::CacheService,\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, QueryFilter, QueryOrder,\n};\n\nconst CACHE_KEY_FORUMS_LIST: \u0026str = \"forums:list\";\nconst CACHE_TTL_FORUMS: u64 = 300; // 5 minutes\n\npub struct ForumService {\n    db: DatabaseConnection,\n    cache: Option\u003cCacheService\u003e,\n}\n\nimpl ForumService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db, cache: None }\n    }\n\n    pub fn with_cache(mut self, cache: CacheService) -\u003e Self {\n        self.cache = Some(cache);\n        self\n    }\n\n    pub async fn list(\u0026self) -\u003e AppResult\u003cVec\u003cForumModel\u003e\u003e {\n        if let Some(cache) = \u0026self.cache {\n            if let Some(cached) = cache.get::\u003cVec\u003cForumModel\u003e\u003e(CACHE_KEY_FORUMS_LIST).await {\n                return Ok(cached);\n            }\n        }\n\n        let forums = Forum::find()\n            .order_by_asc(forum::Column::SortOrder)\n            .all(\u0026self.db)\n            .await?;\n\n        if let Some(cache) = \u0026self.cache {\n            cache\n                .set(CACHE_KEY_FORUMS_LIST, \u0026forums, CACHE_TTL_FORUMS)\n                .await;\n        }\n\n        Ok(forums)\n    }\n\n    #[allow(dead_code)]\n    pub async fn get_by_id(\u0026self, id: i32) -\u003e AppResult\u003cForumModel\u003e {\n        Forum::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    pub async fn get_by_slug(\u0026self, slug: \u0026str) -\u003e AppResult\u003cForumModel\u003e {\n        Forum::find()\n            .filter(forum::Column::Slug.eq(slug))\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    pub async fn create(\n        \u0026self,\n        name: \u0026str,\n        description: \u0026str,\n        slug: \u0026str,\n        sort_order: i32,\n        icon_url: Option\u003cString\u003e,\n    ) -\u003e AppResult\u003cForumModel\u003e {\n        let now = chrono::Utc::now().naive_utc();\n\n        let new_forum = forum::ActiveModel {\n            name: sea_orm::ActiveValue::Set(name.to_string()),\n            description: sea_orm::ActiveValue::Set(description.to_string()),\n            slug: sea_orm::ActiveValue::Set(slug.to_string()),\n            sort_order: sea_orm::ActiveValue::Set(sort_order),\n            icon_url: sea_orm::ActiveValue::Set(icon_url),\n            created_at: sea_orm::ActiveValue::Set(now),\n            updated_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let forum = new_forum.insert(\u0026self.db).await?;\n        self.invalidate_list_cache().await;\n        Ok(forum)\n    }\n\n    pub async fn update(\n        \u0026self,\n        slug: \u0026str,\n        name: \u0026str,\n        description: \u0026str,\n        sort_order: i32,\n        icon_url: Option\u003cString\u003e,\n    ) -\u003e AppResult\u003cForumModel\u003e {\n        let existing = self.get_by_slug(slug).await?;\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: forum::ActiveModel = existing.into();\n        active.name = sea_orm::ActiveValue::Set(name.to_string());\n        active.description = sea_orm::ActiveValue::Set(description.to_string());\n        active.sort_order = sea_orm::ActiveValue::Set(sort_order);\n        active.icon_url = sea_orm::ActiveValue::Set(icon_url);\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        self.invalidate_list_cache().await;\n        Ok(updated)\n    }\n\n    pub async fn delete(\u0026self, slug: \u0026str) -\u003e AppResult\u003c()\u003e {\n        let existing = self.get_by_slug(slug).await?;\n        Forum::delete_by_id(existing.id).exec(\u0026self.db).await?;\n        self.invalidate_list_cache().await;\n        Ok(())\n    }\n\n    async fn invalidate_list_cache(\u0026self) {\n        if let Some(cache) = \u0026self.cache {\n            cache.invalidate(CACHE_KEY_FORUMS_LIST).await;\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn cache_key_constant() {\n        assert_eq!(CACHE_KEY_FORUMS_LIST, \"forums:list\");\n    }\n\n    #[test]\n    fn cache_ttl_value() {\n        assert_eq!(CACHE_TTL_FORUMS, 300);\n    }\n}\n","traces":[{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":60},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","mod.rs"],"content":"pub mod admin;\npub mod auth;\npub mod bookmark;\npub mod cache;\npub mod email;\npub mod follow;\npub mod comment;\npub mod forum;\npub mod notification;\npub mod post;\npub mod report;\npub mod tag;\npub mod upload;\npub mod user;\npub mod vote;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","notification.rs"],"content":"use crate::{\n    error::AppResult,\n    models::{notification, Notification, NotificationModel},\n    websocket::hub::NotificationHub,\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\n\npub struct NotificationService {\n    db: DatabaseConnection,\n    hub: NotificationHub,\n}\n\nimpl NotificationService {\n    pub fn new(db: DatabaseConnection, hub: NotificationHub) -\u003e Self {\n        Self { db, hub }\n    }\n\n    pub async fn notify(\n        \u0026self,\n        user_id: i32,\n        actor_id: i32,\n        kind: \u0026str,\n        target_type: \u0026str,\n        target_id: i32,\n        message: \u0026str,\n    ) -\u003e AppResult\u003c()\u003e {\n        // Don't notify yourself\n        if user_id == actor_id {\n            return Ok(());\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n        let model = notification::ActiveModel {\n            user_id: sea_orm::ActiveValue::Set(user_id),\n            kind: sea_orm::ActiveValue::Set(kind.to_string()),\n            actor_id: sea_orm::ActiveValue::Set(actor_id),\n            target_type: sea_orm::ActiveValue::Set(target_type.to_string()),\n            target_id: sea_orm::ActiveValue::Set(target_id),\n            message: sea_orm::ActiveValue::Set(message.to_string()),\n            is_read: sea_orm::ActiveValue::Set(false),\n            created_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let saved = model.insert(\u0026self.db).await?;\n\n        // Push via WebSocket\n        let json = serde_json::json!({\n            \"type\": \"notification\",\n            \"data\": {\n                \"id\": saved.id,\n                \"kind\": \u0026saved.kind,\n                \"message\": \u0026saved.message,\n                \"target_type\": \u0026saved.target_type,\n                \"target_id\": saved.target_id,\n                \"created_at\": saved.created_at.to_string(),\n            }\n        });\n        self.hub.send_to_user(user_id, \u0026json.to_string());\n\n        Ok(())\n    }\n\n    pub async fn list_for_user(\n        \u0026self,\n        user_id: i32,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cNotificationModel\u003e, u64)\u003e {\n        let paginator = Notification::find()\n            .filter(notification::Column::UserId.eq(user_id))\n            .order_by_desc(notification::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let items = paginator.fetch_page(page.saturating_sub(1)).await?;\n        Ok((items, total))\n    }\n\n    pub async fn unread_count(\u0026self, user_id: i32) -\u003e AppResult\u003cu64\u003e {\n        let count = Notification::find()\n            .filter(notification::Column::UserId.eq(user_id))\n            .filter(notification::Column::IsRead.eq(false))\n            .count(\u0026self.db)\n            .await?;\n        Ok(count)\n    }\n\n    pub async fn mark_read(\u0026self, id: i32, user_id: i32) -\u003e AppResult\u003c()\u003e {\n        let existing = Notification::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(crate::error::AppError::NotFound)?;\n\n        if existing.user_id != user_id {\n            return Err(crate::error::AppError::Forbidden);\n        }\n\n        let mut active: notification::ActiveModel = existing.into();\n        active.is_read = sea_orm::ActiveValue::Set(true);\n        active.update(\u0026self.db).await?;\n        Ok(())\n    }\n\n    pub async fn mark_all_read(\u0026self, user_id: i32) -\u003e AppResult\u003cu64\u003e {\n        use sea_orm::sea_query::Expr;\n        let result = Notification::update_many()\n            .col_expr(notification::Column::IsRead, Expr::value(true))\n            .filter(notification::Column::UserId.eq(user_id))\n            .filter(notification::Column::IsRead.eq(false))\n            .exec(\u0026self.db)\n            .await?;\n        Ok(result.rows_affected)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    fn should_notify(user_id: i32, actor_id: i32) -\u003e bool {\n        user_id != actor_id\n    }\n\n    #[test]\n    fn test_no_self_notification() {\n        assert!(!should_notify(1, 1));\n    }\n\n    #[test]\n    fn test_notify_different_user() {\n        assert!(should_notify(1, 2));\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":59},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","post.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{post, Post, PostModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, ConnectionTrait, DatabaseConnection, EntityTrait,\n    FromQueryResult, PaginatorTrait, QueryFilter, QueryOrder, Statement,\n};\n\npub struct PostService {\n    db: DatabaseConnection,\n}\n\nimpl PostService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn list_by_forum(\n        \u0026self,\n        forum_id: i32,\n        page: u64,\n        per_page: u64,\n        sort: \u0026str,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        match sort {\n            \"top\" | \"hot\" =\u003e self.list_by_forum_raw(forum_id, page, per_page, sort).await,\n            _ =\u003e {\n                // \"new\" (default): use SeaORM paginator\n                let paginator = Post::find()\n                    .filter(post::Column::ForumId.eq(forum_id))\n                    .filter(post::Column::IsHidden.eq(false))\n                    .order_by_desc(post::Column::IsPinned)\n                    .order_by_desc(post::Column::CreatedAt)\n                    .paginate(\u0026self.db, per_page);\n\n                let total = paginator.num_items().await?;\n                let posts = paginator.fetch_page(page.saturating_sub(1)).await?;\n\n                Ok((posts, total))\n            }\n        }\n    }\n\n    async fn list_by_forum_raw(\n        \u0026self,\n        forum_id: i32,\n        page: u64,\n        per_page: u64,\n        sort: \u0026str,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        let offset = page.saturating_sub(1) * per_page;\n\n        let order_clause = match sort {\n            \"top\" =\u003e \"is_pinned DESC, (upvotes - downvotes) DESC, created_at DESC\",\n            \"hot\" =\u003e \"is_pinned DESC, \\\n                (upvotes - downvotes)::float / \\\n                POWER(EXTRACT(EPOCH FROM (NOW() - created_at)) / 3600.0 + 2.0, 1.5) DESC, \\\n                created_at DESC\",\n            _ =\u003e \"is_pinned DESC, created_at DESC\",\n        };\n\n        let count_sql = \"SELECT COUNT(*) as count FROM posts \\\n            WHERE forum_id = $1 AND is_hidden = FALSE\";\n\n        let search_sql = format!(\n            \"SELECT id, user_id, forum_id, title, content, upvotes, downvotes, \\\n                view_count, is_pinned, is_locked, is_hidden, created_at, updated_at \\\n                FROM posts \\\n                WHERE forum_id = $1 AND is_hidden = FALSE \\\n                ORDER BY {} \\\n                LIMIT $2 OFFSET $3\",\n            order_clause\n        );\n\n        let count_result = self\n            .db\n            .query_one(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                count_sql,\n                vec![forum_id.into()],\n            ))\n            .await?\n            .ok_or(AppError::Internal(anyhow::anyhow!(\"Count query failed\")))?;\n\n        let total: i64 = count_result.try_get_by_index(0)?;\n\n        let posts = PostModel::find_by_statement(Statement::from_sql_and_values(\n            sea_orm::DatabaseBackend::Postgres,\n            \u0026search_sql,\n            vec![forum_id.into(), (per_page as i64).into(), (offset as i64).into()],\n        ))\n        .all(\u0026self.db)\n        .await?;\n\n        Ok((posts, total as u64))\n    }\n\n    pub async fn get_by_id(\u0026self, id: i32) -\u003e AppResult\u003cPostModel\u003e {\n        Post::find_by_id(id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    pub async fn create(\n        \u0026self,\n        user_id: i32,\n        forum_id: i32,\n        title: \u0026str,\n        content: \u0026str,\n    ) -\u003e AppResult\u003cPostModel\u003e {\n        let now = chrono::Utc::now().naive_utc();\n\n        let new_post = post::ActiveModel {\n            user_id: sea_orm::ActiveValue::Set(user_id),\n            forum_id: sea_orm::ActiveValue::Set(forum_id),\n            title: sea_orm::ActiveValue::Set(title.to_string()),\n            content: sea_orm::ActiveValue::Set(content.to_string()),\n            upvotes: sea_orm::ActiveValue::Set(0),\n            downvotes: sea_orm::ActiveValue::Set(0),\n            view_count: sea_orm::ActiveValue::Set(0),\n            is_pinned: sea_orm::ActiveValue::Set(false),\n            is_locked: sea_orm::ActiveValue::Set(false),\n            created_at: sea_orm::ActiveValue::Set(now),\n            updated_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let post = new_post.insert(\u0026self.db).await?;\n        Ok(post)\n    }\n\n    pub async fn update(\n        \u0026self,\n        id: i32,\n        user_id: i32,\n        title: \u0026str,\n        content: \u0026str,\n    ) -\u003e AppResult\u003cPostModel\u003e {\n        let existing = self.get_by_id(id).await?;\n        if existing.user_id != user_id {\n            return Err(AppError::Forbidden);\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: post::ActiveModel = existing.into();\n        active.title = sea_orm::ActiveValue::Set(title.to_string());\n        active.content = sea_orm::ActiveValue::Set(content.to_string());\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn delete(\u0026self, id: i32, user_id: i32) -\u003e AppResult\u003c()\u003e {\n        let existing = self.get_by_id(id).await?;\n        if existing.user_id != user_id {\n            return Err(AppError::Forbidden);\n        }\n\n        Post::delete_by_id(id).exec(\u0026self.db).await?;\n        Ok(())\n    }\n\n    pub async fn increment_view_count(\u0026self, id: i32) -\u003e AppResult\u003c()\u003e {\n        self.db\n            .execute(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \"UPDATE posts SET view_count = view_count + 1 WHERE id = $1\",\n                [id.into()],\n            ))\n            .await?;\n        Ok(())\n    }\n\n    pub async fn toggle_pin(\u0026self, id: i32) -\u003e AppResult\u003cPostModel\u003e {\n        let existing = self.get_by_id(id).await?;\n        let mut active: post::ActiveModel = existing.clone().into();\n        active.is_pinned = sea_orm::ActiveValue::Set(!existing.is_pinned);\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn toggle_lock(\u0026self, id: i32) -\u003e AppResult\u003cPostModel\u003e {\n        let existing = self.get_by_id(id).await?;\n        let mut active: post::ActiveModel = existing.clone().into();\n        active.is_locked = sea_orm::ActiveValue::Set(!existing.is_locked);\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    pub async fn search(\n        \u0026self,\n        query: \u0026str,\n        forum_id: Option\u003ci32\u003e,\n        page: u64,\n        per_page: u64,\n        sort: \u0026str,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        let offset = page.saturating_sub(1) * per_page;\n\n        let order_clause = match sort {\n            \"new\" =\u003e \"created_at DESC\",\n            \"top\" =\u003e \"(upvotes - downvotes) DESC, created_at DESC\",\n            _ =\u003e \"ts_rank(search_vector, plainto_tsquery('english', $1)) DESC\",\n        };\n\n        // Build parameterized queries  all values passed via bind params\n        let (count_sql, search_sql, values) = if let Some(fid) = forum_id {\n            let count = \"SELECT COUNT(*) as count FROM posts \\\n                WHERE search_vector @@ plainto_tsquery('english', $1) \\\n                AND is_hidden = FALSE AND forum_id = $2\";\n            let search = format!(\n                \"SELECT id, user_id, forum_id, title, content, upvotes, downvotes, \\\n                    view_count, is_pinned, is_locked, is_hidden, created_at, updated_at \\\n                    FROM posts \\\n                    WHERE search_vector @@ plainto_tsquery('english', $1) \\\n                    AND is_hidden = FALSE AND forum_id = $2 \\\n                    ORDER BY {} \\\n                    LIMIT $3 OFFSET $4\",\n                order_clause\n            );\n            let vals: Vec\u003csea_orm::Value\u003e = vec![\n                query.into(),\n                fid.into(),\n                (per_page as i64).into(),\n                (offset as i64).into(),\n            ];\n            (count.to_string(), search, vals)\n        } else {\n            let count = \"SELECT COUNT(*) as count FROM posts \\\n                WHERE search_vector @@ plainto_tsquery('english', $1) \\\n                AND is_hidden = FALSE\";\n            let search = format!(\n                \"SELECT id, user_id, forum_id, title, content, upvotes, downvotes, \\\n                    view_count, is_pinned, is_locked, is_hidden, created_at, updated_at \\\n                    FROM posts \\\n                    WHERE search_vector @@ plainto_tsquery('english', $1) \\\n                    AND is_hidden = FALSE \\\n                    ORDER BY {} \\\n                    LIMIT $2 OFFSET $3\",\n                order_clause\n            );\n            let vals: Vec\u003csea_orm::Value\u003e = vec![\n                query.into(),\n                (per_page as i64).into(),\n                (offset as i64).into(),\n            ];\n            (count.to_string(), search, vals)\n        };\n\n        // Count total matching rows\n        let count_result = self\n            .db\n            .query_one(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \u0026count_sql,\n                values[..if forum_id.is_some() { 2 } else { 1 }].to_vec(),\n            ))\n            .await?\n            .ok_or(AppError::Internal(anyhow::anyhow!(\"Count query failed\")))?;\n\n        let total: i64 = count_result.try_get_by_index(0)?;\n\n        // Fetch paginated results\n        let posts = PostModel::find_by_statement(Statement::from_sql_and_values(\n            sea_orm::DatabaseBackend::Postgres,\n            \u0026search_sql,\n            values,\n        ))\n        .all(\u0026self.db)\n        .await?;\n\n        Ok((posts, total as u64))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    fn get_order_clause(sort: \u0026str) -\u003e \u0026str {\n        match sort {\n            \"top\" =\u003e \"is_pinned DESC, (upvotes - downvotes) DESC, created_at DESC\",\n            \"hot\" =\u003e \"is_pinned DESC, (upvotes - downvotes)::float / POWER(EXTRACT(EPOCH FROM (NOW() - created_at)) / 3600.0 + 2.0, 1.5) DESC, created_at DESC\",\n            _ =\u003e \"is_pinned DESC, created_at DESC\",\n        }\n    }\n\n    fn calculate_offset(page: u64, per_page: u64) -\u003e u64 {\n        page.saturating_sub(1) * per_page\n    }\n\n    #[test]\n    fn test_sort_top_prioritizes_score() {\n        let clause = get_order_clause(\"top\");\n        assert!(clause.contains(\"(upvotes - downvotes)\"));\n        assert!(clause.starts_with(\"is_pinned DESC\"));\n    }\n\n    #[test]\n    fn test_sort_hot_uses_time_decay() {\n        let clause = get_order_clause(\"hot\");\n        assert!(clause.contains(\"POWER\"));\n        assert!(clause.contains(\"EXTRACT(EPOCH\"));\n    }\n\n    #[test]\n    fn test_pagination_first_page() {\n        assert_eq!(calculate_offset(1, 20), 0);\n    }\n\n    #[test]\n    fn test_pagination_second_page() {\n        assert_eq!(calculate_offset(2, 20), 20);\n    }\n\n    #[test]\n    fn test_pagination_zero_page_safe() {\n        assert_eq!(calculate_offset(0, 20), 0);\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":140},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","report.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{comment, post, report, Comment, Post, Report, ReportModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, PaginatorTrait, QueryFilter,\n    QueryOrder,\n};\n\npub struct ReportService {\n    db: DatabaseConnection,\n}\n\nimpl ReportService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn create_report(\n        \u0026self,\n        reporter_id: i32,\n        target_type: \u0026str,\n        target_id: i32,\n        reason: \u0026str,\n        description: Option\u003c\u0026str\u003e,\n    ) -\u003e AppResult\u003cReportModel\u003e {\n        // Validate target_type\n        if target_type != \"post\" \u0026\u0026 target_type != \"comment\" {\n            return Err(AppError::Validation(\n                \"target_type must be 'post' or 'comment'\".to_string(),\n            ));\n        }\n\n        // Validate reason\n        let valid_reasons = [\"spam\", \"harassment\", \"inappropriate\", \"other\"];\n        if !valid_reasons.contains(\u0026reason) {\n            return Err(AppError::Validation(format!(\n                \"reason must be one of: {}\",\n                valid_reasons.join(\", \")\n            )));\n        }\n\n        // Verify target exists\n        match target_type {\n            \"post\" =\u003e {\n                Post::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::Validation(\"Post not found\".to_string()))?;\n            }\n            \"comment\" =\u003e {\n                Comment::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::Validation(\"Comment not found\".to_string()))?;\n            }\n            _ =\u003e unreachable!(),\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n        let model = report::ActiveModel {\n            reporter_id: sea_orm::ActiveValue::Set(reporter_id),\n            target_type: sea_orm::ActiveValue::Set(target_type.to_string()),\n            target_id: sea_orm::ActiveValue::Set(target_id),\n            reason: sea_orm::ActiveValue::Set(reason.to_string()),\n            description: sea_orm::ActiveValue::Set(description.map(|s| s.to_string())),\n            status: sea_orm::ActiveValue::Set(\"pending\".to_string()),\n            created_at: sea_orm::ActiveValue::Set(now),\n            ..Default::default()\n        };\n\n        let saved = model.insert(\u0026self.db).await?;\n        Ok(saved)\n    }\n\n    pub async fn list_reports(\n        \u0026self,\n        status: Option\u003c\u0026str\u003e,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cReportModel\u003e, u64)\u003e {\n        let mut query = Report::find();\n\n        if let Some(s) = status {\n            query = query.filter(report::Column::Status.eq(s));\n        }\n\n        let paginator = query\n            .order_by_desc(report::Column::CreatedAt)\n            .paginate(\u0026self.db, per_page);\n\n        let total = paginator.num_items().await?;\n        let reports = paginator.fetch_page(page.saturating_sub(1)).await?;\n        Ok((reports, total))\n    }\n\n    pub async fn resolve(\n        \u0026self,\n        report_id: i32,\n        admin_id: i32,\n        action: \u0026str,\n    ) -\u003e AppResult\u003cReportModel\u003e {\n        let valid_actions = [\"hide\", \"delete\", \"dismiss\"];\n        if !valid_actions.contains(\u0026action) {\n            return Err(AppError::Validation(format!(\n                \"action must be one of: {}\",\n                valid_actions.join(\", \")\n            )));\n        }\n\n        let existing = Report::find_by_id(report_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        if existing.status != \"pending\" {\n            return Err(AppError::Validation(\n                \"Report is already resolved\".to_string(),\n            ));\n        }\n\n        // Apply action on the target\n        match action {\n            \"hide\" =\u003e {\n                self.hide_target(\u0026existing.target_type, existing.target_id)\n                    .await?;\n            }\n            \"delete\" =\u003e {\n                self.delete_target(\u0026existing.target_type, existing.target_id)\n                    .await?;\n            }\n            \"dismiss\" =\u003e {}\n            _ =\u003e unreachable!(),\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n        let mut active: report::ActiveModel = existing.into();\n        active.status = sea_orm::ActiveValue::Set(if action == \"dismiss\" {\n            \"dismissed\".to_string()\n        } else {\n            \"resolved\".to_string()\n        });\n        active.resolved_by = sea_orm::ActiveValue::Set(Some(admin_id));\n        active.resolved_at = sea_orm::ActiveValue::Set(Some(now));\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    async fn hide_target(\u0026self, target_type: \u0026str, target_id: i32) -\u003e AppResult\u003c()\u003e {\n        match target_type {\n            \"post\" =\u003e {\n                let existing = Post::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::NotFound)?;\n                let mut active: post::ActiveModel = existing.into();\n                active.is_hidden = sea_orm::ActiveValue::Set(true);\n                active.update(\u0026self.db).await?;\n            }\n            \"comment\" =\u003e {\n                let existing = Comment::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::NotFound)?;\n                let mut active: comment::ActiveModel = existing.into();\n                active.is_hidden = sea_orm::ActiveValue::Set(true);\n                active.update(\u0026self.db).await?;\n            }\n            _ =\u003e {}\n        }\n        Ok(())\n    }\n\n    async fn delete_target(\u0026self, target_type: \u0026str, target_id: i32) -\u003e AppResult\u003c()\u003e {\n        match target_type {\n            \"post\" =\u003e {\n                Post::delete_by_id(target_id).exec(\u0026self.db).await?;\n            }\n            \"comment\" =\u003e {\n                Comment::delete_by_id(target_id).exec(\u0026self.db).await?;\n            }\n            _ =\u003e {}\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":99},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","tag.rs"],"content":"use crate::error::{AppError, AppResult};\nuse crate::models::{post_tag, tag, PostModel, Tag, TagModel};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, ConnectionTrait, DatabaseConnection, EntityTrait,\n    FromQueryResult, ModelTrait, QueryFilter, QueryOrder, Statement, Set,\n};\n\npub struct TagService {\n    db: DatabaseConnection,\n}\n\nimpl TagService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    /// Get or create tags by name. Returns all matching TagModels.\n    pub async fn get_or_create_tags(\u0026self, names: Vec\u003cString\u003e) -\u003e AppResult\u003cVec\u003cTagModel\u003e\u003e {\n        let mut result = Vec::new();\n\n        for name in names {\n            let name = name.trim().to_lowercase();\n            if name.is_empty() || name.len() \u003e 30 {\n                continue;\n            }\n\n            let slug = name\n                .chars()\n                .map(|c| if c.is_alphanumeric() { c } else { '-' })\n                .collect::\u003cString\u003e();\n\n            // Try to find existing tag\n            let existing = Tag::find()\n                .filter(tag::Column::Slug.eq(\u0026slug))\n                .one(\u0026self.db)\n                .await?;\n\n            if let Some(tag) = existing {\n                result.push(tag);\n            } else {\n                let now = chrono::Utc::now().naive_utc();\n                let new_tag = tag::ActiveModel {\n                    name: sea_orm::ActiveValue::Set(name),\n                    slug: sea_orm::ActiveValue::Set(slug),\n                    created_at: sea_orm::ActiveValue::Set(now),\n                    ..Default::default()\n                };\n                let tag = new_tag.insert(\u0026self.db).await?;\n                result.push(tag);\n            }\n        }\n\n        Ok(result)\n    }\n\n    /// Replace all tags for a post.\n    pub async fn set_post_tags(\u0026self, post_id: i32, tag_ids: Vec\u003ci32\u003e) -\u003e AppResult\u003c()\u003e {\n        // Delete existing tags\n        self.db\n            .execute(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \"DELETE FROM post_tags WHERE post_id = $1\",\n                vec![post_id.into()],\n            ))\n            .await?;\n\n        // Insert new tags\n        for tag_id in tag_ids {\n            let pt = post_tag::ActiveModel {\n                post_id: sea_orm::ActiveValue::Set(post_id),\n                tag_id: sea_orm::ActiveValue::Set(tag_id),\n                ..Default::default()\n            };\n            pt.insert(\u0026self.db).await?;\n        }\n\n        Ok(())\n    }\n\n    /// Get tags for a single post.\n    pub async fn get_post_tags(\u0026self, post_id: i32) -\u003e AppResult\u003cVec\u003cTagModel\u003e\u003e {\n        let tags = TagModel::find_by_statement(Statement::from_sql_and_values(\n            sea_orm::DatabaseBackend::Postgres,\n            \"SELECT t.id, t.name, t.slug, t.created_at \\\n                FROM tags t \\\n                INNER JOIN post_tags pt ON pt.tag_id = t.id \\\n                WHERE pt.post_id = $1 \\\n                ORDER BY t.name\",\n            vec![post_id.into()],\n        ))\n        .all(\u0026self.db)\n        .await?;\n\n        Ok(tags)\n    }\n\n    /// Get tags for multiple posts (batch).\n    pub async fn get_tags_for_posts(\n        \u0026self,\n        post_ids: \u0026[i32],\n    ) -\u003e AppResult\u003cstd::collections::HashMap\u003ci32, Vec\u003cString\u003e\u003e\u003e {\n        use std::collections::HashMap;\n\n        if post_ids.is_empty() {\n            return Ok(HashMap::new());\n        }\n\n        // Build $1, $2, ... placeholders\n        let placeholders: Vec\u003cString\u003e = post_ids\n            .iter()\n            .enumerate()\n            .map(|(i, _)| format!(\"${}\", i + 1))\n            .collect();\n        let sql = format!(\n            \"SELECT pt.post_id, t.name \\\n                FROM post_tags pt \\\n                INNER JOIN tags t ON t.id = pt.tag_id \\\n                WHERE pt.post_id IN ({}) \\\n                ORDER BY t.name\",\n            placeholders.join(\", \")\n        );\n\n        let values: Vec\u003csea_orm::Value\u003e = post_ids.iter().map(|\u0026id| id.into()).collect();\n\n        let rows = self\n            .db\n            .query_all(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \u0026sql,\n                values,\n            ))\n            .await?;\n\n        let mut map: HashMap\u003ci32, Vec\u003cString\u003e\u003e = HashMap::new();\n        for row in rows {\n            let pid: i32 = row.try_get_by_index(0)?;\n            let name: String = row.try_get_by_index(1)?;\n            map.entry(pid).or_default().push(name);\n        }\n\n        Ok(map)\n    }\n\n    /// List all tags.\n    pub async fn list_tags(\u0026self) -\u003e AppResult\u003cVec\u003cTagModel\u003e\u003e {\n        let tags = Tag::find()\n            .order_by_asc(tag::Column::Name)\n            .all(\u0026self.db)\n            .await?;\n        Ok(tags)\n    }\n\n    /// Get posts by tag slug with pagination.\n    pub async fn get_posts_by_tag(\n        \u0026self,\n        tag_slug: \u0026str,\n        page: u64,\n        per_page: u64,\n    ) -\u003e AppResult\u003c(Vec\u003cPostModel\u003e, u64)\u003e {\n        let offset = page.saturating_sub(1) * per_page;\n\n        // Look up tag\n        let tag = Tag::find()\n            .filter(tag::Column::Slug.eq(tag_slug))\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        // Count\n        let count_result = self\n            .db\n            .query_one(Statement::from_sql_and_values(\n                sea_orm::DatabaseBackend::Postgres,\n                \"SELECT COUNT(*) as count FROM posts p \\\n                    INNER JOIN post_tags pt ON pt.post_id = p.id \\\n                    WHERE pt.tag_id = $1 AND p.is_hidden = FALSE\",\n                vec![tag.id.into()],\n            ))\n            .await?\n            .ok_or(AppError::Internal(anyhow::anyhow!(\"Count query failed\")))?;\n\n        let total: i64 = count_result.try_get_by_index(0)?;\n\n        // Fetch\n        let posts = PostModel::find_by_statement(Statement::from_sql_and_values(\n            sea_orm::DatabaseBackend::Postgres,\n            \"SELECT p.id, p.user_id, p.forum_id, p.title, p.content, p.upvotes, p.downvotes, \\\n                p.view_count, p.is_pinned, p.is_locked, p.is_hidden, p.created_at, p.updated_at \\\n                FROM posts p \\\n                INNER JOIN post_tags pt ON pt.post_id = p.id \\\n                WHERE pt.tag_id = $1 AND p.is_hidden = FALSE \\\n                ORDER BY p.created_at DESC \\\n                LIMIT $2 OFFSET $3\",\n            vec![tag.id.into(), (per_page as i64).into(), (offset as i64).into()],\n        ))\n        .all(\u0026self.db)\n        .await?;\n\n        Ok((posts, total as u64))\n    }\n\n    pub async fn create_tag(\u0026self, name: \u0026str) -\u003e AppResult\u003cTagModel\u003e {\n        let name = name.trim().to_lowercase();\n        let slug = name.chars().map(|c| if c.is_alphanumeric() { c } else { '-' }).collect::\u003cString\u003e();\n\n        let existing = Tag::find().filter(tag::Column::Slug.eq(\u0026slug)).one(\u0026self.db).await?;\n        if existing.is_some() {\n            return Err(AppError::Conflict(\"Tag already exists\".to_string()));\n        }\n\n        let now = chrono::Utc::now().naive_utc();\n        let new_tag = tag::ActiveModel {\n            name: Set(name),\n            slug: Set(slug),\n            created_at: Set(now),\n            ..Default::default()\n        };\n        Ok(new_tag.insert(\u0026self.db).await?)\n    }\n\n    pub async fn update_tag(\u0026self, id: i32, name: \u0026str) -\u003e AppResult\u003cTagModel\u003e {\n        let tag = Tag::find_by_id(id).one(\u0026self.db).await?.ok_or(AppError::NotFound)?;\n        let name = name.trim().to_lowercase();\n        let slug = name.chars().map(|c| if c.is_alphanumeric() { c } else { '-' }).collect::\u003cString\u003e();\n\n        let mut active: tag::ActiveModel = tag.into();\n        active.name = Set(name);\n        active.slug = Set(slug);\n        Ok(active.update(\u0026self.db).await?)\n    }\n\n    pub async fn delete_tag(\u0026self, id: i32) -\u003e AppResult\u003c()\u003e {\n        let tag = Tag::find_by_id(id).one(\u0026self.db).await?.ok_or(AppError::NotFound)?;\n        tag.delete(\u0026self.db).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":127},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","upload.rs"],"content":"use crate::error::{AppError, AppResult};\nuse std::path::Path;\nuse tokio::fs;\nuse uuid::Uuid;\n\n#[derive(Clone)]\npub struct UploadConfig {\n    pub upload_dir: String,\n}\n\nconst MAX_FILE_SIZE: usize = 5 * 1024 * 1024; // 5 MB\nconst ALLOWED_CONTENT_TYPES: \u0026[\u0026str] = \u0026[\"image/jpeg\", \"image/png\", \"image/gif\", \"image/webp\"];\n\n/// Validate file magic bytes match the declared content type.\nfn validate_magic_bytes(data: \u0026[u8], content_type: \u0026str) -\u003e bool {\n    match content_type {\n        \"image/jpeg\" =\u003e data.len() \u003e= 3 \u0026\u0026 data[..3] == [0xFF, 0xD8, 0xFF],\n        \"image/png\" =\u003e data.len() \u003e= 4 \u0026\u0026 data[..4] == [0x89, 0x50, 0x4E, 0x47],\n        \"image/gif\" =\u003e data.len() \u003e= 4 \u0026\u0026 data[..4] == [0x47, 0x49, 0x46, 0x38],\n        \"image/webp\" =\u003e {\n            data.len() \u003e= 12\n                \u0026\u0026 data[..4] == [0x52, 0x49, 0x46, 0x46]\n                \u0026\u0026 data[8..12] == [0x57, 0x45, 0x42, 0x50]\n        }\n        _ =\u003e false,\n    }\n}\n\npub struct UploadService;\n\nimpl UploadService {\n    /// Save an uploaded file to disk.\n    /// Returns the public URL path (e.g., `/uploads/avatars/uuid.jpg`).\n    pub async fn save_file(\n        config: \u0026UploadConfig,\n        data: \u0026[u8],\n        content_type: \u0026str,\n        subdirectory: \u0026str,\n    ) -\u003e AppResult\u003cString\u003e {\n        // Validate size\n        if data.len() \u003e MAX_FILE_SIZE {\n            return Err(AppError::PayloadTooLarge);\n        }\n\n        // Validate content type\n        if !ALLOWED_CONTENT_TYPES.contains(\u0026content_type) {\n            return Err(AppError::Validation(format!(\n                \"Unsupported file type: {}. Allowed: jpeg, png, gif, webp\",\n                content_type\n            )));\n        }\n\n        // Validate magic bytes match content type\n        if !validate_magic_bytes(data, content_type) {\n            return Err(AppError::Validation(\n                \"File content does not match declared content type\".to_string(),\n            ));\n        }\n\n        let ext = match content_type {\n            \"image/jpeg\" =\u003e \"jpg\",\n            \"image/png\" =\u003e \"png\",\n            \"image/gif\" =\u003e \"gif\",\n            \"image/webp\" =\u003e \"webp\",\n            _ =\u003e return Err(AppError::Validation(\"Unsupported file type\".to_string())),\n        };\n\n        let filename = format!(\"{}.{}\", Uuid::new_v4(), ext);\n        let dir = Path::new(\u0026config.upload_dir).join(subdirectory);\n\n        fs::create_dir_all(\u0026dir)\n            .await\n            .map_err(|e| AppError::Validation(format!(\"Failed to create upload directory: {}\", e)))?;\n\n        let file_path = dir.join(\u0026filename);\n        fs::write(\u0026file_path, data)\n            .await\n            .map_err(|e| AppError::Validation(format!(\"Failed to write file: {}\", e)))?;\n\n        Ok(format!(\"/uploads/{}/{}\", subdirectory, filename))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn jpeg_magic_bytes_valid() {\n        let data = [0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10];\n        assert!(validate_magic_bytes(\u0026data, \"image/jpeg\"));\n    }\n\n    #[test]\n    fn png_magic_bytes_valid() {\n        let data = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A];\n        assert!(validate_magic_bytes(\u0026data, \"image/png\"));\n    }\n\n    #[test]\n    fn gif_magic_bytes_valid() {\n        let data = [0x47, 0x49, 0x46, 0x38, 0x39, 0x61];\n        assert!(validate_magic_bytes(\u0026data, \"image/gif\"));\n    }\n\n    #[test]\n    fn webp_magic_bytes_valid() {\n        let data = [\n            0x52, 0x49, 0x46, 0x46, // RIFF\n            0x00, 0x00, 0x00, 0x00, // size\n            0x57, 0x45, 0x42, 0x50, // WEBP\n        ];\n        assert!(validate_magic_bytes(\u0026data, \"image/webp\"));\n    }\n\n    #[test]\n    fn wrong_magic_bytes_rejected() {\n        let png_data = [0x89, 0x50, 0x4E, 0x47];\n        assert!(!validate_magic_bytes(\u0026png_data, \"image/jpeg\"));\n    }\n\n    #[test]\n    fn empty_data_rejected() {\n        assert!(!validate_magic_bytes(\u0026[], \"image/jpeg\"));\n        assert!(!validate_magic_bytes(\u0026[], \"image/png\"));\n    }\n\n    #[test]\n    fn unknown_content_type_rejected() {\n        let data = [0xFF, 0xD8, 0xFF];\n        assert!(!validate_magic_bytes(\u0026data, \"application/pdf\"));\n    }\n\n    #[test]\n    fn too_short_data_rejected() {\n        assert!(!validate_magic_bytes(\u0026[0xFF, 0xD8], \"image/jpeg\"));\n        assert!(!validate_magic_bytes(\u0026[0x89, 0x50, 0x4E], \"image/png\"));\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":16,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":17,"address":[],"length":0,"stats":{"Line":1152921504606846976}},{"line":18,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":19,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":20,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":21,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":22,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":23,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":25,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}}],"covered":10,"coverable":36},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","user.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{user, User, UserModel},\n};\nuse sea_orm::{ActiveModelTrait, ColumnTrait, DatabaseConnection, EntityTrait, QueryFilter};\n\npub struct UserService {\n    db: DatabaseConnection,\n}\n\nimpl UserService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn get_by_username(\u0026self, username: \u0026str) -\u003e AppResult\u003cUserModel\u003e {\n        User::find()\n            .filter(user::Column::Username.eq(username))\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)\n    }\n\n    pub async fn update_profile(\n        \u0026self,\n        user_id: i32,\n        bio: Option\u003cString\u003e,\n        avatar_url: Option\u003cString\u003e,\n    ) -\u003e AppResult\u003cUserModel\u003e {\n        let existing = User::find_by_id(user_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: user::ActiveModel = existing.into();\n        active.bio = sea_orm::ActiveValue::Set(bio);\n        active.avatar_url = sea_orm::ActiveValue::Set(avatar_url);\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n\n    /// Update only the avatar URL (used by upload handler).\n    pub async fn update_avatar_url(\u0026self, user_id: i32, url: \u0026str) -\u003e AppResult\u003cUserModel\u003e {\n        let existing = User::find_by_id(user_id)\n            .one(\u0026self.db)\n            .await?\n            .ok_or(AppError::NotFound)?;\n\n        let now = chrono::Utc::now().naive_utc();\n\n        let mut active: user::ActiveModel = existing.into();\n        active.avatar_url = sea_orm::ActiveValue::Set(Some(url.to_string()));\n        active.updated_at = sea_orm::ActiveValue::Set(now);\n\n        let updated = active.update(\u0026self.db).await?;\n        Ok(updated)\n    }\n}\n","traces":[{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":30},{"path":["C:","\\","Users","yimo","Codes","xjy","src","services","vote.rs"],"content":"use crate::{\n    error::{AppError, AppResult},\n    models::{vote, Comment, Post, Vote, VoteModel},\n};\nuse sea_orm::{\n    ActiveModelTrait, ColumnTrait, ConnectionTrait, DatabaseConnection, EntityTrait, QueryFilter,\n    Statement,\n};\n\npub struct VoteService {\n    db: DatabaseConnection,\n}\n\nimpl VoteService {\n    pub fn new(db: DatabaseConnection) -\u003e Self {\n        Self { db }\n    }\n\n    pub async fn vote(\n        \u0026self,\n        user_id: i32,\n        target_type: \u0026str,\n        target_id: i32,\n        value: i16,\n    ) -\u003e AppResult\u003cVoteModel\u003e {\n        if value != 1 \u0026\u0026 value != -1 {\n            return Err(AppError::Validation(\n                \"Vote value must be 1 or -1\".to_string(),\n            ));\n        }\n\n        // Verify target exists\n        match target_type {\n            \"post\" =\u003e {\n                Post::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::NotFound)?;\n            }\n            \"comment\" =\u003e {\n                Comment::find_by_id(target_id)\n                    .one(\u0026self.db)\n                    .await?\n                    .ok_or(AppError::NotFound)?;\n            }\n            _ =\u003e return Err(AppError::Validation(\"Invalid target type\".to_string())),\n        }\n\n        // Check for existing vote\n        let existing = Vote::find()\n            .filter(vote::Column::UserId.eq(user_id))\n            .filter(vote::Column::TargetType.eq(target_type))\n            .filter(vote::Column::TargetId.eq(target_id))\n            .one(\u0026self.db)\n            .await?;\n\n        let old_value: i16 = existing.as_ref().map_or(0, |v| v.value);\n\n        let result = if let Some(existing_vote) = existing {\n            if existing_vote.value == value {\n                // Same vote again  remove it (toggle off)\n                Vote::delete_by_id(existing_vote.id).exec(\u0026self.db).await?;\n                self.update_counters(target_type, target_id, -old_value)\n                    .await?;\n                // Return a synthetic model indicating removal\n                return Ok(VoteModel {\n                    id: 0,\n                    user_id,\n                    target_type: target_type.to_string(),\n                    target_id,\n                    value: 0,\n                    created_at: chrono::Utc::now().naive_utc(),\n                });\n            }\n            // Different vote  update\n            let mut active: vote::ActiveModel = existing_vote.into();\n            active.value = sea_orm::ActiveValue::Set(value);\n            let updated = active.update(\u0026self.db).await?;\n            // Swing counters: remove old, add new\n            self.update_counters(target_type, target_id, value - old_value)\n                .await?;\n            updated\n        } else {\n            // New vote\n            let now = chrono::Utc::now().naive_utc();\n            let new_vote = vote::ActiveModel {\n                user_id: sea_orm::ActiveValue::Set(user_id),\n                target_type: sea_orm::ActiveValue::Set(target_type.to_string()),\n                target_id: sea_orm::ActiveValue::Set(target_id),\n                value: sea_orm::ActiveValue::Set(value),\n                created_at: sea_orm::ActiveValue::Set(now),\n                ..Default::default()\n            };\n            let inserted = new_vote.insert(\u0026self.db).await?;\n            self.update_counters(target_type, target_id, value).await?;\n            inserted\n        };\n\n        Ok(result)\n    }\n\n    async fn update_counters(\n        \u0026self,\n        target_type: \u0026str,\n        target_id: i32,\n        delta: i16,\n    ) -\u003e AppResult\u003c()\u003e {\n        let table = match target_type {\n            \"post\" =\u003e \"posts\",\n            \"comment\" =\u003e \"comments\",\n            _ =\u003e return Ok(()),\n        };\n\n        let (col_up, col_down) = if delta \u003e 0 {\n            (\"upvotes\", format!(\"upvotes + {delta}\"))\n        } else {\n            (\"downvotes\", format!(\"downvotes + {}\", -delta))\n        };\n\n        // For vote swing (e.g. -1 to +1, delta=2), handle both columns\n        if delta.abs() \u003e 1 {\n            // Swing: delta=2 means +1 upvote, -1 downvote; delta=-2 means reverse\n            let sql = if delta \u003e 0 {\n                format!(\n                    \"UPDATE {table} SET upvotes = upvotes + 1, downvotes = GREATEST(downvotes - 1, 0) WHERE id = $1\"\n                )\n            } else {\n                format!(\n                    \"UPDATE {table} SET downvotes = downvotes + 1, upvotes = GREATEST(upvotes - 1, 0) WHERE id = $1\"\n                )\n            };\n            self.db\n                .execute(Statement::from_sql_and_values(\n                    sea_orm::DatabaseBackend::Postgres,\n                    \u0026sql,\n                    [target_id.into()],\n                ))\n                .await?;\n        } else {\n            let sql = format!(\"UPDATE {table} SET {col_up} = {col_down} WHERE id = $1\");\n            self.db\n                .execute(Statement::from_sql_and_values(\n                    sea_orm::DatabaseBackend::Postgres,\n                    \u0026sql,\n                    [target_id.into()],\n                ))\n                .await?;\n        }\n\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn validate_vote_value_accepts_one() {\n        let value: i16 = 1;\n        assert!(value == 1 || value == -1);\n    }\n\n    #[test]\n    fn validate_vote_value_accepts_negative_one() {\n        let value: i16 = -1;\n        assert!(value == 1 || value == -1);\n    }\n\n    #[test]\n    fn validate_vote_value_rejects_zero() {\n        let value: i16 = 0;\n        assert!(!(value == 1 || value == -1));\n    }\n\n    #[test]\n    fn validate_vote_value_rejects_two() {\n        let value: i16 = 2;\n        assert!(!(value == 1 || value == -1));\n    }\n\n    #[test]\n    fn toggle_same_vote_returns_zero() {\n        let old_value: i16 = 1;\n        let new_value: i16 = 1;\n        let result = if old_value == new_value { 0 } else { new_value };\n        assert_eq!(result, 0);\n    }\n\n    #[test]\n    fn swing_vote_calculates_delta() {\n        let old_value: i16 = -1;\n        let new_value: i16 = 1;\n        let delta = new_value - old_value;\n        assert_eq!(delta, 2);\n    }\n\n    #[test]\n    fn new_vote_delta_is_value() {\n        let old_value: i16 = 0;\n        let new_value: i16 = 1;\n        let delta = new_value - old_value;\n        assert_eq!(delta, 1);\n    }\n\n    #[test]\n    fn remove_vote_delta_is_negative() {\n        let old_value: i16 = 1;\n        let new_value: i16 = 0;\n        let delta = new_value - old_value;\n        assert_eq!(delta, -1);\n    }\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":78},{"path":["C:","\\","Users","yimo","Codes","xjy","src","utils","jwt.rs"],"content":"use anyhow::Result;\nuse jsonwebtoken::{decode, encode, DecodingKey, EncodingKey, Header, Validation};\nuse serde::{Deserialize, Serialize};\nuse std::sync::OnceLock;\n\nstatic JWT_CONFIG: OnceLock\u003ccrate::config::jwt::JwtConfig\u003e = OnceLock::new();\n\n/// Initialize JWT config from environment. Must be called once at startup.\npub fn init_jwt_config(config: crate::config::jwt::JwtConfig) -\u003e Result\u003c()\u003e {\n    JWT_CONFIG\n        .set(config)\n        .map_err(|_| anyhow::anyhow!(\"JWT config already initialized\"))?;\n    Ok(())\n}\n\nfn get_config() -\u003e \u0026'static crate::config::jwt::JwtConfig {\n    JWT_CONFIG\n        .get()\n        .expect(\"JWT config not initialized  call init_jwt_config() at startup\")\n}\n\n#[derive(Debug, Serialize, Deserialize)]\npub struct Claims {\n    pub sub: String, // user_id\n    pub exp: usize,  // expiration time\n    pub iat: usize,  // issued at\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub token_type: Option\u003cString\u003e, // \"access\" or \"refresh\"\n}\n\npub fn encode_access_token(user_id: \u0026str) -\u003e Result\u003cString\u003e {\n    let config = get_config();\n    let now = chrono::Utc::now().timestamp() as usize;\n    let claims = Claims {\n        sub: user_id.to_owned(),\n        exp: now + config.access_token_expiry as usize,\n        iat: now,\n        token_type: Some(\"access\".to_string()),\n    };\n\n    encode(\n        \u0026Header::default(),\n        \u0026claims,\n        \u0026EncodingKey::from_secret(config.secret.as_bytes()),\n    )\n    .map_err(|e| anyhow::anyhow!(\"Failed to encode access token: {}\", e))\n}\n\npub fn encode_refresh_token(user_id: \u0026str) -\u003e Result\u003cString\u003e {\n    let config = get_config();\n    let now = chrono::Utc::now().timestamp() as usize;\n    let claims = Claims {\n        sub: user_id.to_owned(),\n        exp: now + config.refresh_token_expiry as usize,\n        iat: now,\n        token_type: Some(\"refresh\".to_string()),\n    };\n\n    encode(\n        \u0026Header::default(),\n        \u0026claims,\n        \u0026EncodingKey::from_secret(config.secret.as_bytes()),\n    )\n    .map_err(|e| anyhow::anyhow!(\"Failed to encode refresh token: {}\", e))\n}\n\npub fn decode_jwt(token: \u0026str) -\u003e Result\u003cClaims\u003e {\n    let config = get_config();\n\n    decode::\u003cClaims\u003e(\n        token,\n        \u0026DecodingKey::from_secret(config.secret.as_bytes()),\n        \u0026Validation::default(),\n    )\n    .map(|data| data.claims)\n    .map_err(|e| anyhow::anyhow!(\"Failed to decode JWT: {}\", e))\n}\n\n#[allow(dead_code)]\npub fn is_refresh_token(claims: \u0026Claims) -\u003e bool {\n    matches!(claims.token_type.as_deref(), Some(\"refresh\"))\n}\n\n#[allow(dead_code)]\npub fn is_access_token(claims: \u0026Claims) -\u003e bool {\n    matches!(claims.token_type.as_deref(), Some(\"access\"))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::Once;\n\n    static INIT: Once = Once::new();\n\n    fn ensure_config() {\n        INIT.call_once(|| {\n            std::env::set_var(\"JWT_SECRET\", \"a_very_long_secret_key_that_is_at_least_32_chars\");\n            let config = crate::config::jwt::JwtConfig::from_env().unwrap();\n            let _ = init_jwt_config(config);\n        });\n    }\n\n    #[test]\n    fn encode_decode_round_trip() {\n        ensure_config();\n        let token = encode_access_token(\"42\").unwrap();\n        let claims = decode_jwt(\u0026token).unwrap();\n        assert_eq!(claims.sub, \"42\");\n        assert!(claims.exp \u003e claims.iat);\n        assert_eq!(claims.token_type, Some(\"access\".to_string()));\n    }\n\n    #[test]\n    fn refresh_token_encode_decode() {\n        ensure_config();\n        let token = encode_refresh_token(\"42\").unwrap();\n        let claims = decode_jwt(\u0026token).unwrap();\n        assert_eq!(claims.sub, \"42\");\n        assert!(claims.exp \u003e claims.iat);\n        assert_eq!(claims.token_type, Some(\"refresh\".to_string()));\n    }\n\n    #[test]\n    fn tampered_token_fails() {\n        ensure_config();\n        let token = encode_access_token(\"42\").unwrap();\n        // Flip a character in the middle of the token\n        let mut chars: Vec\u003cchar\u003e = token.chars().collect();\n        let mid = chars.len() / 2;\n        chars[mid] = if chars[mid] == 'A' { 'B' } else { 'A' };\n        let tampered: String = chars.into_iter().collect();\n        assert!(decode_jwt(\u0026tampered).is_err());\n    }\n\n    #[test]\n    fn expired_token_fails() {\n        ensure_config();\n        let config = get_config();\n        let now = chrono::Utc::now().timestamp() as usize;\n        let claims = Claims {\n            sub: \"42\".to_string(),\n            exp: now - 3600, // expired 1 hour ago\n            iat: now - 7200,\n            token_type: Some(\"access\".to_string()),\n        };\n        let token = encode(\n            \u0026Header::default(),\n            \u0026claims,\n            \u0026EncodingKey::from_secret(config.secret.as_bytes()),\n        )\n        .unwrap();\n        assert!(decode_jwt(\u0026token).is_err());\n    }\n\n    #[test]\n    fn empty_token_fails() {\n        ensure_config();\n        assert!(decode_jwt(\"\").is_err());\n    }\n}\n","traces":[{"line":9,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":10,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":11,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":12,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":13,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":16,"address":[],"length":0,"stats":{"Line":648518346341351424}},{"line":17,"address":[],"length":0,"stats":{"Line":1297036692682702848}},{"line":31,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":32,"address":[],"length":0,"stats":{"Line":288230376151711744}},{"line":33,"address":[],"length":0,"stats":{"Line":288230376151711744}},{"line":35,"address":[],"length":0,"stats":{"Line":432345564227567616}},{"line":36,"address":[],"length":0,"stats":{"Line":288230376151711744}},{"line":38,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":42,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":43,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":44,"address":[],"length":0,"stats":{"Line":288230376151711744}},{"line":46,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":49,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":50,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":51,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":53,"address":[],"length":0,"stats":{"Line":216172782113783808}},{"line":54,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":56,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":60,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":61,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":62,"address":[],"length":0,"stats":{"Line":144115188075855872}},{"line":64,"address":[],"length":0,"stats":{"Line":72057594037927936}},{"line":67,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":68,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":71,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":72,"address":[],"length":0,"stats":{"Line":720575940379279360}},{"line":73,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":75,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":76,"address":[],"length":0,"stats":{"Line":576460752303423488}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}}],"covered":34,"coverable":38},{"path":["C:","\\","Users","yimo","Codes","xjy","src","utils","mod.rs"],"content":"pub mod jwt;\npub mod password;\n\npub use jwt::{encode_access_token, encode_refresh_token};\npub use password::{hash_password, verify_password};\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","utils","password.rs"],"content":"use anyhow::{Context, Result};\n\n/// Hash a password using bcrypt\npub fn hash_password(password: \u0026str) -\u003e Result\u003cString\u003e {\n    bcrypt::hash(password, bcrypt::DEFAULT_COST).context(\"Failed to hash password\")\n}\n\n/// Verify a password against a hash\npub fn verify_password(password: \u0026str, hash: \u0026str) -\u003e Result\u003cbool\u003e {\n    bcrypt::verify(password, hash).context(\"Failed to verify password\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn hash_and_verify_round_trip() {\n        let password = \"test_password_123\";\n        let hash = hash_password(password).unwrap();\n        assert!(verify_password(password, \u0026hash).unwrap());\n    }\n\n    #[test]\n    fn wrong_password_fails() {\n        let hash = hash_password(\"correct_password\").unwrap();\n        assert!(!verify_password(\"wrong_password\", \u0026hash).unwrap());\n    }\n\n    #[test]\n    fn empty_password_hashes() {\n        let hash = hash_password(\"\").unwrap();\n        assert!(verify_password(\"\", \u0026hash).unwrap());\n        assert!(!verify_password(\"notempty\", \u0026hash).unwrap());\n    }\n\n    #[test]\n    fn different_hashes_for_same_password() {\n        let hash1 = hash_password(\"same_password\").unwrap();\n        let hash2 = hash_password(\"same_password\").unwrap();\n        // bcrypt uses random salt, so hashes should differ\n        assert_ne!(hash1, hash2);\n        // But both should verify\n        assert!(verify_password(\"same_password\", \u0026hash1).unwrap());\n        assert!(verify_password(\"same_password\", \u0026hash2).unwrap());\n    }\n}\n","traces":[{"line":4,"address":[],"length":0,"stats":{"Line":360287970189639680}},{"line":5,"address":[],"length":0,"stats":{"Line":1080863910568919040}},{"line":9,"address":[],"length":0,"stats":{"Line":432345564227567616}},{"line":10,"address":[],"length":0,"stats":{"Line":1729382256910270464}}],"covered":4,"coverable":4},{"path":["C:","\\","Users","yimo","Codes","xjy","src","websocket","hub.rs"],"content":"use dashmap::DashMap;\nuse std::sync::Arc;\nuse tokio::sync::mpsc;\n\npub type WsSender = mpsc::UnboundedSender\u003cString\u003e;\n\n#[derive(Clone)]\npub struct NotificationHub {\n    connections: Arc\u003cDashMap\u003ci32, Vec\u003cWsSender\u003e\u003e\u003e,\n}\n\nimpl Default for NotificationHub {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl NotificationHub {\n    pub fn new() -\u003e Self {\n        Self {\n            connections: Arc::new(DashMap::new()),\n        }\n    }\n\n    pub fn subscribe(\u0026self, user_id: i32) -\u003e mpsc::UnboundedReceiver\u003cString\u003e {\n        let (tx, rx) = mpsc::unbounded_channel();\n        self.connections.entry(user_id).or_default().push(tx);\n        rx\n    }\n\n    pub fn send_to_user(\u0026self, user_id: i32, message: \u0026str) {\n        if let Some(mut senders) = self.connections.get_mut(\u0026user_id) {\n            // Remove closed channels while sending\n            senders.retain(|sender| sender.send(message.to_string()).is_ok());\n            if senders.is_empty() {\n                drop(senders);\n                self.connections.remove(\u0026user_id);\n            }\n        }\n    }\n}\n","traces":[{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":14},{"path":["C:","\\","Users","yimo","Codes","xjy","src","websocket","mod.rs"],"content":"pub mod hub;\npub mod notification;\n","traces":[],"covered":0,"coverable":0},{"path":["C:","\\","Users","yimo","Codes","xjy","src","websocket","notification.rs"],"content":"use crate::error::AppError;\nuse crate::utils::jwt::decode_jwt;\nuse crate::websocket::hub::NotificationHub;\nuse axum::{\n    extract::{\n        ws::{Message, WebSocket},\n        Query, WebSocketUpgrade,\n    },\n    response::IntoResponse,\n    Extension,\n};\nuse futures_util::{SinkExt, StreamExt};\nuse serde::Deserialize;\n\n#[derive(Deserialize)]\npub struct WsQuery {\n    pub token: String,\n}\n\npub async fn ws_handler(\n    ws: WebSocketUpgrade,\n    Query(query): Query\u003cWsQuery\u003e,\n    Extension(hub): Extension\u003cNotificationHub\u003e,\n) -\u003e Result\u003cimpl IntoResponse, AppError\u003e {\n    let claims = decode_jwt(\u0026query.token).map_err(|_| AppError::Unauthorized)?;\n    let user_id: i32 = claims.sub.parse().map_err(|_| AppError::Unauthorized)?;\n\n    Ok(ws.on_upgrade(move |socket| handle_socket(socket, user_id, hub)))\n}\n\nasync fn handle_socket(socket: WebSocket, user_id: i32, hub: NotificationHub) {\n    let (mut ws_sender, mut ws_receiver) = socket.split();\n    let mut rx = hub.subscribe(user_id);\n\n    tracing::info!(\"WebSocket connected for user {}\", user_id);\n\n    let send_task = tokio::spawn(async move {\n        while let Some(msg) = rx.recv().await {\n            if ws_sender.send(Message::Text(msg.into())).await.is_err() {\n                break;\n            }\n        }\n    });\n\n    let recv_task = tokio::spawn(async move {\n        while let Some(Ok(msg)) = ws_receiver.next().await {\n            if let Message::Close(_) = msg {\n                break;\n            }\n        }\n    });\n\n    tokio::select! {\n        _ = send_task =\u003e {},\n        _ = recv_task =\u003e {},\n    }\n\n    tracing::info!(\"WebSocket disconnected for user {}\", user_id);\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":20}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, ''),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      const nbHit = covered? trace.stats.Line: 0;
      return e(
        'div',
        { className: 'code-text-container' },
        e(
          'code',
          {
            className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          },
          line
        ),
        e(
          'div',
          { className: 'cover-indicator' + (covered? ' check-cover': '') + (uncovered? ' no-cover': '')},
          e(
            'div',
            { className: (covered? 'stat-line-hit': '')},
            covered? nbHit: ""
          )
        )
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = '';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = '';
    }
  });
})();
</script>
</body>
</html>